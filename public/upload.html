<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Envio de documentos ‚Äì Cr√©dito Habita√ß√£o</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f8fafc;
      --surface: #ffffff;
      --surface-elevated: #f1f5f9;
      --text: #0f172a;
      --text-muted: #64748b;
      --accent: #0d9488;
      --accent-hover: #0f766e;
      --success: #059669;
      --error: #dc2626;
      --border: #e2e8f0;
      --radius: 12px;
      --radius-sm: 8px;
      --shadow: 0 1px 3px rgba(0,0,0,.08);
      --shadow-md: 0 4px 12px rgba(0,0,0,.06);
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'DM Sans', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 1.5rem 1rem 3rem;
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
    }
    .container { max-width: 560px; margin: 0 auto; padding: 0 0.25rem; }
    .page-header {
      margin-bottom: 2rem;
      text-align: center;
    }
    .page-header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text);
      margin: 0 0 0.5rem 0;
      letter-spacing: -0.02em;
    }
    .page-header p {
      color: var(--text-muted);
      font-size: 0.9375rem;
      margin: 0;
      text-align: left;
    }
    #pageIntro { margin-top: 0.75rem; line-height: 1.65; }
    .doc-privacy { margin-bottom: 1rem; padding: 0.5rem 0; }
    .doc-step { font-size: 0.8125rem; color: var(--text-muted); margin: 0.25rem 0 0.5rem 0; line-height: 1.5; }
    .doc-step ol { margin: 0.25rem 0 0 1rem; padding: 0; }
    .doc-link-inline { color: var(--accent); text-decoration: none; }
    .doc-link-inline:hover { text-decoration: underline; }
    .recibos-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.75rem;
      margin-top: 0.5rem;
    }
    .recibos-row .doc-block { margin-bottom: 0; min-width: 0; overflow: hidden; }
    .recibos-row .doc-upload-zone { min-width: 0; }
    .recibos-row .doc-upload-zone input[type="file"] { min-width: 0; flex: 1 1 100%; }
    @media (min-width: 520px) {
      .recibos-row { grid-template-columns: repeat(3, 1fr); }
    }
    .card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin-bottom: 1.25rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }
    .card h2 {
      font-size: 1rem;
      font-weight: 600;
      margin: 0 0 1.25rem 0;
      color: var(--text);
    }
    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 0.375rem;
    }
    input[type="text"],
    input[type="email"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 0.625rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font: inherit;
      font-size: 0.9375rem;
      margin-bottom: 1rem;
      background: var(--surface);
      transition: border-color .15s, box-shadow .15s;
    }
    select { cursor: pointer; }
    input[readonly] { background: var(--surface-elevated); cursor: default; }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(13, 148, 136, .12);
    }
    .doc-block {
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: var(--surface-elevated);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
    }
    .doc-block:last-child { margin-bottom: 0; }
    .doc-title { font-weight: 600; font-size: 0.9375rem; margin-bottom: 0.25rem; }
    .doc-hint { font-size: 0.8125rem; color: var(--text-muted); margin-bottom: 0.5rem; }
    .doc-upload-zone {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .doc-upload-zone input[type="file"] {
      flex: 1 1 200px;
      min-width: 0;
      margin: 0;
      font-size: 0.8125rem;
      padding: 0.5rem;
    }
    .doc-status {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.875rem;
      color: var(--success);
      font-weight: 500;
    }
    .doc-status::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 0.875rem;
      font: inherit;
      font-size: 0.875rem;
      font-weight: 500;
      border-radius: var(--radius-sm);
      cursor: pointer;
      border: none;
      transition: background .15s, transform .05s;
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary {
      background: var(--accent);
      color: #fff;
      width: 100%;
      padding: 0.75rem 1.25rem;
      font-size: 1rem;
      margin-top: 0.5rem;
    }
    .btn-primary:hover:not(:disabled) { background: var(--accent-hover); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-primary.sending { cursor: wait; }
    .btn-primary.sending .btn-text { opacity: 0.85; animation: pulse 1s ease-in-out infinite; }
    .btn-primary.sent { background: var(--success); pointer-events: none; animation: sentPop 0.4s ease; }
    @keyframes pulse { 0%, 100% { opacity: 0.85; } 50% { opacity: 1; } }
    @keyframes sentPop { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
    .btn-outline {
      background: transparent;
      color: var(--accent);
      border: 1px solid var(--accent);
    }
    .btn-outline:hover { background: rgba(13, 148, 136, .08); }
    .doc-actions { display: inline-flex; align-items: center; gap: 0.25rem; margin-left: 0.5rem; }
    .btn-icon {
      width: 32px;
      height: 32px;
      padding: 0;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-muted);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: color .15s, background .15s, border-color .15s;
    }
    .btn-icon:hover { color: var(--accent); border-color: var(--accent); background: rgba(13, 148, 136, .06); }
    .btn-icon svg { width: 16px; height: 16px; display: block; }
    .btn-icon[data-action="remove"]:hover { color: var(--error); border-color: var(--error); background: rgba(220, 38, 38, .06); }
    .footnote {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
      padding-left: 0.75rem;
      border-left: 3px solid var(--border);
    }
    .footnote a { color: var(--accent); text-decoration: none; }
    .footnote a:hover { text-decoration: underline; }
    .conditional { display: none; }
    .conditional.visible { display: block; }
    .card-title-row { display: flex; flex-wrap: wrap; align-items: center; gap: 0.75rem 1rem; margin-bottom: 1.25rem; }
    .card-title-row h2 { margin: 0; }
    .card-title-row .consent-checkbox { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.875rem; font-weight: 500; color: var(--text); }
    .card-title-row .consent-checkbox input { width: auto; margin: 0; }
    .checkbox-wrap { margin: 1rem 0; }
    .checkbox-wrap label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
    .checkbox-wrap input { width: auto; margin: 0; }
    .error-msg { color: var(--error); font-size: 0.875rem; margin-top: 0.75rem; }
    .progress-text { font-size: 0.875rem; color: var(--text-muted); margin-bottom: 1rem; }
    .progress-bar {
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 1.5rem;
    }
    .progress-bar-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      transition: width .3s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="page-header">
      <h1>Envio de documentos</h1>
      <p id="pageIntro">üè°‚ú® Est√°s a um passo de iniciar a tua jornada para sair do arrendamento e conquistar a casa pr√≥pria! üîë<br><br>
      ‚úÖ Esta plataforma foi criada para te ajudar a organizar, de forma simples e pr√°tica, todos os documentos necess√°rios. Assim que tiveres tudo pronto, podes submeter o formul√°rio e enviar os teus documentos por e-mail diretamente para um dos nossos parceiros habilitados em gest√£o de cr√©dito.<br><br>
      ‚úÖ O teu caso ser√° analisado e ser√° definida a melhor estrat√©gia para ti. A gestora de cr√©dito entrar√° em contacto contigo via Email ou WhatsApp para explicar quais ser√£o os pr√≥ximos passos.<br><br>
      Sabemos que s√£o muitos documentos, mas n√£o desistas üí™ Assim que tiveres tudo em m√£os, todo o resto do processo ser√° muito mais simples e fluido.<br><br>
      Boa sorte! ‚ú®<br><br>
      Rafa pelo mundo</p>
    </header>

    <div id="stepGate">
      <div id="stepNomeEmail" class="card" style="display:none;">
        <label for="gate_nome">O seu nome completo *</label>
        <input type="text" id="gate_nome" placeholder="Ex.: Maria Silva" autocomplete="name">
        <label for="gate_email">O seu email *</label>
        <input type="email" id="gate_email" placeholder="email@exemplo.pt" autocomplete="email">
        <label class="consent-checkbox">
          <input type="checkbox" id="consent_rafa_gate" name="consent_rafa_gate" required>
          Aceito partilhar o meu nome e email com a Rafa
        </label>
        <div id="gateError1" class="error-msg" style="display:none;"></div>
        <button type="button" class="btn btn-primary" id="btnAvan√ßar">Avan√ßar</button>
      </div>
      <div id="stepCode" class="card" style="display:none;">
        <h2>C√≥digo de confirma√ß√£o</h2>
        <p class="doc-hint">Enviamos um c√≥digo de 6 algarismos para o seu email. Introduza-o abaixo.</p>
        <label for="gate_code">C√≥digo *</label>
        <input type="text" id="gate_code" placeholder="000000" maxlength="6" pattern="[0-9]*" inputmode="numeric" autocomplete="one-time-code">
        <div id="gateError2" class="error-msg" style="display:none;"></div>
        <button type="button" class="btn btn-primary" id="btnConfirmar">Confirmar</button>
      </div>
      <div id="stepEnterEmail" class="card" style="display:none;">
        <h2>Continuar</h2>
        <p class="doc-hint">Introduza o email que utilizou para aceder a esta p√°gina.</p>
        <label for="gate_email_return">Email *</label>
        <input type="email" id="gate_email_return" placeholder="email@exemplo.pt" autocomplete="email">
        <div id="gateError3" class="error-msg" style="display:none;"></div>
        <button type="button" class="btn btn-primary" id="btnContinuar">Continuar</button>
      </div>
      <div id="stepDocsEnviados" class="card" style="display:none;">
        <h2>Documentos recebidos</h2>
        <p class="doc-hint">Os seus documentos foram enviados com sucesso. A gestora ir√° analis√°-los e contact√°-lo(a) por email.</p>
        <p class="doc-hint" id="gestoraNomeWrap" style="display:none;">A sua gestora de cr√©dito: <strong id="gestoraNomeRef"></strong></p>
        <p class="doc-hint" id="gestoraEmailWrap" style="display:none;">Email de contacto da gestora: <a href="#" id="gestoraEmailRef" class="doc-link-inline"></a></p>
        <p class="doc-hint" id="gestoraWhatsappWrap" style="display:none;">Contactar a gestora por <a href="#" id="gestoraWhatsappRef" class="doc-link-inline" target="_blank" rel="noopener">WhatsApp</a></p>
      </div>
    </div>

    <div id="mainForm" style="display:none;">
    <div id="progressWrap" class="card" style="display:none;">
      <p class="progress-text" id="progressText">0 de 10 documentos anexados</p>
      <div class="progress-bar"><div class="progress-bar-fill" id="progressFill" style="width:0%"></div></div>
    </div>

    <form id="form">
      <input type="hidden" id="nome" name="nome">
      <input type="hidden" id="email" name="email">
      <input type="checkbox" id="consent_rafa" name="consent_rafa" value="1" style="position:absolute;opacity:0;pointer-events:none;" aria-hidden="true" tabindex="-1">

      <div class="card">
        <div class="card-title-row">
          <h2>Documentos obrigat√≥rios</h2>
          <label class="consent-checkbox">
            <input type="checkbox" id="consent_intermediaria" name="consent_intermediaria" required>
            Aceito compartilhar esses docs com a intermedi√°ria de cr√©dito
          </label>
        </div>
        <p class="doc-hint doc-privacy">Os documentos ficam guardados apenas no seu dispositivo at√© fazer o envio para a gestora.</p>
        <p class="doc-hint doc-privacy" style="margin-top:0.75rem;">Dados para a gestora e para o seu processo:</p>
        <label for="estado_civil">Estado civil e regime de casamento</label>
        <select id="estado_civil" name="estado_civil">
          <option value="">Selecione...</option>
          <option value="Solteiro(a)">Solteiro(a)</option>
          <option value="Casado(a) ‚Äì comunh√£o de bens">Casado(a) ‚Äì comunh√£o de bens</option>
          <option value="Casado(a) ‚Äì separa√ß√£o de bens">Casado(a) ‚Äì separa√ß√£o de bens</option>
          <option value="Uni√£o de facto">Uni√£o de facto</option>
          <option value="Divorciado(a)">Divorciado(a)</option>
          <option value="Vi√∫vo(a)">Vi√∫vo(a)</option>
          <option value="Outro">Outro</option>
        </select>
        <label for="num_dependentes">N.¬∫ de dependentes</label>
        <input type="number" id="num_dependentes" name="num_dependentes" min="0" placeholder="0">
        <label for="anos_emprego_atual">A quantos anos trabalha no emprego atual?</label>
        <input type="text" id="anos_emprego_atual" name="anos_emprego_atual" placeholder="Ex.: 2 ou Menos de 1">
        <label for="vinculo_laboral">Qual o seu v√≠nculo laboral?</label>
        <select id="vinculo_laboral" name="vinculo_laboral">
          <option value="">Selecione...</option>
          <option value="Contrato Efetivo">Contrato Efetivo</option>
          <option value="Contrato tempor√°rio">Contrato tempor√°rio</option>
          <option value="Recibos verdes">Recibos verdes</option>
        </select>
        <div id="fiadorWrap" class="conditional" style="display:none;">
          <label for="disponibilidade_fiador">Teria disponibilidade de apresentar um fiador?</label>
          <p class="doc-hint">Em algumas situa√ß√µes (por exemplo, contrato tempor√°rio ou atividade por conta pr√≥pria), o banco pode exigir um fiador para aprovar o cr√©dito. O fiador √© algu√©m que se compromete perante o banco a pagar a d√≠vida caso o titular do cr√©dito n√£o o fa√ßa. Indicar disponibilidade ajuda a gestora a orientar o seu processo.</p>
          <select id="disponibilidade_fiador" name="disponibilidade_fiador">
            <option value="">Selecione...</option>
            <option value="Sim">Sim</option>
            <option value="N√£o">N√£o</option>
          </select>
        </div>
        <div id="docList"></div>
        <div class="checkbox-wrap" style="margin-top:1.25rem;">
          <label>
            <input type="checkbox" id="financiamento_100" name="financiamento_100" value="1">
            Solicito financiamento a 100% para jovens com menos de 35 anos
          </label>
        </div>
        <div id="docs_100" class="conditional">
          <div id="docList100"></div>
        </div>
        <div id="docRgpd" style="margin-top:1.25rem;"></div>
      </div>

      <div class="card">
        <label for="mensagem_gestora">Mensagem para a gestora (opcional)</label>
        <textarea id="mensagem_gestora" name="mensagem_gestora" rows="3" placeholder="Alguma informa√ß√£o adicional..."></textarea>
      </div>

      <div id="semDocsDisclaimer" style="display:none; margin-bottom:1rem;">
        <p style="margin:0; color:var(--error); font-size:0.9375rem;">Poxa, infelizmente os bancos pedem todos estes documentos para avan√ßar com o processo. Vamos manter contacto e, assim que tiveres tudo em ordem, continua por aqui. Boa sorte! ‚ú®</p>
      </div>
      <div id="formError" class="error-msg" style="display:none;"></div>
      <button type="submit" class="btn btn-primary" id="submitBtn" disabled><span class="btn-text">Enviar para a gestora</span></button>
      <button type="button" class="btn btn-outline" id="btnSemDocs" style="margin-top:0.75rem; display:none; color:var(--error); border-color:var(--error);">N√£o tenho todos os docs</button>
    </form>
    </div>
  </div>

  <script>
    (function () {
      const pathParts = window.location.pathname.split('/').filter(Boolean);
      const leadId = pathParts[pathParts.length - 1];
      if (!leadId || !/^\d+$/.test(leadId)) {
        document.body.innerHTML = '<div class="container"><p class="error-msg">Link inv√°lido.</p></div>';
        return;
      }

      const STORAGE_KEY = 'lead_' + leadId + '_email';
      const IDB_NAME = 'ia_app_lead_docs';
      const IDB_STORE = 'files';
      let pendingEmailForConfirm = '';
      let leadIsSemDocs = false; // lead j√° est√° em sem_docs (ex.: voltou √† p√°gina)
      function getVerifiedEmail() { return sessionStorage.getItem(STORAGE_KEY) || ''; }
      function setVerifiedEmail(email) { sessionStorage.setItem(STORAGE_KEY, email); }
      function setSemDocsUI(showDisclaimer) {
        var disc = document.getElementById('semDocsDisclaimer');
        var btn = document.getElementById('btnSemDocs');
        if (disc) disc.style.display = showDisclaimer ? 'block' : 'none';
        if (btn) btn.style.display = showDisclaimer || leadIsSemDocs ? 'none' : 'block';
      }

      function idbOpen() {
        return new Promise(function (resolve, reject) {
          var r = indexedDB.open(IDB_NAME, 1);
          r.onerror = function () { reject(r.error); };
          r.onsuccess = function () { resolve(r.result); };
          r.onupgradeneeded = function () { r.result.createObjectStore(IDB_STORE, { keyPath: 'key' }); };
        });
      }
      function idbSave(leadId, fieldName, file) {
        return idbOpen().then(function (db) {
          return new Promise(function (resolve, reject) {
            var tx = db.transaction(IDB_STORE, 'readwrite');
            var store = tx.objectStore(IDB_STORE);
            store.put({ key: leadId + '_' + fieldName, file: file });
            tx.oncomplete = function () { resolve(); };
            tx.onerror = function () { reject(tx.error); };
          });
        });
      }
      function idbGet(leadId, fieldName) {
        return idbOpen().then(function (db) {
          return new Promise(function (resolve, reject) {
            var tx = db.transaction(IDB_STORE, 'readonly');
            var req = tx.objectStore(IDB_STORE).get(leadId + '_' + fieldName);
            tx.oncomplete = function () { resolve(req.result ? req.result.file : null); };
            tx.onerror = function () { reject(tx.error); };
          });
        });
      }
      function idbGetAllKeys(leadId) {
        return idbOpen().then(function (db) {
          return new Promise(function (resolve, reject) {
            var tx = db.transaction(IDB_STORE, 'readonly');
            var req = tx.objectStore(IDB_STORE).getAllKeys();
            var prefix = leadId + '_';
            tx.oncomplete = function () {
              var keys = (req.result || []).filter(function (k) { return String(k).indexOf(prefix) === 0; });
              resolve(keys.map(function (k) { return String(k).slice(prefix.length); }));
            };
            tx.onerror = function () { reject(tx.error); };
          });
        });
      }
      function idbClearLead(leadId) {
        return idbGetAllKeys(leadId).then(function (fieldNames) {
          return idbOpen().then(function (db) {
            return new Promise(function (resolve, reject) {
              var tx = db.transaction(IDB_STORE, 'readwrite');
              var store = tx.objectStore(IDB_STORE);
              fieldNames.forEach(function (fn) { store.delete(leadId + '_' + fn); });
              tx.oncomplete = function () { resolve(); };
              tx.onerror = function () { reject(tx.error); };
            });
          });
        });
      }
      function idbDelete(leadId, fieldName) {
        return idbOpen().then(function (db) {
          return new Promise(function (resolve, reject) {
            var tx = db.transaction(IDB_STORE, 'readwrite');
            tx.objectStore(IDB_STORE).delete(leadId + '_' + fieldName);
            tx.oncomplete = function () { resolve(); };
            tx.onerror = function () { reject(tx.error); };
          });
        });
      }
      var FORM_DADOS_KEY = 'formDados';
      function idbSaveFormDados(leadId, obj) {
        return idbOpen().then(function (db) {
          return new Promise(function (resolve, reject) {
            var tx = db.transaction(IDB_STORE, 'readwrite');
            var store = tx.objectStore(IDB_STORE);
            store.put({ key: leadId + '_' + FORM_DADOS_KEY, formDados: obj || {} });
            tx.oncomplete = function () { resolve(); };
            tx.onerror = function () { reject(tx.error); };
          });
        });
      }
      function idbGetFormDados(leadId) {
        return idbOpen().then(function (db) {
          return new Promise(function (resolve, reject) {
            var tx = db.transaction(IDB_STORE, 'readonly');
            var req = tx.objectStore(IDB_STORE).get(leadId + '_' + FORM_DADOS_KEY);
            tx.oncomplete = function () { resolve(req.result && req.result.formDados ? req.result.formDados : null); };
            tx.onerror = function () { reject(tx.error); };
          });
        });
      }

      function showStep(stepId) {
        ['stepNomeEmail', 'stepCode', 'stepEnterEmail', 'stepDocsEnviados', 'mainForm'].forEach(function (id) {
          var el = document.getElementById(id);
          if (el) el.style.display = id === stepId ? 'block' : 'none';
        });
      }
      var WHATSAPP_MSG = 'Ola, meu nome √© {nome}, acabei de enviar meus documentos por email para voc√™. Pode confirmar o recebimento por favor?';
      function setGestoraEmailDisplay(email) {
        var wrap = document.getElementById('gestoraEmailWrap');
        var ref = document.getElementById('gestoraEmailRef');
        if (wrap && ref && email) {
          ref.textContent = email;
          ref.href = 'mailto:' + email;
          wrap.style.display = 'block';
        } else if (wrap) wrap.style.display = 'none';
      }
      function setGestoraWhatsappDisplay(whatsappNumber, nome) {
        var wrap = document.getElementById('gestoraWhatsappWrap');
        var ref = document.getElementById('gestoraWhatsappRef');
        if (wrap && ref && whatsappNumber) {
          var msg = WHATSAPP_MSG.replace('{nome}', (nome || '')).trim();
          ref.href = 'https://wa.me/' + whatsappNumber + '?text=' + encodeURIComponent(msg);
          wrap.style.display = 'block';
        } else if (wrap) wrap.style.display = 'none';
      }
      function setGestoraNomeDisplay(nome) {
        var wrap = document.getElementById('gestoraNomeWrap');
        var ref = document.getElementById('gestoraNomeRef');
        if (wrap && ref && nome) {
          ref.textContent = nome;
          wrap.style.display = 'block';
        } else if (wrap) wrap.style.display = 'none';
      }
      function setDocsEnviadosDisplay(data) {
        setGestoraNomeDisplay(data.gestoraNome);
        setGestoraEmailDisplay(data.gestoraEmail);
        setGestoraWhatsappDisplay(data.gestoraWhatsapp, data.nome);
      }

      const VINCULO_EFETIVO = 'Contrato Efetivo';
      const VINCULO_TEMPORARIO = 'Contrato tempor√°rio';
      const VINCULO_RECIBOS_VERDES = 'Recibos verdes';

      function getDocsBase(vinculo) {
        const cartao = { field: 'cartao_residencia_ou_passaporte', label: '1. Cart√£o de resid√™ncia ou passaporte', description: 'Documento de identifica√ß√£o v√°lido: cart√£o de resid√™ncia (titular de autoriza√ß√£o de resid√™ncia) ou passaporte. Deve estar dentro do prazo de validade.' };
        const common = [
          { field: 'irs_declaracao', label: '4. Declara√ß√£o de IRS (√∫ltimo ano)', description: 'Declara√ß√£o de IRS referente ao √∫ltimo ano fiscal. Obt√©m-se no Portal das Finan√ßas (finan√ßas.gov.pt): √Årea reservada ‚Üí Declara√ß√µes ‚Üí Consultar declara√ß√µes entregues. Fa√ßa download do PDF da declara√ß√£o entregue.' },
          { field: 'irs_nota_liquidacao', label: '5. Nota de liquida√ß√£o IRS', description: 'Documento que comprova o resultado da liquida√ß√£o do IRS (reembolso ou valor a pagar). Tamb√©m dispon√≠vel no Portal das Finan√ßas: ap√≥s a entrega da declara√ß√£o, a nota de liquida√ß√£o fica dispon√≠vel para download na mesma √°rea.' },
          { field: 'comprovativo_morada', label: '6. Comprovativo de morada', description: 'Documento que comprova a sua morada fiscal (ex.: extrato de morada ou comprovativo retirado do site das Finan√ßas). No Portal das Finan√ßas: √Årea reservada ‚Üí Dados pessoais / Morada fiscal. Pode gerar um comprovativo em PDF.' },
          { field: 'mapa_responsabilidades', label: '7. Mapa de responsabilidades de cr√©dito', description: 'Documento oficial do Banco de Portugal que lista os seus cr√©ditos. Passo a passo: aceda ao site do Banco de Portugal (<a href="https://www.bportugal.pt/" target="_blank" rel="noopener" class="doc-link-inline">www.bportugal.pt</a>) ‚Üí Particulares ‚Üí Central de Responsabilidades de Cr√©dito ‚Üí aceite as condi√ß√µes ‚Üí selecione a data (m√™s/ano) ‚Üí autentique-se com Cart√£o de Cidad√£o ou Portal das Finan√ßas. O download √© feito automaticamente.' },
        ];
        const v = (vinculo || '').trim();
        if (v === VINCULO_TEMPORARIO) {
          return [
            cartao,
            { type: 'recibos', label: '2. √öltimos 3 recibos de vencimento', description: 'Comprovativo dos seus rendimentos. S√£o os comprovativos que recebe do empregador com o valor l√≠quido do sal√°rio. Anexe os 3 √∫ltimos meses.', fields: ['recibo_vencimento_1', 'recibo_vencimento_2', 'recibo_vencimento_3'] },
            { field: 'contrato_temporario', label: '3. Contrato', description: 'Contrato de trabalho que comprova o v√≠nculo laboral. Deve ser o contrato assinado (termo de responsabilidade ou contrato de trabalho a termo). A declara√ß√£o deve ser recente.' },
            ...common,
          ];
        }
        if (v === VINCULO_RECIBOS_VERDES) {
          return [
            cartao,
            { field: 'extrato_recibos_12_meses', label: '2. Extrato dos √∫ltimos 12 meses de recibos verdes', description: 'Comprovativo dos rendimentos como trabalhador independente. No <a href="https://www.portaldasfinancas.gov.pt" target="_blank" rel="noopener" class="doc-link-inline">Portal das Finan√ßas</a>, ap√≥s login (NIF + password ou Chave M√≥vel Digital), aceda a ¬´Faturas e Recibos¬ª / ¬´Recibos Verdes Eletr√≥nicos¬ª ‚Üí ¬´Consultar Recibos¬ª. Use os filtros de datas (in√≠cio e fim) para os √∫ltimos 12 meses, depois descarregue ou imprima a lista/PDF e anexe aqui. O Portal n√£o gera um extrato autom√°tico com m√©dia mensal; pode anexar a lista filtrada ou um documento onde tenha os valores.' },
            { field: 'declaracao_abertura_atividade', label: '3. Declara√ß√£o de abertura de atividade', description: 'Documento que comprova que est√° inscrito como trabalhador independente (recibos verdes). Pode ser o comprovativo de inscri√ß√£o na Seguran√ßa Social ou a declara√ß√£o de in√≠cio de atividade das Finan√ßas. Se n√£o tiver, pode obt√™-lo no portal da Seguran√ßa Social Direta ou no Portal das Finan√ßas.' },
            ...common,
          ];
        }
        return [
          cartao,
          { type: 'recibos', label: '2. √öltimos 3 recibos de vencimento', description: 'Comprovativo dos seus rendimentos. S√£o os comprovativos que recebe do empregador com o valor l√≠quido do sal√°rio. Pode obt√™-los no portal do empregador, no recibo em PDF que recebe por email, ou pedindo √† entidade patronal. Anexe os 3 √∫ltimos meses.', fields: ['recibo_vencimento_1', 'recibo_vencimento_2', 'recibo_vencimento_3'] },
          { field: 'contrato_ou_declaracao_efetividade', label: '3. Contrato ou declara√ß√£o de efetividade', description: 'Comprova o v√≠nculo laboral e se est√° efetivo. Pode ser o contrato de trabalho assinado ou uma declara√ß√£o da entidade patronal a indicar que est√° em regime de efetividade. A declara√ß√£o deve ser recente.' },
          ...common,
        ];
      }
      const DOCS_100 = [
        { field: 'declaracao_nao_divida_financas', label: 'Declara√ß√£o de n√£o d√≠vida (Finan√ßas)', stepByStep: 'Obtida no Portal das Finan√ßas. Passo a passo: 1) Aceda a finan√ßas.gov.pt e entre na √Årea reservada; 2) Procure o servi√ßo "Certid√£o de situa√ß√£o contributiva" ou "Declara√ß√£o de d√≠vidas fiscais / n√£o d√≠vida"; 3) Selecione o tipo de certid√£o (situa√ß√£o tribut√°ria); 4) Gere o documento em PDF e fa√ßa download.' },
        { field: 'declaracao_nao_divida_seguranca_social', label: 'Declara√ß√£o de n√£o d√≠vida (Seguran√ßa Social)', stepByStep: 'Obtida no site da Seguran√ßa Social. Passo a passo: 1) Aceda a seg-social.pt e entre na √°rea "Seguran√ßa Social Direta"; 2) Procure "Certid√£o de situa√ß√£o contributiva" ou "Declara√ß√£o de n√£o d√≠vida"; 3) Selecione o per√≠odo e o tipo de certid√£o; 4) Gere e fa√ßa download do PDF.' },
        { field: 'declaracao_predial', label: 'Declara√ß√£o Predial negativa', stepByStep: 'Comprova que n√£o tem im√≥veis em seu nome (ou a situa√ß√£o predial). Passo a passo: 1) Aceda ao Portal das Finan√ßas (finan√ßas.gov.pt); 2) √Årea reservada ‚Üí Servi√ßos ‚Üí Registo e not√°rios (ou "Certid√µes"); 3) Solicite a "Certid√£o permanente de conte√∫do de registo predial" ou "Declara√ß√£o de n√£o titularidade" conforme dispon√≠vel; 4) Siga as instru√ß√µes para obter o documento em PDF.' },
      ];
      const DOC_RGPD = {
        field: 'rgpd_assinado',
        label: '8. Documento RGPD assinado',
        description: 'Documento de consentimento e prote√ß√£o de dados. Deve ser assinado antes do envio.',
        footnote: 'Pode assinar de duas formas: (1) Imprimir o PDF em anexo, assinar √† m√£o e digitalizar ou fotografar; ou (2) Assinar electronicamente com Chave M√≥vel Digital em <a href="https://bit.ly/assinarcmd" target="_blank" rel="noopener" class="doc-link-inline">bit.ly/assinarcmd</a> ‚Äî siga os passos no site, fa√ßa download do documento assinado e anexe-o aqui.',
      };

      let docsState = {};
      const required100 = DOCS_100.map((d) => d.field);

      function getRequiredBaseFields() {
        const vinculo = (document.getElementById('vinculo_laboral') && document.getElementById('vinculo_laboral').value) || '';
        const base = getDocsBase(vinculo);
        const fields = [];
        base.forEach((d) => {
          if (d.field) fields.push(d.field);
          if (d.fields) d.fields.forEach((f) => fields.push(f));
        });
        fields.push('rgpd_assinado');
        return fields;
      }

      function getRequired() {
        const base = getRequiredBaseFields();
        const is100 = document.getElementById('financiamento_100').checked;
        return is100 ? [...base, ...required100] : base;
      }

      function countUploaded() {
        const req = getRequired();
        return req.filter((f) => docsState[f]).length;
      }

      function updateProgress() {
        const req = getRequired();
        const n = req.filter((f) => docsState[f]).length;
        const total = req.length;
        const wrap = document.getElementById('progressWrap');
        const text = document.getElementById('progressText');
        const fill = document.getElementById('progressFill');
        wrap.style.display = 'block';
        text.textContent = n + ' de ' + total + ' documentos anexados';
        fill.style.width = total ? (100 * n / total) + '%' : '0%';
        document.getElementById('submitBtn').disabled = false;
      }

      function renderDocBlock(item, container, opts) {
        opts = opts || {};
        const field = item.field;
        const uploaded = !!docsState[field];
        const desc = opts.description || item.description || item.hint || '';
        const stepByStep = opts.stepByStep || item.stepByStep || '';
        const div = document.createElement('div');
        div.className = 'doc-block';
        div.dataset.field = field;
        div.innerHTML =
          '<div class="doc-title">' + escapeHtml(item.label) + '</div>' +
          (!uploaded && desc ? '<div class="doc-hint">' + (opts.allowHtml ? desc : escapeHtml(desc)) + '</div>' : '') +
          (!uploaded && stepByStep ? '<div class="doc-step">' + (opts.allowHtml ? stepByStep : escapeHtml(stepByStep)) + '</div>' : '') +
          '<div class="doc-upload-zone">' +
          (uploaded ? uploadedZoneHtml(field) : '<input type="file" accept=".pdf,.jpg,.jpeg,.png" data-field="' + escapeHtml(field) + '">') +
          '</div>' +
          (!uploaded && item.footnote ? '<p class="footnote">' + (opts.allowHtml ? item.footnote : escapeHtml(item.footnote)) + '</p>' : '');
        container.appendChild(div);

        const zone = div.querySelector('.doc-upload-zone');
        const fileInput = div.querySelector('input[type="file"]');
        if (docsState[field]) {
          attachUploadedZoneHandlers(zone, leadId, field, div);
        } else {
          fileInput.addEventListener('change', () => uploadOne(leadId, field, fileInput, div));
        }
      }

      function renderRecibosBlock(container) {
        const vinculo = (document.getElementById('vinculo_laboral') && document.getElementById('vinculo_laboral').value) || '';
        const item = getDocsBase(vinculo).find((d) => d.type === 'recibos');
        if (!item) return;
        var anyReciboUploaded = item.fields.some(function (f) { return docsState[f]; });
        const wrap = document.createElement('div');
        wrap.className = 'doc-block';
        wrap.innerHTML =
          '<div class="doc-title">' + escapeHtml(item.label) + '</div>' +
          (!anyReciboUploaded && item.description ? '<div class="doc-hint doc-recibos-desc">' + escapeHtml(item.description) + '</div>' : '') +
          '<div class="recibos-row" id="recibosRow"></div>';
        container.appendChild(wrap);
        const row = wrap.querySelector('#recibosRow');
        const labels = ['Recibo 1', 'Recibo 2', 'Recibo 3'];
        item.fields.forEach((fieldName, i) => {
          renderDocBlock({ field: fieldName, label: labels[i] }, row, { allowHtml: false });
        });
      }

      function renderRgpdBlock(container) {
        const d = DOC_RGPD;
        const uploaded = !!docsState[d.field];
        const div = document.createElement('div');
        div.className = 'doc-block';
        div.dataset.field = d.field;
        div.innerHTML =
          '<div class="doc-title">' + escapeHtml(d.label) + '</div>' +
          (!uploaded && d.description ? '<div class="doc-hint">' + escapeHtml(d.description) + '</div>' : '') +
          (!uploaded ? '<p class="doc-hint">Descarregue o documento: <a href="/RGPD.pdf" target="_blank" rel="noopener" class="doc-link-inline">RGPD.pdf</a></p>' : '') +
          '<div class="doc-upload-zone">' +
          (uploaded ? uploadedZoneHtml(d.field) : '<input type="file" accept=".pdf,.jpg,.jpeg,.png" data-field="' + escapeHtml(d.field) + '">') +
          '</div>' +
          (!uploaded && d.footnote ? '<p class="footnote">' + d.footnote + '</p>' : '');
        container.appendChild(div);

        const zone = div.querySelector('.doc-upload-zone');
        const fileInput = div.querySelector('input[type="file"]');
        if (docsState[d.field]) {
          attachUploadedZoneHandlers(zone, leadId, d.field, div);
        } else {
          fileInput.addEventListener('change', () => uploadOne(leadId, d.field, fileInput, div));
        }
      }

      function escapeHtml(s) {
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      var ICON_VIEW = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/></svg>';
      var ICON_PENCIL = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931z"/></svg>';
      var ICON_TRASH = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"/></svg>';

      function removeBlockDescriptiveContent(blockEl) {
        if (!blockEl) return;
        blockEl.querySelectorAll('.doc-hint-wrap').forEach(function (el) { el.remove(); });
        var i = blockEl.children.length;
        while (i--) {
          var c = blockEl.children[i];
          if (c.classList.contains('doc-hint') || c.classList.contains('doc-step') || (c.tagName === 'P' && c.classList.contains('footnote'))) c.remove();
        }
      }

      function viewFile(leadId, fieldName) {
        idbGet(leadId, fieldName).then(function (file) {
          if (!file) return;
          var url = URL.createObjectURL(file);
          window.open(url, '_blank', 'noopener');
          setTimeout(function () { URL.revokeObjectURL(url); }, 60000);
        }).catch(function () {});
      }

      function uploadedZoneHtml(fieldName) {
        return '<span class="doc-status">Anexado</span><div class="doc-actions">' +
          '<button type="button" class="btn btn-icon" data-action="view" title="Ver">' + ICON_VIEW + '</button>' +
          '<button type="button" class="btn btn-icon" data-action="replace" title="Trocar">' + ICON_PENCIL + '</button>' +
          '<button type="button" class="btn btn-icon" data-action="remove" title="Remover">' + ICON_TRASH + '</button>' +
          '</div><input type="file" accept=".pdf,.jpg,.jpeg,.png" data-field="' + escapeHtml(fieldName) + '" style="display:none;">';
      }

      function attachUploadedZoneHandlers(zone, leadId, fieldName, blockEl) {
        var viewBtn = zone.querySelector('[data-action="view"]');
        var replaceBtn = zone.querySelector('[data-action="replace"]');
        var removeBtn = zone.querySelector('[data-action="remove"]');
        var fileInput = zone.querySelector('input[type="file"]');
        if (viewBtn) viewBtn.addEventListener('click', function () { viewFile(leadId, fieldName); });
        if (replaceBtn) {
          replaceBtn.addEventListener('click', function () {
            fileInput.style.display = 'block';
            replaceBtn.style.display = 'none';
            if (viewBtn) viewBtn.style.display = 'none';
            if (removeBtn) removeBtn.style.display = 'none';
            fileInput.click();
          });
        }
        if (removeBtn) {
          removeBtn.addEventListener('click', function () {
            idbDelete(leadId, fieldName).then(function () {
              docsState[fieldName] = false;
              var zone = blockEl.querySelector('.doc-upload-zone');
              removeBlockDescriptiveContent(blockEl);
              var vinculoVal = document.getElementById('vinculo_laboral') ? document.getElementById('vinculo_laboral').value : '';
var item = getDocsBase(vinculoVal).find(function (d) { return d.field === fieldName; }) || DOCS_100.find(function (d) { return d.field === fieldName; }) || (DOC_RGPD.field === fieldName ? DOC_RGPD : null);
              if (item && blockEl.querySelector('.doc-upload-zone')) {
                var wrap = document.createElement('div');
                wrap.className = 'doc-hint-wrap';
                var html = '';
                if (item.description) html += '<div class="doc-hint">' + (item.description.indexOf('<a ') !== -1 ? item.description : escapeHtml(item.description)) + '</div>';
                if (item.stepByStep) html += '<div class="doc-step">' + (item.stepByStep.indexOf('<') !== -1 ? item.stepByStep : escapeHtml(item.stepByStep)) + '</div>';
                if (item === DOC_RGPD) html += '<p class="doc-hint">Descarregue o documento: <a href="/RGPD.pdf" target="_blank" rel="noopener" class="doc-link-inline">RGPD.pdf</a></p>';
                if (item.footnote) html += '<p class="footnote">' + (item.footnote.indexOf('<a ') !== -1 ? item.footnote : escapeHtml(item.footnote)) + '</p>';
                wrap.innerHTML = html;
                blockEl.insertBefore(wrap, zone);
              }
              zone.innerHTML = '<input type="file" accept=".pdf,.jpg,.jpeg,.png" data-field="' + escapeHtml(fieldName) + '">';
              zone.querySelector('input[type="file"]').addEventListener('change', function () { uploadOne(leadId, fieldName, zone.querySelector('input[type="file"]'), blockEl); });
              updateProgress();
            }).catch(function () {});
          });
        }
        fileInput.addEventListener('change', function () { uploadOne(leadId, fieldName, fileInput, blockEl); });
      }

      function uploadOne(leadId, fieldName, fileInput, blockEl) {
        const file = fileInput.files && fileInput.files[0];
        if (!file) return;
        blockEl.querySelector('.doc-upload-zone').innerHTML = '<span style="color:var(--text-muted);font-size:0.875rem;">A guardar‚Ä¶</span>';
        idbSave(leadId, fieldName, file)
          .then(function () {
            docsState[fieldName] = true;
            removeBlockDescriptiveContent(blockEl);
            if (fieldName === 'recibo_vencimento_1' || fieldName === 'recibo_vencimento_2' || fieldName === 'recibo_vencimento_3') {
              var recibosBlock = blockEl.closest('.doc-block');
              if (recibosBlock && recibosBlock.querySelector('.recibos-row')) {
                var desc = recibosBlock.querySelector('.doc-recibos-desc');
                if (desc) desc.remove();
              }
            }
            const zone = blockEl.querySelector('.doc-upload-zone');
            zone.innerHTML = uploadedZoneHtml(fieldName);
            attachUploadedZoneHandlers(zone, leadId, fieldName, blockEl);
            updateProgress();
          })
          .catch(function () {
            blockEl.querySelector('.doc-upload-zone').innerHTML = '<span class="error-msg">Erro ao guardar. Tente novamente.</span><input type="file" accept=".pdf,.jpg,.jpeg,.png" data-field="' + fieldName + '">';
            blockEl.querySelector('input[type="file"]').addEventListener('change', function () { uploadOne(leadId, fieldName, blockEl.querySelector('input[type="file"]'), blockEl); });
            updateProgress();
          });
      }

      function renderAll() {
        const vinculo = (document.getElementById('vinculo_laboral') && document.getElementById('vinculo_laboral').value) || '';
        const DOCS_BASE = getDocsBase(vinculo);
        const listEl = document.getElementById('docList');
        listEl.innerHTML = '';
        DOCS_BASE.forEach((item) => {
          if (item.type === 'recibos') {
            renderRecibosBlock(listEl);
          } else if (item.field) {
            renderDocBlock(item, listEl, { allowHtml: !!item.description && item.description.indexOf('<a ') !== -1 });
          }
        });

        const list100 = document.getElementById('docList100');
        list100.innerHTML = '';
        DOCS_100.forEach((item) => renderDocBlock(item, list100, { allowHtml: true }));

        const rgpdEl = document.getElementById('docRgpd');
        rgpdEl.innerHTML = '';
        renderRgpdBlock(rgpdEl);

        document.getElementById('financiamento_100').addEventListener('change', () => {
          document.getElementById('docs_100').classList.toggle('visible', document.getElementById('financiamento_100').checked);
          updateProgress();
        });
        document.getElementById('docs_100').classList.toggle('visible', document.getElementById('financiamento_100').checked);
        var vinculoEl = document.getElementById('vinculo_laboral');
        if (vinculoEl && !vinculoEl.dataset.vinculoUiBound) {
          vinculoEl.dataset.vinculoUiBound = '1';
          vinculoEl.addEventListener('change', function () {
            var v = this.value;
            var fiadorWrap = document.getElementById('fiadorWrap');
            if (fiadorWrap) fiadorWrap.style.display = (v === VINCULO_TEMPORARIO || v === VINCULO_RECIBOS_VERDES) ? 'block' : 'none';
            renderAll();
          });
        }
        updateProgress();
      }

      function saveDados() {
        const nome = document.getElementById('nome').value.trim();
        const estado_civil = document.getElementById('estado_civil').value;
        const num_dependentes = document.getElementById('num_dependentes').value;
        const anos_emprego_atual = document.getElementById('anos_emprego_atual').value.trim();
        const vinculo_laboral = (document.getElementById('vinculo_laboral') && document.getElementById('vinculo_laboral').value) || '';
        const disponibilidade_fiador = (document.getElementById('disponibilidade_fiador') && document.getElementById('disponibilidade_fiador').value) || '';
        const consentIntermediariaEl = document.getElementById('consent_intermediaria');
        const consent_intermediaria = !!(consentIntermediariaEl && consentIntermediariaEl.checked);
        fetch('/api/leads/' + leadId, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: getVerifiedEmail(), nome: nome || '' }),
        }).catch(function () {});
        idbSaveFormDados(leadId, {
          estado_civil: estado_civil || '',
          num_dependentes: num_dependentes === '' ? '' : String(num_dependentes),
          anos_emprego_atual: anos_emprego_atual || '',
          vinculo_laboral: vinculo_laboral || '',
          disponibilidade_fiador: disponibilidade_fiador || '',
          consent_intermediaria: consent_intermediaria,
        }).catch(function () {});
      }

      function getDocListKeys() { return [...getRequiredBaseFields(), ...required100]; }
      function isDocKey(k) { return getDocListKeys().includes(k); }

      function loadDocuments() {
        const email = getVerifiedEmail();
        if (!email) return;
        fetch('/api/leads/' + leadId + '/documents?email=' + encodeURIComponent(email))
          .then(function (r) { if (!r.ok) return r.json().then(function (d) { throw new Error(d.message || 'Erro'); }); return r.json(); })
          .then(function (data) {
            const nome = data.nome;
            return Promise.all([idbGetAllKeys(leadId), idbGetFormDados(leadId)]).then(function (arr) {
              var keys = arr[0];
              var formDados = arr[1] || {};
              docsState = {};
              keys.filter(function (k) { return k !== FORM_DADOS_KEY; }).forEach(function (k) { docsState[k] = true; });
              const nomeEl = document.getElementById('nome');
              if (nomeEl) nomeEl.value = (nome != null ? nome : '') || '';
              const estadoEl = document.getElementById('estado_civil');
              if (estadoEl) estadoEl.value = (formDados.estado_civil != null ? formDados.estado_civil : '') || '';
              const numDepEl = document.getElementById('num_dependentes');
              if (numDepEl) numDepEl.value = (formDados.num_dependentes !== undefined && formDados.num_dependentes !== null ? String(formDados.num_dependentes) : '');
              const anosEmpregoEl = document.getElementById('anos_emprego_atual');
              if (anosEmpregoEl) anosEmpregoEl.value = (formDados.anos_emprego_atual != null ? String(formDados.anos_emprego_atual) : '');
              const vinculoEl = document.getElementById('vinculo_laboral');
              var vinculoVal = (formDados.vinculo_laboral != null ? formDados.vinculo_laboral : '') || '';
              if (vinculoEl) vinculoEl.value = vinculoVal;
              const dispFiadorEl = document.getElementById('disponibilidade_fiador');
              if (dispFiadorEl) dispFiadorEl.value = (formDados.disponibilidade_fiador != null ? formDados.disponibilidade_fiador : '') || '';
              var consentIntermediariaEl = document.getElementById('consent_intermediaria');
              if (consentIntermediariaEl) consentIntermediariaEl.checked = !!(formDados.consent_intermediaria);
              var fiadorWrap = document.getElementById('fiadorWrap');
              if (fiadorWrap) fiadorWrap.style.display = (vinculoVal === VINCULO_TEMPORARIO || vinculoVal === VINCULO_RECIBOS_VERDES) ? 'block' : 'none';
            var emailFormEl = document.getElementById('email');
            if (emailFormEl) emailFormEl.value = email;
            nomeEl.addEventListener('blur', saveDados);
              numDepEl.addEventListener('blur', saveDados);
              if (anosEmpregoEl) anosEmpregoEl.addEventListener('blur', saveDados);
              if (vinculoEl) vinculoEl.addEventListener('change', saveDados);
              if (dispFiadorEl) dispFiadorEl.addEventListener('change', saveDados);
              if (consentIntermediariaEl) consentIntermediariaEl.addEventListener('change', saveDados);
              estadoEl.addEventListener('change', saveDados);
              renderAll();
            });
          })
          .catch(function () {
            docsState = {};
            renderAll();
          });
      }

      fetch('/api/leads/' + leadId + '/status')
        .then((r) => { if (!r.ok) throw new Error(); return r.json(); })
        .then((data) => {
          if (data.docsEnviados) {
            var savedEmail = getVerifiedEmail();
            if (savedEmail) {
              fetch('/api/leads/' + leadId + '/access', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: savedEmail }),
              })
                .then(function (r) { return r.ok ? r.json() : Promise.reject(); })
                .then(function (d) {
                  setDocsEnviadosDisplay(d);
                  showStep('stepDocsEnviados');
                })
                .catch(function () { showStep('stepEnterEmail'); });
              return;
            }
            showStep('stepEnterEmail');
            return;
          }
          if (data.semDocs) {
            leadIsSemDocs = true;
            var savedEmail = getVerifiedEmail();
            if (!savedEmail) {
              showStep('stepEnterEmail');
              return;
            }
            showStep('mainForm');
            setSemDocsUI(false);
            loadDocuments();
            return;
          }
          if (!data.hasEmail) {
            showStep('stepNomeEmail');
            return;
          }
          var savedEmail = getVerifiedEmail();
          if (!savedEmail) {
            showStep('stepEnterEmail');
            return;
          }
          showStep('mainForm');
          setSemDocsUI(false);
          loadDocuments();
        })
        .catch(() => { showStep('stepNomeEmail'); });

      document.getElementById('btnAvan√ßar').addEventListener('click', function () {
        var consentEl = document.getElementById('consent_rafa_gate');
        var nome = document.getElementById('gate_nome').value.trim();
        var email = document.getElementById('gate_email').value.trim();
        var errEl = document.getElementById('gateError1');
        errEl.style.display = 'none';
        if (!consentEl || !consentEl.checked) { errEl.textContent = 'Aceite partilhar o seu nome e email com a Rafa para continuar.'; errEl.style.display = 'block'; return; }
        if (!nome) { errEl.textContent = 'Indique o seu nome completo.'; errEl.style.display = 'block'; return; }
        if (!email) { errEl.textContent = 'Indique o seu email.'; errEl.style.display = 'block'; return; }
        this.disabled = true;
        fetch('/api/leads/' + leadId + '/request-verification', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nome: nome, email: email }),
        })
          .then(function (r) {
            if (r.ok) {
              pendingEmailForConfirm = email;
              showStep('stepCode');
              document.getElementById('gate_code').value = '';
              return;
            }
            return r.json().then(function (d) { throw new Error(d.message || 'Erro'); });
          })
          .catch(function (err) {
            errEl.textContent = err.message || 'Erro. Tente novamente.';
            errEl.style.display = 'block';
          })
          .finally(function () { document.getElementById('btnAvan√ßar').disabled = false; });
      });

      document.getElementById('btnConfirmar').addEventListener('click', function () {
        var code = document.getElementById('gate_code').value.trim();
        var errEl = document.getElementById('gateError2');
        errEl.style.display = 'none';
        if (!code) { errEl.textContent = 'Indique o c√≥digo.'; errEl.style.display = 'block'; return; }
        this.disabled = true;
        fetch('/api/leads/' + leadId + '/confirm-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: code }),
        })
          .then(function (r) {
            if (r.ok) {
              setVerifiedEmail(pendingEmailForConfirm);
              document.getElementById('email').value = pendingEmailForConfirm;
              document.getElementById('nome').value = document.getElementById('gate_nome').value.trim();
              var cr = document.getElementById('consent_rafa');
              if (cr) cr.checked = true;
              showStep('mainForm');
              setSemDocsUI(false);
              loadDocuments();
              return;
            }
            return r.json().then(function (d) { throw new Error(d.message || 'Erro'); });
          })
          .catch(function (err) {
            errEl.textContent = err.message || 'C√≥digo inv√°lido ou expirado.';
            errEl.style.display = 'block';
          })
          .finally(function () { document.getElementById('btnConfirmar').disabled = false; });
      });

      document.getElementById('btnContinuar').addEventListener('click', function () {
        var email = document.getElementById('gate_email_return').value.trim();
        var errEl = document.getElementById('gateError3');
        errEl.style.display = 'none';
        if (!email) { errEl.textContent = 'Indique o seu email.'; errEl.style.display = 'block'; return; }
        this.disabled = true;
        fetch('/api/leads/' + leadId + '/access', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: email }),
        })
          .then(function (r) {
            if (r.ok) {
              return r.json().then(function (d) {
                setVerifiedEmail(email);
                document.getElementById('email').value = email;
                var cr = document.getElementById('consent_rafa');
                if (cr) cr.checked = true;
                if (d.docsEnviados) {
                  setDocsEnviadosDisplay(d);
                  showStep('stepDocsEnviados');
                  return;
                }
                if (d.semDocs) leadIsSemDocs = true;
                showStep('mainForm');
                setSemDocsUI(false);
                loadDocuments();
              });
            }
            return r.json().then(function (d) { throw new Error(d.message || 'Erro'); });
          })
          .catch(function (err) {
            errEl.textContent = err.message || 'Email incorreto.';
            errEl.style.display = 'block';
          })
          .finally(function () { document.getElementById('btnContinuar').disabled = false; });
      });

      document.getElementById('btnSemDocs').addEventListener('click', function () {
        var email = getVerifiedEmail();
        if (!email) return;
        var btn = this;
        btn.disabled = true;
        fetch('/api/leads/' + leadId + '/sem-docs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: email }),
        })
          .then(function (r) {
            if (r.ok) {
              setSemDocsUI(true);
              return;
            }
            return r.json().then(function (d) { throw new Error(d.message || 'Erro'); });
          })
          .catch(function (err) {
            document.getElementById('formError').textContent = err.message || 'Erro. Tente novamente.';
            document.getElementById('formError').style.display = 'block';
          })
          .finally(function () { btn.disabled = false; });
      });

      document.getElementById('form').addEventListener('submit', function (e) {
        e.preventDefault();
        const errEl = document.getElementById('formError');
        errEl.style.display = 'none';
        const req = getRequired();
        const missing = req.filter(function (f) { return !docsState[f]; });
        if (missing.length) {
          errEl.textContent = '√â necess√°rio anexar todos os documentos obrigat√≥rios antes de enviar para a gestora. Faltam ' + missing.length + ' documento(s).';
          errEl.style.display = 'block';
          errEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          return;
        }
        saveDados();
        const btn = document.getElementById('submitBtn');
        var btnText = btn.querySelector('.btn-text');
        btn.disabled = true;
        btn.classList.add('sending');
        btn.classList.remove('sent');
        if (btnText) btnText.textContent = 'A enviar...';
        var fd = new FormData();
        fd.append('nome', document.getElementById('nome').value.trim());
        fd.append('email', getVerifiedEmail() || document.getElementById('email').value.trim());
        fd.append('estado_civil', document.getElementById('estado_civil').value);
        fd.append('num_dependentes', document.getElementById('num_dependentes').value);
        fd.append('anos_emprego_atual', document.getElementById('anos_emprego_atual').value.trim());
        fd.append('vinculo_laboral', (document.getElementById('vinculo_laboral') && document.getElementById('vinculo_laboral').value) || '');
        fd.append('disponibilidade_fiador', (document.getElementById('disponibilidade_fiador') && document.getElementById('disponibilidade_fiador').value) || '');
        fd.append('mensagem_gestora', document.getElementById('mensagem_gestora').value.trim());
        fd.append('financiamento_100', document.getElementById('financiamento_100').checked ? '1' : '0');
        Promise.all(req.map(function (fieldName) { return idbGet(leadId, fieldName); }))
          .then(function (files) {
            req.forEach(function (fieldName, i) {
              if (files[i]) fd.append(fieldName, files[i]);
            });
            return fetch('/api/leads/' + leadId + '/send-email', { method: 'POST', body: fd });
          })
          .then(function (r) {
            if (r.ok) {
              btn.classList.remove('sending');
              btn.classList.add('sent');
              if (btnText) btnText.textContent = 'Enviado ‚úì';
              return idbClearLead(leadId).then(function () {
                setTimeout(function () { window.location.href = '/upload/' + leadId; }, 700);
              });
            }
            return r.json().then(function (d) { throw new Error(d.message || 'Erro ao enviar'); });
          })
          .catch(function (err) {
            btn.classList.remove('sending');
            errEl.textContent = err.message || 'Erro ao enviar. Tente novamente.';
            errEl.style.display = 'block';
            if (btnText) btnText.textContent = 'Enviar para a gestora';
            btn.disabled = false;
          });
      });
    })();
  </script>
</body>
</html>
