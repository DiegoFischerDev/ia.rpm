<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard – Crédito Habitação</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f5f5f5;
      --surface: #ffffff;
      --sidebar: #000000;
      --sidebar-hover: #1a1a1a;
      --text: #000000;
      --text-muted: #555555;
      --accent: #edbfbf;
      --accent-hover: #d4a8a8;
      --accent-soft: rgba(237, 191, 191, 0.35);
      --error: #dc2626;
      --border: #e0e0e0;
      --radius: 10px;
      --radius-lg: 14px;
      --shadow: 0 1px 3px rgba(0,0,0,.06);
      --shadow-md: 0 4px 12px rgba(0,0,0,.08);
      --badge: #edbfbf;
      --badge-bg: rgba(237, 191, 191, 0.4);
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Plus Jakarta Sans', system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; font-size: 15px; line-height: 1.5; }
    .app { display: flex; min-height: 100vh; }
    .sidebar {
      width: 260px;
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      z-index: 50;
      background: var(--sidebar);
      color: #fff;
      padding: 1.5rem 0;
      box-shadow: 2px 0 20px rgba(0,0,0,.1);
      display: flex;
      flex-direction: column;
    }
    .main { margin-left: 260px; }
    .sidebar-logo { display: block; padding: 0 1.25rem 1.25rem; text-align: center; }
    .sidebar-logo img { max-width: 100%; height: auto; max-height: 148px; object-fit: contain; }
    .sidebar-footer {
      margin-top: auto;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem 1.25rem;
      border-top: 1px solid rgba(255,255,255,.2);
    }
    .sidebar-footer-icon {
      flex-shrink: 0;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,.15);
      border-radius: 50%;
      color: rgba(255,255,255,.9);
    }
    .sidebar-footer-icon svg { width: 20px; height: 20px; }
    .sidebar-footer-name {
      flex: 1;
      font-size: 0.875rem;
      color: rgba(255,255,255,.9);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      min-width: 0;
    }
    .sidebar-footer-sair {
      background: none;
      border: none;
      color: rgba(255,255,255,.85);
      font-size: 0.875rem;
      cursor: pointer;
      text-decoration: underline;
      padding: 0;
      flex-shrink: 0;
    }
    .sidebar-footer-sair:hover { color: #fff; }
    .sidebar-nav-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 0.75rem 1.25rem;
      color: rgba(255,255,255,.88);
      text-decoration: none;
      border: none;
      background: none;
      font: inherit;
      text-align: left;
      cursor: pointer;
      transition: background .15s, color .15s;
    }
    .sidebar-nav-item:hover { background: var(--sidebar-hover); color: #fff; }
    .sidebar-nav-item.active { background: var(--accent); color: #000; }
    .nav-label { flex: 1; }
    .nav-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 22px;
      height: 22px;
      padding: 0 6px;
      font-size: 0.75rem;
      font-weight: 700;
      color: #000;
      background: var(--badge);
      border-radius: 11px;
      animation: pulse-badge 2s ease-in-out infinite;
    }
    .nav-badge.hidden { display: none; }
    .sidebar-footer-text { display: flex; align-items: center; justify-content: center; flex: 1; }
    .sidebar-footer-version {
      font-size: 0.7rem;
      color: rgba(148, 163, 184, 0.9);
      text-align: center;
      margin-top: 0.25rem;
    }
    @keyframes pulse-badge {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.85; }
    }
    .main { flex: 1; min-width: 0; padding: 2rem 2.5rem; overflow: auto; }
    .screen { display: none; }
    .screen.visible { display: block !important; }
    .app.screen.visible { display: flex !important; }
    .main .screen { display: none; }
    .main .screen.visible { display: block !important; }
    .main #screenPerfil.visible { display: flex !important; flex-direction: column; align-items: flex-start; }
    .login-wrap { max-width: 400px; margin: 5rem auto; padding: 2.5rem; background: var(--surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); border: 1px solid var(--border); }
    .login-wrap h1 { margin: 0 0 1.5rem; font-size: 1.5rem; font-weight: 700; color: var(--text); }
    label { display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text); }
    input[type="email"], input[type="password"], input[type="text"], input[type="number"], select {
      width: 100%; padding: 0.65rem 0.9rem; border: 1px solid var(--border); border-radius: var(--radius); font: inherit; margin-bottom: 1rem; transition: border-color .15s, box-shadow .15s;
    }
    input:focus, select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-soft); }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.4rem; padding: 0.55rem 1rem; border-radius: var(--radius); font: inherit; font-weight: 600; cursor: pointer; border: none; transition: background .15s, transform .05s; }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--accent); color: #000; }
    .btn-primary:hover { background: var(--accent-hover); color: #000; }
    .btn-secondary { background: var(--border); color: var(--text); }
    .btn-secondary:hover { background: #d0d0d0; }
    .btn-danger { background: var(--error); color: #fff; }
    .btn-danger:hover { background: #b91c1c; color: #fff; }
    .btn-sm { padding: 0.4rem 0.75rem; font-size: 0.8125rem; }
    .btn-icon { padding: 0.45rem; min-width: 36px; }
    .btn-icon svg { width: 18px; height: 18px; display: block; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btn-outline:hover { background: var(--bg); border-color: var(--text-muted); }
    .section-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1rem;
      background: transparent;
      border: none;
    }
    #screenDuvidasRespondidas table.role-gestora .th-acoes-admin,
    #screenDuvidasRespondidas table.role-gestora .td-acoes-admin { display: none; }
    #screenDuvidasPendentes table.role-gestora .th-contacto,
    #screenDuvidasPendentes table.role-gestora .td-contacto { display: none; }
    .cell-pergunta { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .error-msg { color: var(--error); font-size: 0.875rem; margin-top: 0.5rem; }
    .page-title { margin: 0 0 1.5rem; font-size: 1.375rem; font-weight: 700; color: var(--text); letter-spacing: -0.02em; }
    .card { background: var(--surface); border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow); border: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border); }
    th { background: var(--bg); font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.04em; color: var(--text-muted); }
    tr:last-child td { border-bottom: none; }
    tbody tr { transition: background .12s; }
    tbody tr:hover { background: var(--accent-soft); }
    .actions { display: flex; gap: 0.5rem; }
    .lead-estado-docs-select { margin-bottom: 0; }
    .lead-badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; white-space: nowrap; }
    .lead-badge--conv-aguardando_escolha { background: #e2e8f0; color: #475569; }
    .lead-badge--conv-com_joana { background: #dbeafe; color: #1e40af; }
    .lead-badge--conv-com_gestora { background: #d1fae5; color: #065f46; }
    .lead-badge--conv-com_rafa { background: #ede9fe; color: #5b21b6; }
    .lead-badge--docs-aguardando_docs { background: #ffedd5; color: #c2410c; }
    .lead-badge--docs-sem_docs { background: #fef3c7; color: #b45309; }
    .lead-badge--docs-docs_enviados { background: #ccfbf1; color: #0f766e; }
    .lead-badge--docs-inviavel { background: #fee2e2; color: #b91c1c; }
    .lead-badge--docs-credito_aprovado { background: #dcfce7; color: #166534; }
    .lead-badge--docs-agendado_escritura { background: #e0e7ff; color: #3730a3; }
    .lead-badge--docs-escritura_realizada { background: #a7f3d0; color: #064e3b; }
    .lead-badge--neutral { background: #f1f5f9; color: #64748b; }
    .leads-toolbar { display: flex; flex-wrap: wrap; align-items: center; gap: 0.75rem; margin-bottom: 1rem; }
    .leads-toolbar .leads-filter-wrap { display: flex; gap: 0.5rem; align-items: center; }
    .leads-toolbar .leads-filter-wrap input { margin-bottom: 0; max-width: 220px; }
    .leads-filter-wrap { display: flex; gap: 0.5rem; align-items: center; flex-wrap: nowrap; }
    .leads-filter-wrap input { margin-bottom: 0; max-width: 220px; }
    .filter-input-wrap { position: relative; display: inline-block; }
    .filter-input-wrap input { padding-right: 1.75rem; }
    .filter-clear-btn {
      position: absolute;
      right: 0.4rem;
      top: 50%;
      transform: translateY(-50%);
      padding: 0;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 1rem;
      line-height: 1;
      width: 1.1rem;
      height: 1.1rem;
      border-radius: 999px;
      cursor: pointer;
    }
    .filter-clear-btn:hover {
      background: var(--accent-soft);
      color: var(--text);
    }
    .leads-groups-wrap { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
    .leads-groups-label { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.06em; }
    .leads-group-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #000;
    }
    .leads-group-btn.active:hover {
      background: var(--accent-hover);
      border-color: var(--accent-hover);
      color: #000;
    }
    .leads-sort-th { white-space: nowrap; }
    .leads-sort-th .sort-icons { display: inline-flex; align-items: center; gap: 0.15rem; margin-left: 0.25rem; vertical-align: middle; }
    .leads-sort-th .sort-icons button { padding: 0.2rem; border: none; background: transparent; cursor: pointer; color: var(--text-muted); border-radius: 4px; }
    .leads-sort-th .sort-icons button:hover { color: var(--text); background: var(--bg); }
    .leads-sort-th .sort-icons button.active { color: var(--accent); }
    .leads-sort-th .sort-icons svg { width: 14px; height: 14px; display: block; }
    .toolbar { margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.4); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
    .modal-overlay.visible { display: flex; }
    .modal { background: var(--surface); border-radius: var(--radius-lg); padding: 1.75rem; max-width: 440px; width: 100%; max-height: 90vh; overflow: auto; box-shadow: 0 20px 40px rgba(0,0,0,.15); }
    .modal h3 { margin: 0 0 1.25rem; font-size: 1.125rem; font-weight: 700; }
    .modal-actions { margin-top: 1.5rem; display: flex; gap: 0.5rem; justify-content: flex-end; }
    .table-wrap { overflow-x: auto; border-radius: var(--radius-lg); }
    .text-muted { color: var(--text-muted); font-size: 0.875rem; }
    .btn-whatsapp { background: #25d366; color: #fff; }
    .btn-whatsapp:hover { background: #20bd5a; color: #fff; }
    .btn-devolver { background: var(--accent-soft); color: var(--text); border: 1px solid var(--accent); }
    .btn-devolver:hover { background: var(--accent); color: #000; border-color: var(--accent); }
    .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.4); z-index: 99; }
    .main-header { display: none; align-items: center; padding: 0; }
    .btn-menu-toggle {
      display: flex; flex-direction: column; justify-content: center; gap: 5px;
      width: 44px; height: 44px; padding: 10px; border: none; background: var(--bg); border-radius: var(--radius);
      cursor: pointer; color: var(--text);
    }
    .btn-menu-toggle span { display: block; width: 20px; height: 2px; background: currentColor; border-radius: 1px; }
    .main-header-logo { display: none; }
    @media (max-width: 768px) {
      .main { margin-left: 0; }
      .main-header { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); background: var(--surface); }
      .main-header-logo { display: block; }
      .main-header-logo img { max-height: 36px; height: auto; max-width: 140px; object-fit: contain; }
      .sidebar {
        position: fixed; left: 0; top: 0; bottom: 0; z-index: 100;
        transition: transform .25s ease; transform: translateX(-100%);
      }
      .app.nav-open .sidebar { transform: translateX(0); }
      .app.nav-open .sidebar-overlay { display: block; }
    }
  </style>
</head>
<body>
  <div id="loginScreen" class="login-wrap screen">
    <div class="login-logo-wrap" style="text-align:center;margin-bottom:1.5rem;"><img src="logo_bg_escura.png" alt="" style="max-height:156px;height:auto;max-width:100%;"></div>
    <div id="loginFormWrap">
      <h1>Login</h1>
      <form id="loginForm">
        <label for="loginEmail">Email</label>
        <input type="email" id="loginEmail" required autocomplete="email">
        <label for="loginPassword">Palavra-passe</label>
        <input type="password" id="loginPassword" required autocomplete="current-password">
        <p id="loginError" class="error-msg" style="display:none;"></p>
        <button type="submit" class="btn btn-primary" style="width:100%;">Entrar</button>
        <p style="margin-top:1rem;text-align:center;">
          <button type="button" id="btnPerdiSenha" class="btn btn-outline btn-sm">Perdi a senha</button>
        </p>
      </form>
    </div>
    <div id="forgotPasswordWrap" style="display:none;">
      <h1>Redefinir palavra-passe</h1>
      <p class="text-muted" style="margin-bottom:1rem;">Introduza o email da sua conta. Enviaremos um link para redefinir a palavra-passe.</p>
      <form id="forgotPasswordForm">
        <label for="forgotEmail">Email</label>
        <input type="email" id="forgotEmail" required autocomplete="email">
        <p id="forgotError" class="error-msg" style="display:none;"></p>
        <p id="forgotSuccess" class="text-muted" style="display:none;"></p>
        <button type="submit" class="btn btn-primary" style="width:100%;">Enviar link</button>
        <p style="margin-top:1rem;text-align:center;">
          <button type="button" id="btnVoltarLogin" class="btn btn-outline btn-sm">Voltar ao login</button>
        </p>
      </form>
    </div>
  </div>

  <div id="resetPasswordScreen" class="login-wrap screen" style="display:none;">
    <div class="login-logo-wrap" style="text-align:center;margin-bottom:1.5rem;"><img src="logo_bg_escura.png" alt="" style="max-height:156px;height:auto;max-width:100%;"></div>
    <h1>Nova palavra-passe</h1>
    <p class="text-muted" style="margin-bottom:1rem;">Defina uma nova palavra-passe (mínimo 6 caracteres).</p>
    <form id="resetPasswordForm">
      <label for="resetPassword">Nova palavra-passe</label>
      <input type="password" id="resetPassword" required minlength="6" autocomplete="new-password">
      <label for="resetPasswordConfirm">Confirmar palavra-passe</label>
      <input type="password" id="resetPasswordConfirm" required minlength="6" autocomplete="new-password">
      <p id="resetError" class="error-msg" style="display:none;"></p>
      <p id="resetSuccess" class="text-muted" style="display:none;"></p>
      <button type="submit" class="btn btn-primary" style="width:100%;">Alterar palavra-passe</button>
      <p style="margin-top:1rem;text-align:center;">
        <a href="/" class="btn btn-outline btn-sm">Voltar ao login</a>
      </p>
    </form>
  </div>

  <div id="dashboardApp" class="app screen">
    <nav class="sidebar">
      <a href="#leads" class="sidebar-logo" aria-label="Início"><img src="logo_bg_clara.png" alt=""></a>
      <a href="#leads" id="navLeads" class="sidebar-nav-item active">Leads</a>
      <a href="#rafa" id="navRafa" class="sidebar-nav-item">
        <span class="nav-label">Falar com Rafa</span>
        <span id="navRafaBadge" class="nav-badge hidden">0</span>
      </a>
      <a href="#gestoras" id="navGestoras" class="sidebar-nav-item">Gestoras</a>
      <a href="#duvidas-pendentes" id="navDuvidasPendentes" class="sidebar-nav-item">
        <span class="nav-label">Perguntas pendentes</span>
        <span id="navDuvidasPendentesBadge" class="nav-badge hidden">0</span>
      </a>
      <a href="#duvidas-respondidas" id="navDuvidasRespondidas" class="sidebar-nav-item">FAQ</a>
      <a href="#perfil" id="navPerfil" class="sidebar-nav-item" style="display:none;">Perfil</a>
      <div class="sidebar-footer">
        <span class="sidebar-footer-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6"/></svg>
        </span>
        <div class="sidebar-footer-text">
          <span id="sidebarUserName" class="sidebar-footer-name" aria-live="polite"></span>
        </div>
        <button type="button" id="btnLogout" class="sidebar-footer-sair">Sair</button>
      </div>
      <div class="sidebar-footer-version">versão 1.0</div>
    </nav>
    <div id="sidebarOverlay" class="sidebar-overlay" aria-hidden="true"></div>
    <main class="main">
      <header class="main-header">
        <button type="button" id="btnMenuToggle" class="btn-menu-toggle" aria-label="Abrir menu">
          <span></span><span></span><span></span>
        </button>
        <a href="#leads" class="main-header-logo"><img src="logo_bg_escura.png" alt=""></a>
      </header>
      <div id="screenLeads" class="screen visible">
        <h2 class="page-title">Leads</h2>
        <div id="leadsToolbar" class="leads-toolbar" style="display:none;">
          <div class="leads-filter-wrap">
            <div class="filter-input-wrap">
              <input type="text" id="leadsFilterInput" placeholder="Filtrar por palavra...">
              <button type="button" class="filter-clear-btn" id="leadsFilterClear" title="Limpar filtro">×</button>
            </div>
            <button type="button" class="btn btn-secondary btn-sm" id="leadsFilterBtn">Filtrar</button>
          </div>
          <div class="leads-groups-wrap">
            <span class="leads-groups-label">Ver:</span>
            <button type="button" class="btn btn-outline btn-sm leads-group-btn active" data-group="todos">Todos</button>
            <button type="button" class="btn btn-outline btn-sm leads-group-btn" data-group="sem_docs">Sem docs</button>
            <button type="button" class="btn btn-outline btn-sm leads-group-btn" data-group="com_docs">Com docs</button>
            <button type="button" class="btn btn-outline btn-sm leads-group-btn" data-group="aprovados">Aprovados</button>
          </div>
        </div>
        <div class="table-wrap card">
          <table>
            <thead>
              <tr id="leadsHeadRow">
                <th>ID</th>
                <th>WhatsApp</th>
                <th>Nome</th>
                <th>Email</th>
                <th>Estado conversa</th>
                <th>Estado docs</th>
                <th>Docs enviados</th>
                <th>Gestora</th>
                <th class="leads-sort-th">Atualizado <span class="sort-icons"><button type="button" id="leadsSortAsc" title="Mais antigo primeiro"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 15l-6-6-6 6"/></svg></button><button type="button" id="leadsSortDesc" title="Mais recente primeiro"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></button></span></th>
                <th></th>
              </tr>
            </thead>
            <tbody id="leadsBody"></tbody>
          </table>
        </div>
      </div>
      <div id="screenRafa" class="screen">
        <h2 class="page-title">Falar com Rafa</h2>
        <p class="text-muted" style="margin-top:-0.5rem;margin-bottom:1.25rem;">Leads que pediram para falar contigo. Abre a conversa no WhatsApp ou devolve o lead a aguardar escolha.</p>
        <div class="table-wrap card">
          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>WhatsApp</th>
                <th>Email</th>
                <th>Atualizado</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="rafaBody"></tbody>
          </table>
        </div>
      </div>
      <div id="screenDuvidasPendentes" class="screen">
        <h2 class="page-title">Perguntas pendentes</h2>
        <p class="text-muted" style="margin-top:-0.5rem; margin-bottom:1rem;">Perguntas dos leads sem resposta no FAQ. Responda para criar a pergunta no FAQ e enviar ao lead.</p>
        <div class="section-toolbar">
          <div class="leads-filter-wrap">
            <div class="filter-input-wrap">
              <input type="text" id="duvidasPendentesFilterInput" placeholder="Filtrar por palavra...">
              <button type="button" class="filter-clear-btn" id="duvidasPendentesFilterClear" title="Limpar filtro">×</button>
            </div>
            <button type="button" class="btn btn-secondary btn-sm" id="duvidasPendentesFilterBtn">Filtrar</button>
          </div>
          <button type="button" class="btn btn-primary btn-sm" id="btnNovaDuvida" style="display:none;">Nova pergunta</button>
        </div>
        <div class="card">
          <div class="table-wrap">
            <table id="tblDuvidasPendentes">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Pergunta do lead</th>
                  <th class="th-contacto">Contacto</th>
                  <th>Data</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="duvidasPendentesBody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="screenDuvidasRespondidas" class="screen">
        <h2 class="page-title">FAQ</h2>
        <p class="text-muted" style="margin-top:-0.5rem; margin-bottom:1rem;">Ordenadas por frequência (mais perguntadas primeiro). Clique para ver respostas e adicionar ou editar a sua.</p>
        <div class="section-toolbar" style="margin-bottom:0.75rem;">
          <div class="leads-filter-wrap">
            <div class="filter-input-wrap">
              <input type="text" id="faqFilterInput" placeholder="Filtrar por palavra...">
              <button type="button" class="filter-clear-btn" id="faqFilterClear" title="Limpar filtro">×</button>
            </div>
            <button type="button" class="btn btn-secondary btn-sm" id="faqFilterBtn">Filtrar</button>
          </div>
          <div></div>
        </div>
        <div class="card">
          <div class="table-wrap">
            <table id="tblPerguntasRespondidas">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Pergunta</th>
                  <th>Frequencia</th>
                  <th>Respostas</th>
                  <th class="th-acoes-admin">Ações (admin)</th>
                </tr>
              </thead>
              <tbody id="perguntasBody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="screenGestoras" class="screen">
        <div class="toolbar">
          <h2 class="page-title" style="margin:0;">Gestoras de crédito</h2>
          <button type="button" class="btn btn-primary" id="btnNovaGestora">Nova gestora</button>
        </div>
        <div class="table-wrap card">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>Email (pessoal)</th>
                <th>Email para leads</th>
                <th>WhatsApp</th>
                <th>Ativo</th>
                <th>Total</th>
                <th>Aguard. docs</th>
                <th>Docs enviados</th>
                <th>Créd. aprov.</th>
                <th>Agend. escrit.</th>
                <th>Escrit. realiz.</th>
                <th>Inviável</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="gestorasBody"></tbody>
          </table>
        </div>
      </div>
      <div id="screenPerfil" class="screen">
        <h2 class="page-title" style="width:100%;">Perfil</h2>
        <div class="card" style="max-width:480px;width:100%;padding:1.5rem;margin-right:auto;">
          <form id="profileForm">
            <label>Nome</label>
            <input type="text" id="profileNome" readonly disabled style="background:var(--bg);color:var(--text-muted);">
            <label>Email</label>
            <input type="text" id="profileEmail" readonly disabled style="background:var(--bg);color:var(--text-muted);">
            <label>Email para leads</label>
            <input type="email" id="profileEmailParaLeads" placeholder="leads@exemplo.pt" autocomplete="email">
            <p class="text-muted" style="font-size:0.8125rem;margin-top:-0.5rem;margin-bottom:1rem;">Para onde enviamos os documentos dos seus leads.</p>
            <label>WhatsApp (com indicativo, ex: 351912345678)</label>
            <input type="text" id="profileWhatsapp" placeholder="desabilitado">
            <p class="text-muted" style="font-size:0.8125rem;margin-top:-0.5rem;margin-bottom:1rem;">Os seus leads terão acesso a este número. Deixe em branco se não quiser ser contactada por WhatsApp.</p>
            <label>Foto de perfil (URL da imagem, opcional)</label>
            <input type="text" id="profileFotoPerfil" placeholder="https://exemplo.com/foto.jpg">
            <p class="text-muted" style="font-size:0.8125rem;margin-top:-0.5rem;margin-bottom:1rem;">Esta imagem será mostrada aos leads atribuídos a si na página de envio de documentos.</p>
            <label>Mensagem de boas-vindas (curta)</label>
            <textarea id="profileBoasVindas" rows="3" placeholder="Ex.: Olá, sou a sua gestora de crédito habitação e vou acompanhar o seu processo."></textarea>
            <p class="text-muted" style="font-size:0.8125rem;margin-top:-0.5rem;margin-bottom:1rem;">Este texto curto será exibido como mensagem de boas-vindas para os leads atribuídos a si, após confirmarem o email.</p>
            <hr style="border:none;border-top:1px solid var(--border);margin:1.25rem 0;">
            <div id="profilePasswordSection">
              <button type="button" id="profileBtnAlterarPassword" class="btn btn-outline">Alterar palavra-passe</button>
              <div id="profilePasswordArea" style="display:none;">
                <label style="margin-top:1rem;">Palavra-passe atual</label>
                <input type="password" id="profileCurrentPassword" placeholder="Palavra-passe atual" autocomplete="current-password">
                <label>Nova palavra-passe (mín. 6 caracteres)</label>
                <input type="password" id="profileNewPassword" placeholder="Nova palavra-passe" autocomplete="new-password">
                <label>Confirmar nova palavra-passe</label>
                <input type="password" id="profileNewPasswordConfirm" placeholder="Confirmar" autocomplete="new-password">
                <button type="button" id="profilePasswordCancelar" class="btn btn-outline btn-sm" style="margin-top:0.5rem;">Cancelar</button>
              </div>
            </div>
            <hr style="border:none;border-top:1px solid var(--border);margin:1.25rem 0;">
            <label>Seu documento RGPD (PDF)</label>
            <div id="profileRgpdEnviado" style="display:none;">
              <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap;">
                <img src="documento.png" alt="" style="max-height:64px;height:auto;">
                <div class="actions" style="margin:0;">
                  <a href="#" id="profileRgpdVer" target="_blank" rel="noopener" class="btn btn-outline">Ver</a>
                  <button type="button" id="profileRgpdSubstituir" class="btn btn-outline">Substituir</button>
                </div>
              </div>
            </div>
            <div id="profileRgpdNaoEnviado" style="display:none;">
              <p class="profile-rgpd-alert" style="font-size:0.875rem;margin-bottom:0.5rem;color:var(--error);display:flex;align-items:center;gap:0.5rem;">
                <span style="flex-shrink:0;" aria-hidden="true">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                </span>
                Ainda não enviou nenhum documento. Suba um PDF.
              </p>
              <input type="file" id="profileRgpd" accept=".pdf">
              <p id="profileRgpdPreview" style="display:none;margin:0.75rem 0 0 0;"><img src="documento.png" alt="" style="max-height:64px;height:auto;vertical-align:middle;"></p>
            </div>
            <div id="profileRgpdSubstituirArea" style="display:none;">
              <p class="text-muted" style="font-size:0.875rem;margin-bottom:0.5rem;">Escolha um novo ficheiro PDF para substituir o atual.</p>
              <input type="file" id="profileRgpdSubstituirInput" accept=".pdf">
              <p id="profileRgpdSubstituirPreview" style="display:none;margin:0.75rem 0 0 0;"><img src="documento.png" alt="" style="max-height:64px;height:auto;vertical-align:middle;"></p>
              <button type="button" id="profileRgpdSubstituirCancelar" class="btn btn-outline btn-sm" style="margin-top:0.5rem;">Cancelar</button>
            </div>
            <p id="profileError" class="error-msg" style="display:none;margin-top:0.5rem;"></p>
            <p id="profileSuccess" class="text-muted" style="display:none;margin-top:0.5rem;"></p>
            <div style="margin-top:1.25rem;display:flex;justify-content:flex-end;">
              <button type="submit" class="btn btn-primary">Guardar alterações</button>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>

  <div id="modalLeadEstadoDocs" class="modal-overlay">
    <div class="modal">
      <h3>Alterar estado docs</h3>
      <input type="hidden" id="editLeadEstadoDocsLeadId">
      <label for="editLeadEstadoDocsSelect">Estado docs</label>
      <select id="editLeadEstadoDocsSelect"></select>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" id="modalLeadEstadoDocsCancel">Cancelar</button>
        <button type="button" class="btn btn-primary" id="modalLeadEstadoDocsSave">Guardar</button>
      </div>
    </div>
  </div>

  <div id="modalLead" class="modal-overlay">
    <div class="modal">
      <h3>Editar lead</h3>
      <input type="hidden" id="editLeadId">
      <label>Nome</label>
      <input type="text" id="editLeadNome">
      <label>Email</label>
      <input type="email" id="editLeadEmail">
      <label>Estado conversa</label>
      <select id="editLeadEstadoConversa">
        <option value="aguardando_escolha">aguardando_escolha</option>
        <option value="com_joana">com_joana</option>
        <option value="com_gestora">com_gestora</option>
        <option value="com_rafa">com_rafa</option>
      </select>
      <label>Estado docs</label>
      <select id="editLeadEstadoDocs">
        <option value="aguardando_docs">aguardando_docs</option>
        <option value="sem_docs">sem_docs</option>
        <option value="docs_enviados">docs_enviados</option>
        <option value="inviavel">inviavel</option>
        <option value="credito_aprovado">credito_aprovado</option>
        <option value="agendado_escritura">agendado_escritura</option>
        <option value="escritura_realizada">escritura_realizada</option>
      </select>
      <div id="editLeadGestoraRow">
        <label>Gestora ID</label>
        <input type="number" id="editLeadGestoraId" min="0" placeholder="vazio">
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" id="modalLeadCancel">Cancelar</button>
        <button type="button" class="btn btn-primary" id="modalLeadSave">Guardar</button>
      </div>
    </div>
  </div>

  <div id="modalGestora" class="modal-overlay">
    <div class="modal">
      <h3 id="modalGestoraTitle">Nova gestora</h3>
      <input type="hidden" id="editGestoraId">
      <label>Nome</label>
      <input type="text" id="editGestoraNome" required>
      <label>Email (pessoal – login)</label>
      <input type="email" id="editGestoraEmail" required placeholder="email@exemplo.pt">
      <label>Email para leads (opcional – para onde enviamos os docs; se vazio, usa o email pessoal)</label>
      <input type="email" id="editGestoraEmailParaLeads" placeholder="leads@exemplo.pt">
      <label>WhatsApp (com indicativo, ex: 351912345678)</label>
      <input type="text" id="editGestoraWhatsapp" required placeholder="351912345678">
      <label><input type="checkbox" id="editGestoraAtivo" checked> Ativa</label>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" id="modalGestoraCancel">Cancelar</button>
        <button type="button" class="btn btn-primary" id="modalGestoraSave">Guardar</button>
      </div>
    </div>
  </div>

  <div id="modalEditarPergunta" class="modal-overlay">
    <div class="modal" style="max-width:560px;">
      <h3 id="modalEditarPerguntaTitle">Editar pergunta</h3>
      <label for="modalEditarPerguntaTexto">Texto da pergunta</label>
      <textarea id="modalEditarPerguntaTexto" rows="4" placeholder="Texto da pergunta..."></textarea>
      <p class="text-muted" style="font-size:0.8125rem; margin-top:0.25rem;">Ao guardar, o vetor de busca será atualizado para o novo texto.</p>
      <div class="modal-actions" style="margin-top:1rem;">
        <button type="button" class="btn btn-secondary" id="modalEditarPerguntaCancel">Cancelar</button>
        <button type="button" class="btn btn-primary" id="modalEditarPerguntaSave">Guardar</button>
      </div>
    </div>
  </div>

  <div id="modalPergunta" class="modal-overlay">
    <div class="modal" style="max-width:560px;">
      <h3 id="modalPerguntaTitle">Pergunta</h3>
      <p id="modalPerguntaTexto" class="text-muted" style="white-space:pre-wrap;margin-bottom:1rem;"></p>
      <p class="text-muted" style="font-size:0.8125rem;margin-bottom:0.5rem;"><strong>Respostas das gestoras:</strong></p>
      <div id="modalPerguntaRespostas" style="margin-bottom:1rem;"></div>
      <div id="modalPerguntaMinhaRespostaWrap" style="display:none;">
        <label for="modalPerguntaMinhaResposta">A sua resposta</label>
        <textarea id="modalPerguntaMinhaResposta" rows="4" placeholder="Escreva ou edite a sua opinião..." style="width:100%; box-sizing:border-box;"></textarea>
        <div class="modal-actions" style="margin-top:1rem;">
          <button type="button" class="btn btn-secondary" id="modalPerguntaCancel">Cancelar</button>
          <button type="button" class="btn btn-primary" id="modalPerguntaSave">Guardar resposta</button>
        </div>
      </div>
      <div id="modalPerguntaAdminActions" style="display:none; margin-top:1rem;">
        <button type="button" class="btn btn-secondary" id="modalPerguntaClose">Fechar</button>
      </div>
    </div>
  </div>

  <div id="modalVerDuvida" class="modal-overlay">
    <div class="modal" style="max-width:560px;">
      <h3>Pergunta completa</h3>
      <p id="modalVerDuvidaTexto" class="text-muted" style="white-space:pre-wrap;margin-bottom:1rem;"></p>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" id="modalVerDuvidaFechar">Fechar</button>
      </div>
    </div>
  </div>

  <div id="modalEditarDuvida" class="modal-overlay">
    <div class="modal" style="max-width:560px;">
      <h3 id="modalEditarDuvidaTitle">Editar dúvida pendente</h3>
      <label for="modalEditarDuvidaTexto">Texto da dúvida</label>
      <textarea id="modalEditarDuvidaTexto" rows="4" placeholder="Texto da dúvida..." style="width:100%; box-sizing:border-box;"></textarea>
      <div class="modal-actions" style="margin-top:1rem;">
        <button type="button" class="btn btn-secondary" id="modalEditarDuvidaCancel">Cancelar</button>
        <button type="button" class="btn btn-primary" id="modalEditarDuvidaSave">Guardar</button>
      </div>
    </div>
  </div>

  <div id="modalDuvidaResponder" class="modal-overlay">
    <div class="modal" style="max-width:520px;">
      <h3>Responder dúvida pendente</h3>
      <p id="modalDuvidaTexto" class="text-muted" style="white-space:pre-wrap;margin-bottom:1rem;"></p>
      <label for="modalDuvidaRespostaTexto">A sua resposta (será enviada ao lead e criará a pergunta no FAQ)</label>
      <textarea id="modalDuvidaRespostaTexto" rows="5" placeholder="Escreva a resposta..." style="width:100%; box-sizing:border-box;"></textarea>
      <div class="modal-actions" style="margin-top:1rem;">
        <button type="button" class="btn btn-secondary" id="modalDuvidaResponderCancel">Cancelar</button>
        <button type="button" class="btn btn-primary" id="modalDuvidaResponderSubmit">Enviar resposta</button>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const API = '/api/dashboard';
      let user = null;

      function hashToScreenId(hash) {
        var map = { gestoras: 'gestoras', rafa: 'rafa', perfil: 'perfil', 'duvidas-pendentes': 'duvidasPendentes', 'duvidas-respondidas': 'duvidasRespondidas' };
        return map[hash] || 'leads';
      }
      function showScreen(id) {
        document.querySelectorAll('.main .screen').forEach((s) => s.classList.remove('visible'));
        document.querySelectorAll('.sidebar-nav-item').forEach((el) => el.classList.remove('active'));
        const s = document.getElementById('screen' + id.charAt(0).toUpperCase() + id.slice(1));
        const a = document.getElementById('nav' + id.charAt(0).toUpperCase() + id.slice(1));
        if (s) s.classList.add('visible');
        if (a) a.classList.add('active');
        if (id === 'leads') loadLeads();
        if (id === 'gestoras') loadGestoras();
        if (id === 'rafa') loadRafa();
        if (id === 'perfil') loadProfile();
        if (id === 'duvidasPendentes') loadDuvidasPendentes();
        if (id === 'duvidasRespondidas') loadDuvidasRespondidas();
      }

      function updateRafaBadge() {
        fetch(API + '/leads/rafa/count', { credentials: 'include' })
          .then((r) => (r.ok ? r.json() : { count: 0 }))
          .then((data) => {
            const badge = document.getElementById('navRafaBadge');
            const n = data.count || 0;
            badge.textContent = n > 99 ? '99+' : String(n);
            badge.classList.toggle('hidden', n === 0);
          })
          .catch(() => {
            document.getElementById('navRafaBadge').classList.add('hidden');
          });
      }

      function updateDuvidasPendentesBadge(count) {
        const badge = document.getElementById('navDuvidasPendentesBadge');
        if (!badge) return;
        if (typeof count === 'number') {
          badge.textContent = count > 99 ? '99+' : String(count);
          badge.classList.toggle('hidden', count === 0);
          return;
        }
        fetch(API + '/duvidas-pendentes/count', { credentials: 'include' })
          .then((r) => (r.ok ? r.json() : { count: 0 }))
          .then((data) => {
            const n = data.count || 0;
            badge.textContent = n > 99 ? '99+' : String(n);
            badge.classList.toggle('hidden', n === 0);
          })
          .catch(() => { badge.classList.add('hidden'); });
      }

      function checkAuth() {
        return fetch(API + '/me', { credentials: 'include' })
          .then((r) => (r.ok ? r.json() : Promise.reject()));
      }

      function init() {
        checkAuth()
          .then((data) => {
            user = data.user;
            var nameEl = document.getElementById('sidebarUserName');
            if (nameEl) nameEl.textContent = (user.nome && user.nome.trim()) ? user.nome.trim() : (user.email || '');
            document.getElementById('loginScreen').classList.remove('visible');
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('resetPasswordScreen').style.display = 'none';
            document.getElementById('dashboardApp').classList.add('visible');
            document.getElementById('dashboardApp').style.display = 'flex';
            if (user.role === 'admin') {
              updateRafaBadge();
              document.getElementById('navRafa').style.display = '';
              document.getElementById('navGestoras').style.display = '';
              document.getElementById('navPerfil').style.display = 'none';
            } else {
              document.getElementById('navRafa').style.display = 'none';
              document.getElementById('navGestoras').style.display = 'none';
              document.getElementById('navPerfil').style.display = '';
            }
            updateDuvidasPendentesBadge();
            document.getElementById('navDuvidasPendentes').style.display = '';
            document.getElementById('navDuvidasRespondidas').style.display = '';
            const hashRaw = (window.location.hash || '#leads').slice(1).split('?')[0] || 'leads';
            const hash = (hashRaw === 'duvidas' || hashRaw === 'duvidas-spam') ? 'duvidas-pendentes' : hashRaw;
            const screenId = hashToScreenId(hash);
            if (hash !== hashRaw && hashRaw === 'duvidas') window.location.hash = 'duvidas-pendentes';
            showScreen(screenId);
          })
          .catch(() => {
            tryShowResetPassword();
            if (!window.resetPasswordToken) {
              document.getElementById('loginScreen').classList.add('visible');
              document.getElementById('loginScreen').style.display = 'block';
            }
            document.getElementById('dashboardApp').classList.remove('visible');
            document.getElementById('dashboardApp').style.display = 'none';
          });
      }

      function tryShowResetPassword() {
        const hash = (window.location.hash || '').slice(1);
        const parts = hash.split('?');
        const page = parts[0];
        const params = {};
        if (parts[1]) parts[1].split('&').forEach(function (p) {
          const kv = p.split('=');
          if (kv[0]) params[kv[0]] = decodeURIComponent(kv[1] || '');
        });
        if (page === 'reset-password' && params.token) {
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('resetPasswordScreen').style.display = 'block';
          document.getElementById('resetPasswordScreen').classList.add('visible');
          window.resetPasswordToken = params.token;
        }
      }

      document.getElementById('btnPerdiSenha').addEventListener('click', function () {
        document.getElementById('loginFormWrap').style.display = 'none';
        document.getElementById('forgotPasswordWrap').style.display = 'block';
        document.getElementById('forgotSuccess').style.display = 'none';
        document.getElementById('forgotError').style.display = 'none';
      });
      document.getElementById('btnVoltarLogin').addEventListener('click', function () {
        document.getElementById('forgotPasswordWrap').style.display = 'none';
        document.getElementById('loginFormWrap').style.display = 'block';
      });
      document.getElementById('forgotPasswordForm').addEventListener('submit', function (e) {
        e.preventDefault();
        var errEl = document.getElementById('forgotError');
        var okEl = document.getElementById('forgotSuccess');
        errEl.style.display = 'none';
        okEl.style.display = 'none';
        fetch(API + '/forgot-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ email: document.getElementById('forgotEmail').value.trim().toLowerCase() }),
        })
          .then(function (r) { return r.json(); })
          .then(function (d) {
            okEl.textContent = d.message || 'Se existir uma conta com este email, receberá um link para redefinir a palavra-passe.';
            okEl.style.display = 'block';
          })
          .catch(function () {
            errEl.textContent = 'Erro ao enviar. Tente novamente.';
            errEl.style.display = 'block';
          });
      });
      document.getElementById('resetPasswordForm').addEventListener('submit', function (e) {
        e.preventDefault();
        var p1 = document.getElementById('resetPassword').value;
        var p2 = document.getElementById('resetPasswordConfirm').value;
        var errEl = document.getElementById('resetError');
        var okEl = document.getElementById('resetSuccess');
        errEl.style.display = 'none';
        okEl.style.display = 'none';
        if (p1 !== p2) {
          errEl.textContent = 'As palavras-passe não coincidem.';
          errEl.style.display = 'block';
          return;
        }
        if (p1.length < 6) {
          errEl.textContent = 'A palavra-passe deve ter pelo menos 6 caracteres.';
          errEl.style.display = 'block';
          return;
        }
        var token = window.resetPasswordToken || (function () {
          var h = (window.location.hash || '').slice(1).split('?')[1] || '';
          var p = h.split('&').find(function (x) { return x.indexOf('token=') === 0; });
          return p ? decodeURIComponent(p.replace('token=', '')) : '';
        })();
        if (!token) {
          errEl.textContent = 'Link inválido ou expirado. Peça um novo em «Perdi a senha».';
          errEl.style.display = 'block';
          return;
        }
        fetch(API + '/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ token: token, password: p1 }),
        })
          .then(function (r) { return r.json().then(function (d) { return r.ok ? d : Promise.reject(d); }); })
          .then(function (d) {
            okEl.textContent = d.message || 'Palavra-passe alterada. Pode fazer login.';
            okEl.style.display = 'block';
            window.resetPasswordToken = null;
            window.location.hash = '';
          })
          .catch(function (d) {
            errEl.textContent = (d && d.message) || 'Erro. Tente novamente ou peça um novo link.';
            errEl.style.display = 'block';
          });
      });

      document.getElementById('loginForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const err = document.getElementById('loginError');
        err.style.display = 'none';
        fetch(API + '/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            email: document.getElementById('loginEmail').value.trim(),
            password: document.getElementById('loginPassword').value,
          }),
        })
          .then((r) => {
            if (r.ok) return r.json();
            return r.json().then((d) => Promise.reject(new Error(d.message || 'Erro no login')));
          })
          .then(() => init())
          .catch((msg) => {
            err.textContent = msg.message || String(msg);
            err.style.display = 'block';
          });
      });

      document.getElementById('btnLogout').addEventListener('click', function () {
        fetch(API + '/logout', { method: 'POST', credentials: 'include' }).then(() => {
          window.location.href = '/';
        });
      });

      var dashboardApp = document.getElementById('dashboardApp');
      document.getElementById('btnMenuToggle').addEventListener('click', function () {
        dashboardApp.classList.toggle('nav-open');
      });
      document.getElementById('sidebarOverlay').addEventListener('click', function () {
        dashboardApp.classList.remove('nav-open');
      });

      window.addEventListener('hashchange', function () {
        if (!user) return;
        dashboardApp.classList.remove('nav-open');
        const hashRaw = (window.location.hash || '#leads').slice(1).split('?')[0] || 'leads';
        const hash = (hashRaw === 'duvidas' || hashRaw === 'duvidas-spam') ? 'duvidas-pendentes' : hashRaw;
        if (hash !== hashRaw) window.location.hash = 'duvidas-pendentes';
        const screenId = hashToScreenId(hash);
        showScreen(screenId);
      });

      var ESTADO_DOCS_OPCOES = ['aguardando_docs', 'sem_docs', 'docs_enviados', 'inviavel', 'credito_aprovado', 'agendado_escritura', 'escritura_realizada'];
      var _leadsRows = [];
      var _leadsSort = '';
      var _leadsGroup = 'todos'; // todos | sem_docs | com_docs | aprovados
      var _duvidasPendentesRows = [];
      var _faqRows = [];

      function leadBadgeClass(prefix, value) {
        if (!value || typeof value !== 'string') return 'lead-badge lead-badge--neutral';
        var safe = String(value).trim().replace(/\s/g, '_');
        if (!safe) return 'lead-badge lead-badge--neutral';
        return 'lead-badge lead-badge--' + prefix + '-' + safe;
      }

      function renderLeads() {
        const tbody = document.getElementById('leadsBody');
        const isGestora = user && user.role === 'gestora';
        const colCount = isGestora ? 7 : 10;
        var rows = _leadsRows.slice();

        // Agrupamento por estado_docs
        if (_leadsGroup === 'sem_docs') {
          rows = rows.filter(function (r) {
            return r.estado_docs === 'sem_docs' || r.estado_docs === 'aguardando_docs';
          });
        } else if (_leadsGroup === 'com_docs') {
          rows = rows.filter(function (r) {
            return r.estado_docs === 'docs_enviados' || r.estado_docs === 'inviavel';
          });
        } else if (_leadsGroup === 'aprovados') {
          rows = rows.filter(function (r) {
            return r.estado_docs === 'credito_aprovado' ||
              r.estado_docs === 'agendado_escritura' ||
              r.estado_docs === 'escritura_realizada';
          });
        }
        var filterVal = (document.getElementById('leadsFilterInput') && document.getElementById('leadsFilterInput').value) ? document.getElementById('leadsFilterInput').value.trim().toLowerCase() : '';
        if (filterVal) {
          rows = rows.filter(function (r) {
            var text = [r.id, r.whatsapp_number, r.nome, r.email, r.estado_conversa, r.estado_docs, r.gestora_nome, formatDate(r.updated_at)].join(' ').toLowerCase();
            return text.indexOf(filterVal) !== -1;
          });
        }
        if (_leadsSort === 'asc' || _leadsSort === 'desc') {
          rows.sort(function (a, b) {
            var ta = a.updated_at ? new Date(a.updated_at).getTime() : 0;
            var tb = b.updated_at ? new Date(b.updated_at).getTime() : 0;
            return _leadsSort === 'asc' ? ta - tb : tb - ta;
          });
        }
        tbody.innerHTML = '';
        if (!rows.length) {
          tbody.innerHTML = '<tr><td colspan="' + colCount + '">' + (filterVal ? 'Nenhum lead corresponde ao filtro.' : 'Nenhum lead.') + '</td></tr>';
          return;
        }
        rows.forEach(function (r) {
          const tr = document.createElement('tr');
          if (isGestora) {
            var num = (r.whatsapp_number || '').replace(/\D/g, '');
            var waUrl = num ? 'https://wa.me/' + num : '#';
            var waBtn = num ? '<a href="' + waUrl + '" target="_blank" rel="noopener noreferrer" class="btn btn-whatsapp btn-sm">WhatsApp</a>' : '<span class="text-muted">—</span>';
            var editBtn = '<button type="button" class="btn btn-secondary btn-sm btn-edit-lead-estado-docs" data-id="' + r.id + '">Editar</button>';
            var docsVal = r.estado_docs || '';
            var docsBadge = '<span class="' + leadBadgeClass('docs', docsVal) + '">' + escapeHtml(docsVal || '—') + '</span>';
            tr.innerHTML =
              '<td>' + r.id + '</td><td>' + escapeHtml(formatDate(r.updated_at)) +
              '</td><td>' + escapeHtml(r.whatsapp_number || '') +
              '</td><td>' + escapeHtml(r.nome || '') +
              '</td><td>' + escapeHtml(r.email || '') +
              '</td><td>' + docsBadge + '</td><td class="actions">' + waBtn + ' ' + editBtn + '</td>';
          } else {
            var convVal = r.estado_conversa || '';
            var docsVal = r.estado_docs || '';
            var convBadge = '<span class="' + leadBadgeClass('conv', convVal) + '">' + escapeHtml(convVal || '—') + '</span>';
            var docsBadge = '<span class="' + leadBadgeClass('docs', docsVal) + '">' + escapeHtml(docsVal || '—') + '</span>';
            tr.innerHTML =
              '<td>' + r.id + '</td><td>' +
              escapeHtml(r.whatsapp_number || '') + '</td><td>' + escapeHtml(r.nome || '') + '</td><td>' + escapeHtml(r.email || '') +
              '</td><td>' + convBadge + '</td><td>' + docsBadge + '</td>' +
              '<td>' + (r.docs_enviados ? 'Sim' : 'Não') + '</td><td>' + escapeHtml(r.gestora_nome || '—') +
              '</td><td>' + escapeHtml(formatDate(r.updated_at)) +
              '</td><td class="actions">' +
              '<button type="button" class="btn btn-secondary btn-sm btn-edit-lead" data-id="' + r.id + '">Editar</button>' +
              '<button type="button" class="btn btn-danger btn-sm btn-delete-lead" data-id="' + r.id + '">Apagar</button>' +
              '</td>';
          }
          tbody.appendChild(tr);
        });
        if (isGestora) {
          tbody.querySelectorAll('.btn-edit-lead-estado-docs').forEach(function (btn) {
            btn.addEventListener('click', function () {
              var id = parseInt(this.dataset.id, 10);
              var lead = _leadsRows.find(function (x) { return x.id === id; });
              if (!lead) return;
              openEditLeadEstadoDocs(lead);
            });
          });
        } else {
          tbody.querySelectorAll('.btn-edit-lead').forEach(function (b) {
            b.addEventListener('click', function () {
              openEditLead(_leadsRows.find(function (x) { return x.id === parseInt(this.dataset.id, 10); }.bind(this)));
            });
          });
          tbody.querySelectorAll('.btn-delete-lead').forEach(function (b) {
            b.addEventListener('click', function () {
              if (confirm('Apagar este lead?')) deleteLead(this.dataset.id);
            });
          });
        }
      }

      function loadLeads() {
        const tbody = document.getElementById('leadsBody');
        const isGestora = user && user.role === 'gestora';
        const colCount = isGestora ? 7 : 10;
        const headRow = document.getElementById('leadsHeadRow');
        const toolbarEl = document.getElementById('leadsToolbar');
        var sortThHtml = '<th class="leads-sort-th">Atualizado <span class="sort-icons"><button type="button" id="leadsSortAsc" title="Mais antigo primeiro"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 15l-6-6-6 6"/></svg></button><button type="button" id="leadsSortDesc" title="Mais recente primeiro"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></button></span></th>';
        if (headRow) {
          headRow.innerHTML = isGestora
            ? '<th>ID</th><th>Atualizado</th><th>WhatsApp</th><th>Nome</th><th>Email</th><th>Estado docs</th><th></th>'
            : '<th>ID</th><th>WhatsApp</th><th>Nome</th><th>Email</th><th>Estado conversa</th><th>Estado docs</th><th>Docs enviados</th><th>Gestora</th>' + sortThHtml + '<th></th>';
        }
        // Toolbar (filtro + grupos) disponível para admin e gestora
        if (toolbarEl) toolbarEl.style.display = 'flex';
        tbody.innerHTML = '<tr><td colspan="' + colCount + '">A carregar…</td></tr>';
        fetch(API + '/leads', { credentials: 'include' })
          .then((r) => r.json().then((data) => (r.ok ? data : Promise.reject(data))))
          .then((rows) => {
            _leadsRows = rows || [];
            renderLeads();
            if (!isGestora) {
              var sortAsc = document.getElementById('leadsSortAsc');
              var sortDesc = document.getElementById('leadsSortDesc');
              if (sortAsc) {
                sortAsc.onclick = function () {
                  _leadsSort = _leadsSort === 'asc' ? '' : 'asc';
                  sortAsc.classList.toggle('active', _leadsSort === 'asc');
                  if (sortDesc) sortDesc.classList.toggle('active', _leadsSort === 'desc');
                  renderLeads();
                };
                sortAsc.classList.toggle('active', _leadsSort === 'asc');
              }
              if (sortDesc) {
                sortDesc.onclick = function () {
                  _leadsSort = _leadsSort === 'desc' ? '' : 'desc';
                  sortDesc.classList.toggle('active', _leadsSort === 'desc');
                  if (sortAsc) sortAsc.classList.toggle('active', _leadsSort === 'asc');
                  renderLeads();
                };
                sortDesc.classList.toggle('active', _leadsSort === 'desc');
              }
            }
          })
          .catch((err) => {
            const msg = (err && (err.detail || err.message)) || 'Erro ao carregar.';
            tbody.innerHTML = '<tr><td colspan="' + colCount + '" class="error-msg">' + escapeHtml(msg) + '</td></tr>';
          });
      }

      (function initLeadsFilter() {
        var input = document.getElementById('leadsFilterInput');
        var btn = document.getElementById('leadsFilterBtn');
        var clearBtn = document.getElementById('leadsFilterClear');
        if (btn) btn.addEventListener('click', function () { if (_leadsRows.length) renderLeads(); });
        if (input) input.addEventListener('keydown', function (e) { if (e.key === 'Enter') { e.preventDefault(); if (_leadsRows.length) renderLeads(); } });
        if (clearBtn) clearBtn.addEventListener('click', function () {
          if (!input) return;
          input.value = '';
          if (_leadsRows.length) renderLeads();
        });
      })();

      (function initDuvidasPendentesFilter() {
        var input = document.getElementById('duvidasPendentesFilterInput');
        var btn = document.getElementById('duvidasPendentesFilterBtn');
        var clearBtn = document.getElementById('duvidasPendentesFilterClear');
        if (!input || !btn) return;
        btn.addEventListener('click', function () {
          if (_duvidasPendentesRows.length) loadDuvidasPendentes();
        });
        input.addEventListener('keydown', function (e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            if (_duvidasPendentesRows.length) loadDuvidasPendentes();
          }
        });
        if (clearBtn) clearBtn.addEventListener('click', function () {
          input.value = '';
          if (_duvidasPendentesRows.length) loadDuvidasPendentes();
        });
      })();

      (function initFaqFilter() {
        var input = document.getElementById('faqFilterInput');
        var btn = document.getElementById('faqFilterBtn');
        var clearBtn = document.getElementById('faqFilterClear');
        if (!input || !btn) return;
        btn.addEventListener('click', function () {
          if (_faqRows.length) loadDuvidasRespondidas();
        });
        input.addEventListener('keydown', function (e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            if (_faqRows.length) loadDuvidasRespondidas();
          }
        });
        if (clearBtn) clearBtn.addEventListener('click', function () {
          input.value = '';
          if (_faqRows.length) loadDuvidasRespondidas();
        });
      })();

      (function initLeadsGroups() {
        var groupButtons = document.querySelectorAll('.leads-group-btn');
        if (!groupButtons || !groupButtons.length) return;
        groupButtons.forEach(function (btn) {
          btn.addEventListener('click', function () {
            var group = this.getAttribute('data-group') || 'todos';
            _leadsGroup = group;
            groupButtons.forEach(function (b) {
              b.classList.toggle('active', b === btn);
            });
            if (_leadsRows.length) renderLeads();
          });
        });
      })();

      var _perguntaModalId = null;
      var _duvidaModalId = null;

      function loadDuvidasPendentes() {
        const duvidasBody = document.getElementById('duvidasPendentesBody');
        if (!duvidasBody) return;
        duvidasBody.innerHTML = '<tr><td colspan="5">A carregar…</td></tr>';
        var tblDuvidas = document.getElementById('tblDuvidasPendentes');
        if (tblDuvidas) { tblDuvidas.classList.remove('role-admin', 'role-gestora'); tblDuvidas.classList.add(user && user.role === 'admin' ? 'role-admin' : 'role-gestora'); }
        fetch(API + '/duvidas-pendentes', { credentials: 'include' })
          .then(function (r) { return r.ok ? r.json() : []; })
          .then(function (duvidas) {
            _duvidasPendentesRows = duvidas || [];
            var rows = _duvidasPendentesRows.slice();
            var filterVal = (document.getElementById('duvidasPendentesFilterInput') && document.getElementById('duvidasPendentesFilterInput').value)
              ? document.getElementById('duvidasPendentesFilterInput').value.trim().toLowerCase()
              : '';
            if (filterVal) {
              rows = rows.filter(function (d) {
                var text = [d.id, d.texto, d.contacto_whatsapp, d.lead_nome, formatDate(d.created_at)].join(' ').toLowerCase();
                return text.indexOf(filterVal) !== -1;
              });
            }
            updateDuvidasPendentesBadge(duvidas.length);
            duvidasBody.innerHTML = '';
            if (!rows.length) {
              duvidasBody.innerHTML = '<tr><td colspan="5">Nenhuma dúvida pendente.</td></tr>';
            } else {
              rows.forEach(function (d) {
                const tr = document.createElement('tr');
                const textoDuvida = (d.texto || '').trim();
                const isAdmin = user && user.role === 'admin';
                const isGestora = user && user.role === 'gestora';
                const btn = isGestora
                  ? '<button type="button" class="btn btn-primary btn-sm btn-responder-duvida" data-id="' + d.id + '">Responder</button>'
                  : '';
                const verBtn = isAdmin ? '<button type="button" class="btn btn-secondary btn-sm btn-ver-duvida" data-id="' + d.id + '">Ver</button> ' : '';
                const editarBtn = isAdmin ? '<button type="button" class="btn btn-outline btn-sm btn-editar-duvida" data-id="' + d.id + '">Editar</button> ' : '';
                const acoesAdmin = isAdmin
                  ? verBtn + editarBtn + '<button type="button" class="btn btn-danger btn-sm btn-excluir-duvida" data-id="' + d.id + '">Excluir</button>'
                  : '';
                tr.innerHTML =
                  '<td>' + d.id + '</td><td class="cell-pergunta" title="' + escapeHtml(textoDuvida) + '">' + escapeHtml(textoDuvida) + '</td><td class="td-contacto">' + escapeHtml(d.contacto_whatsapp || (d.lead_nome || '—')) + '</td><td>' + escapeHtml(formatDate(d.created_at)) + '</td><td>' + (isAdmin ? acoesAdmin : btn) + '</td>';
                duvidasBody.appendChild(tr);
              });
              duvidasBody.querySelectorAll('.btn-responder-duvida').forEach(function (btn) {
                btn.addEventListener('click', function () { openResponderDuvida(parseInt(this.dataset.id, 10)); });
              });
              duvidasBody.querySelectorAll('.btn-ver-duvida').forEach(function (btn) {
                btn.addEventListener('click', function () {
                  var id = parseInt(this.dataset.id, 10);
                  var duvida = _duvidasPendentesRows.find(function (x) { return x.id === id; });
                  if (duvida) openVerDuvida(duvida);
                });
              });
              duvidasBody.querySelectorAll('.btn-editar-duvida').forEach(function (btn) {
                btn.addEventListener('click', function () {
                  var id = parseInt(this.dataset.id, 10);
                  var duvida = _duvidasPendentesRows.find(function (x) { return x.id === id; });
                  if (duvida) openEditarDuvida(duvida);
                });
              });
              duvidasBody.querySelectorAll('.btn-excluir-duvida').forEach(function (btn) {
                btn.addEventListener('click', function () {
                  if (!confirm('Remover esta dúvida pendente da lista? O lead não será notificado.')) return;
                  const id = parseInt(this.dataset.id, 10);
                  fetch(API + '/duvidas-pendentes/' + id, { method: 'DELETE', credentials: 'include' })
                    .then(function (r) { return r.ok ? Promise.resolve() : r.json().then(function (d) { return Promise.reject(new Error(d.message || 'Erro')); }); })
                    .then(function () { loadDuvidasPendentes(); })
                    .catch(function (err) { alert(err.message || 'Erro ao excluir.'); });
                });
              });
            }
            var btnNovaDuvida = document.getElementById('btnNovaDuvida');
            if (btnNovaDuvida) {
              btnNovaDuvida.style.display = user && (user.role === 'admin' || user.role === 'gestora') ? '' : 'none';
              btnNovaDuvida.onclick = function () {
                var texto = prompt('Texto da nova pergunta (será adicionada às dúvidas pendentes para as gestoras responderem):');
                if (texto == null || !texto.trim()) return;
                fetch(API + '/duvidas-pendentes', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'include',
                  body: JSON.stringify({ texto: texto.trim() }),
                })
                  .then(function (r) { return r.ok ? r.json() : r.json().then(function (d) { return Promise.reject(new Error(d.message || 'Erro')); }); })
                  .then(function () { loadDuvidasPendentes(); })
                  .catch(function (err) { alert(err.message || 'Erro ao criar.'); });
              };
            }
          })
          .catch(function () {
            duvidasBody.innerHTML = '<tr><td colspan="5" class="error-msg">Erro ao carregar.</td></tr>';
          });
      }

      function loadDuvidasRespondidas() {
        const perguntasBody = document.getElementById('perguntasBody');
        if (!perguntasBody) return;
        perguntasBody.innerHTML = '<tr><td colspan="5">A carregar…</td></tr>';
        var tblPerguntas = document.getElementById('tblPerguntasRespondidas');
        if (tblPerguntas) { tblPerguntas.classList.remove('role-admin', 'role-gestora'); tblPerguntas.classList.add(user && user.role === 'admin' ? 'role-admin' : 'role-gestora'); }
        fetch(API + '/perguntas', { credentials: 'include' })
          .then(function (r) { return r.ok ? r.json() : []; })
          .then(function (perguntas) {
            _faqRows = perguntas || [];
            var rows = _faqRows.slice();
            var filterVal = (document.getElementById('faqFilterInput') && document.getElementById('faqFilterInput').value)
              ? document.getElementById('faqFilterInput').value.trim().toLowerCase()
              : '';
            if (filterVal) {
              rows = rows.filter(function (p) {
                var text = [p.id, p.texto, p.frequencia, p.num_respostas].join(' ').toLowerCase();
                return text.indexOf(filterVal) !== -1;
              });
            }
            perguntasBody.innerHTML = '';
            if (!rows.length) {
              perguntasBody.innerHTML = '<tr><td colspan="5">Nenhuma pergunta no FAQ.</td></tr>';
            } else {
              rows.forEach(function (p) {
                const tr = document.createElement('tr');
                const textoPergunta = (p.texto || '').trim();
                const jaRespondi = p.ja_respondi ? '<span class="text-muted" style="font-size:0.75rem;">✓ Respondi</span> ' : '';
                const numRespostas = p.num_respostas != null ? Number(p.num_respostas) : 0;
                const isAdmin = user && user.role === 'admin';
                const respostasCell = isAdmin ? String(numRespostas) : jaRespondi + '<button type="button" class="btn btn-secondary btn-sm btn-ver-pergunta" data-id="' + p.id + '">Ver</button>';
                const acoes = isAdmin
                  ? '<button type="button" class="btn btn-secondary btn-sm btn-ver-pergunta" data-id="' + p.id + '">Ver</button> ' +
                    '<button type="button" class="btn btn-outline btn-sm btn-editar-pergunta" data-id="' + p.id + '">Editar</button> ' +
                    '<button type="button" class="btn btn-danger btn-sm btn-excluir-pergunta" data-id="' + p.id + '">Excluir</button>'
                  : '';
                tr.innerHTML =
                  '<td>' + p.id + '</td><td class="cell-pergunta" title="' + escapeHtml(textoPergunta) + '">' + escapeHtml(textoPergunta) + '</td><td>' + (p.frequencia || 0) + '</td><td>' + respostasCell + '</td><td class="td-acoes-admin">' + acoes + '</td>';
                perguntasBody.appendChild(tr);
              });
              perguntasBody.querySelectorAll('.btn-ver-pergunta').forEach(function (btn) {
                btn.addEventListener('click', function () { openPerguntaDetail(parseInt(this.dataset.id, 10)); });
              });
              perguntasBody.querySelectorAll('.btn-editar-pergunta').forEach(function (btn) {
                btn.addEventListener('click', function () { openEditarPergunta(parseInt(this.dataset.id, 10)); });
              });
              perguntasBody.querySelectorAll('.btn-excluir-pergunta').forEach(function (btn) {
                btn.addEventListener('click', function () {
                  if (!confirm('Excluir esta pergunta da base de dados? As respostas das gestoras também serão removidas.')) return;
                  const id = parseInt(this.dataset.id, 10);
                  fetch(API + '/perguntas/' + id, { method: 'DELETE', credentials: 'include' })
                    .then(function (r) { return r.ok ? Promise.resolve() : r.json().then(function (d) { return Promise.reject(new Error(d.message || 'Erro')); }); })
                    .then(function () { loadDuvidasRespondidas(); })
                    .catch(function (err) { alert(err.message || 'Erro ao excluir.'); });
                });
              });
            }
          })
          .catch(function () {
            perguntasBody.innerHTML = '<tr><td colspan="5" class="error-msg">Erro ao carregar.</td></tr>';
          });
      }

      var _perguntaEditarId = null;

      function openEditarPergunta(perguntaId) {
        _perguntaEditarId = perguntaId;
        document.getElementById('modalEditarPerguntaTitle').textContent = 'Editar pergunta #' + perguntaId;
        document.getElementById('modalEditarPerguntaTexto').value = '';
        document.getElementById('modalEditarPergunta').classList.add('visible');
        fetch(API + '/perguntas/' + perguntaId, { credentials: 'include' })
          .then(function (r) { return r.ok ? r.json() : Promise.reject(); })
          .then(function (data) {
            var texto = (data.pergunta && data.pergunta.texto) ? data.pergunta.texto : '';
            document.getElementById('modalEditarPerguntaTexto').value = texto;
          })
          .catch(function () { alert('Erro ao carregar pergunta.'); });
      }

      function saveEditarPergunta() {
        if (!_perguntaEditarId) return;
        var texto = document.getElementById('modalEditarPerguntaTexto').value.trim();
        if (!texto) { alert('Escreva o texto da pergunta.'); return; }
        fetch(API + '/perguntas/' + _perguntaEditarId, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ texto: texto }),
        })
          .then(function (r) { return r.ok ? Promise.resolve() : r.json().then(function (d) { return Promise.reject(new Error(d.message || 'Erro')); }); })
          .then(function () {
            document.getElementById('modalEditarPergunta').classList.remove('visible');
            _perguntaEditarId = null;
            loadDuvidasRespondidas();
          })
          .catch(function (err) { alert(err.message || 'Erro ao guardar.'); });
      }

      function openPerguntaDetail(perguntaId) {
        _perguntaModalId = perguntaId;
        fetch(API + '/perguntas/' + perguntaId, { credentials: 'include' })
          .then((r) => (r.ok ? r.json() : Promise.reject()))
          .then(function (data) {
            document.getElementById('modalPerguntaTitle').textContent = 'Pergunta #' + perguntaId;
            document.getElementById('modalPerguntaTexto').textContent = data.pergunta ? data.pergunta.texto : '';
            const respDiv = document.getElementById('modalPerguntaRespostas');
            respDiv.innerHTML = '';
            if (data.respostas && data.respostas.length) {
              data.respostas.forEach(function (r) {
                const p = document.createElement('p');
                p.style.marginBottom = '0.75rem';
                p.innerHTML = '<strong>' + escapeHtml(r.gestora_nome || 'Gestora') + ':</strong><br><span style="white-space:pre-wrap;">' + escapeHtml(r.texto || '') + '</span>';
                respDiv.appendChild(p);
              });
            } else {
              respDiv.innerHTML = '<p class="text-muted">Ainda sem respostas.</p>';
            }
            const minhaWrap = document.getElementById('modalPerguntaMinhaRespostaWrap');
            const adminActions = document.getElementById('modalPerguntaAdminActions');
            if (user && user.role === 'gestora') {
              minhaWrap.style.display = 'block';
              adminActions.style.display = 'none';
              document.getElementById('modalPerguntaMinhaResposta').value = data.minha_resposta ? data.minha_resposta.texto : '';
            } else {
              minhaWrap.style.display = 'none';
              adminActions.style.display = 'block';
            }
            document.getElementById('modalPergunta').classList.add('visible');
          })
          .catch(function () { alert('Erro ao carregar pergunta.'); });
      }

      function saveRespostaPergunta() {
        if (!_perguntaModalId || !user || user.role !== 'gestora') return;
        const texto = document.getElementById('modalPerguntaMinhaResposta').value.trim();
        if (!texto) { alert('Escreva a sua resposta.'); return; }
        fetch(API + '/perguntas/' + _perguntaModalId + '/respostas', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ texto: texto }),
        })
          .then((r) => (r.ok ? Promise.resolve() : r.json().then((d) => Promise.reject(new Error(d.message || 'Erro')))))
          .then(function () {
            document.getElementById('modalPergunta').classList.remove('visible');
            loadDuvidasRespondidas();
          })
          .catch(function (err) { alert(err.message || 'Erro ao guardar.'); });
      }

      function openVerDuvida(duvida) {
        document.getElementById('modalVerDuvidaTexto').textContent = (duvida && duvida.texto) ? duvida.texto : '';
        document.getElementById('modalVerDuvida').classList.add('visible');
      }

      var _duvidaEditarId = null;

      function openEditarDuvida(duvida) {
        if (!duvida || !duvida.id) return;
        _duvidaEditarId = duvida.id;
        document.getElementById('modalEditarDuvidaTitle').textContent = 'Editar dúvida #' + duvida.id;
        document.getElementById('modalEditarDuvidaTexto').value = (duvida.texto || '').trim();
        document.getElementById('modalEditarDuvida').classList.add('visible');
      }

      function saveEditarDuvida() {
        if (!_duvidaEditarId) return;
        var texto = document.getElementById('modalEditarDuvidaTexto').value.trim();
        if (!texto) { alert('Escreva o texto da dúvida.'); return; }
        fetch(API + '/duvidas-pendentes/' + _duvidaEditarId, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ texto: texto }),
        })
          .then(function (r) { return r.ok ? Promise.resolve() : r.json().then(function (d) { return Promise.reject(new Error(d.message || 'Erro')); }); })
          .then(function () {
            document.getElementById('modalEditarDuvida').classList.remove('visible');
            _duvidaEditarId = null;
            loadDuvidasPendentes();
          })
          .catch(function (err) { alert(err.message || 'Erro ao guardar.'); });
      }

      function openResponderDuvida(duvidaId) {
        _duvidaModalId = duvidaId;
        fetch(API + '/duvidas-pendentes', { credentials: 'include' })
          .then((r) => r.json())
          .then(function (list) {
            const d = list.find(function (x) { return x.id === duvidaId; });
            if (!d) { alert('Dúvida não encontrada.'); return; }
            document.getElementById('modalDuvidaTexto').textContent = d.texto || '';
            document.getElementById('modalDuvidaRespostaTexto').value = '';
            document.getElementById('modalDuvidaResponder').classList.add('visible');
          })
          .catch(function () { alert('Erro ao carregar.'); });
      }

      function submitResponderDuvida() {
        if (!_duvidaModalId) return;
        const texto = document.getElementById('modalDuvidaRespostaTexto').value.trim();
        if (!texto) { alert('Escreva a resposta.'); return; }
        fetch(API + '/duvidas-pendentes/' + _duvidaModalId + '/responder', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ texto: texto }),
        })
          .then((r) => (r.ok ? Promise.resolve() : r.json().then((d) => Promise.reject(new Error(d.message || 'Erro')))))
          .then(function () {
            document.getElementById('modalDuvidaResponder').classList.remove('visible');
            loadDuvidasPendentes();
            loadDuvidasRespondidas();
            const nome = user && user.nome && user.nome.trim() ? user.nome.trim() : 'Gestora';
            alert('Obrigado pela ajuda, ' + nome + ' 😊👍');
          })
          .catch(function (err) { alert(err.message || 'Erro ao responder.'); });
      }

      document.getElementById('modalEditarPerguntaCancel').addEventListener('click', function () { document.getElementById('modalEditarPergunta').classList.remove('visible'); _perguntaEditarId = null; });
      document.getElementById('modalEditarPerguntaSave').addEventListener('click', saveEditarPergunta);
      document.getElementById('modalPerguntaCancel').addEventListener('click', function () { document.getElementById('modalPergunta').classList.remove('visible'); });
      document.getElementById('modalPerguntaSave').addEventListener('click', saveRespostaPergunta);
      document.getElementById('modalPerguntaClose').addEventListener('click', function () { document.getElementById('modalPergunta').classList.remove('visible'); });
      document.getElementById('modalVerDuvidaFechar').addEventListener('click', function () { document.getElementById('modalVerDuvida').classList.remove('visible'); });
      document.getElementById('modalEditarDuvidaCancel').addEventListener('click', function () { document.getElementById('modalEditarDuvida').classList.remove('visible'); _duvidaEditarId = null; });
      document.getElementById('modalEditarDuvidaSave').addEventListener('click', saveEditarDuvida);
      document.getElementById('modalDuvidaResponderCancel').addEventListener('click', function () { document.getElementById('modalDuvidaResponder').classList.remove('visible'); });
      document.getElementById('modalDuvidaResponderSubmit').addEventListener('click', submitResponderDuvida);

      function loadRafa() {
        const tbody = document.getElementById('rafaBody');
        tbody.innerHTML = '<tr><td colspan="5">A carregar…</td></tr>';
        fetch(API + '/leads/rafa', { credentials: 'include' })
          .then((r) => r.json().then((data) => (r.ok ? data : Promise.reject(data))))
          .then((rows) => {
            tbody.innerHTML = '';
            updateRafaBadge();
            if (!rows.length) {
              tbody.innerHTML = '<tr><td colspan="5">Nenhum lead a aguardar. Quando alguém pedir "Falar com Rafa", aparece aqui.</td></tr>';
              return;
            }
            rows.forEach((r) => {
              const tr = document.createElement('tr');
              const num = (r.whatsapp_number || '').replace(/\D/g, '');
              const waUrl = num ? 'https://wa.me/' + num : '#';
              tr.innerHTML =
                '<td>' + escapeHtml(r.nome || '—') + '</td>' +
                '<td>' + escapeHtml(r.whatsapp_number || '—') + '</td>' +
                '<td>' + escapeHtml(r.email || '—') + '</td>' +
                '<td>' + escapeHtml(formatDate(r.updated_at)) + '</td>' +
                '<td class="actions">' +
                '<a href="' + waUrl + '" target="_blank" rel="noopener noreferrer" class="btn btn-whatsapp btn-sm">WhatsApp</a>' +
                '<button type="button" class="btn btn-devolver btn-sm btn-rafa-devolver" data-id="' + r.id + '">Devolver a aguardar</button>' +
                '</td>';
              tbody.appendChild(tr);
            });
            tbody.querySelectorAll('.btn-rafa-devolver').forEach((btn) => {
              btn.addEventListener('click', function () {
                const id = this.dataset.id;
                if (!confirm('Devolver este lead ao estado «aguardando escolha»?')) return;
                fetch(API + '/leads/' + id, {
                  method: 'PATCH',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'include',
                  body: JSON.stringify({ estado_conversa: 'aguardando_escolha' }),
                })
                  .then((res) => (res.ok ? loadRafa() : res.json().then((d) => Promise.reject(new Error(d.message || 'Erro')))))
                  .catch((err) => alert(err.message || 'Erro ao atualizar'));
              });
            });
          })
          .catch((err) => {
            const msg = (err && (err.detail || err.message)) || 'Erro ao carregar.';
            tbody.innerHTML = '<tr><td colspan="5" class="error-msg">' + escapeHtml(msg) + '</td></tr>';
          });
      }

      function loadProfile() {
        if (user && user.role !== 'gestora') return;
        fetch(API + '/profile', { credentials: 'include' })
          .then((r) => (r.ok ? r.json() : Promise.reject()))
          .then((data) => {
            document.getElementById('profileNome').value = data.nome || '';
            document.getElementById('profileEmail').value = data.email || '';
            document.getElementById('profileEmailParaLeads').value = data.email_para_leads || '';
            document.getElementById('profileWhatsapp').value = data.whatsapp || '';
            var fotoInput = document.getElementById('profileFotoPerfil');
            if (fotoInput) fotoInput.value = data.foto_perfil || '';
            var boasInput = document.getElementById('profileBoasVindas');
            if (boasInput) boasInput.value = data.boas_vindas || '';
            document.getElementById('profileCurrentPassword').value = '';
            document.getElementById('profileNewPassword').value = '';
            document.getElementById('profileNewPasswordConfirm').value = '';
            document.getElementById('profileRgpd').value = '';
            var subInput = document.getElementById('profileRgpdSubstituirInput');
            if (subInput) subInput.value = '';
            document.getElementById('profilePasswordArea').style.display = 'none';
            document.getElementById('profileBtnAlterarPassword').style.display = '';
            document.getElementById('profileError').style.display = 'none';
            document.getElementById('profileSuccess').style.display = 'none';
            var hasRgpd = !!data.has_rgpd;
            document.getElementById('profileRgpdEnviado').style.display = hasRgpd ? 'block' : 'none';
            document.getElementById('profileRgpdNaoEnviado').style.display = !hasRgpd ? 'block' : 'none';
            document.getElementById('profileRgpdSubstituirArea').style.display = 'none';
            document.getElementById('profileRgpdPreview').style.display = 'none';
            document.getElementById('profileRgpdSubstituirPreview').style.display = 'none';
            if (hasRgpd) document.getElementById('profileRgpdVer').href = API + '/profile/rgpd';
          })
          .catch(() => {
            document.getElementById('profileError').textContent = 'Erro ao carregar perfil.';
            document.getElementById('profileError').style.display = 'block';
          });
      }

      document.getElementById('profileForm').addEventListener('submit', function (e) {
        e.preventDefault();
        var errEl = document.getElementById('profileError');
        var okEl = document.getElementById('profileSuccess');
        errEl.style.display = 'none';
        okEl.style.display = 'none';
        var newP = document.getElementById('profileNewPassword').value;
        var newPConfirm = document.getElementById('profileNewPasswordConfirm').value;
        if (newP || newPConfirm) {
          if (newP.length < 6) {
            errEl.textContent = 'A nova palavra-passe deve ter pelo menos 6 caracteres.';
            errEl.style.display = 'block';
            return;
          }
          if (newP !== newPConfirm) {
            errEl.textContent = 'A confirmação da nova palavra-passe não coincide.';
            errEl.style.display = 'block';
            return;
          }
        }
        var fd = new FormData();
        fd.append('whatsapp', document.getElementById('profileWhatsapp').value.trim());
        fd.append('email_para_leads', document.getElementById('profileEmailParaLeads').value.trim().toLowerCase());
        var fotoInput = document.getElementById('profileFotoPerfil');
        if (fotoInput) fd.append('foto_perfil', fotoInput.value.trim());
        var boasInput = document.getElementById('profileBoasVindas');
        if (boasInput) fd.append('boas_vindas', boasInput.value.trim());
        fd.append('currentPassword', document.getElementById('profileCurrentPassword').value);
        fd.append('newPassword', newP);
        var rgpdInput = document.getElementById('profileRgpdSubstituirInput');
        if (!rgpdInput.files || !rgpdInput.files[0]) rgpdInput = document.getElementById('profileRgpd');
        if (rgpdInput.files && rgpdInput.files[0]) fd.append('rgpd', rgpdInput.files[0]);
        fetch(API + '/profile', {
          method: 'POST',
          credentials: 'include',
          body: fd,
        })
          .then(function (r) { return r.json().then(function (d) { return r.ok ? d : Promise.reject(d); }); })
          .then(function (d) {
            okEl.textContent = d.message || 'Perfil atualizado.';
            okEl.style.display = 'block';
            document.getElementById('profileCurrentPassword').value = '';
            document.getElementById('profileNewPassword').value = '';
            document.getElementById('profileNewPasswordConfirm').value = '';
            document.getElementById('profileRgpd').value = '';
            var subInput = document.getElementById('profileRgpdSubstituirInput');
            if (subInput) subInput.value = '';
            document.getElementById('profileRgpdSubstituirArea').style.display = 'none';
            loadProfile();
          })
          .catch(function (d) {
            errEl.textContent = (d && d.message) || 'Erro ao atualizar perfil.';
            errEl.style.display = 'block';
          });
      });

      document.getElementById('profileBtnAlterarPassword').addEventListener('click', function () {
        document.getElementById('profileBtnAlterarPassword').style.display = 'none';
        document.getElementById('profilePasswordArea').style.display = 'block';
      });
      document.getElementById('profilePasswordCancelar').addEventListener('click', function () {
        document.getElementById('profilePasswordArea').style.display = 'none';
        document.getElementById('profileBtnAlterarPassword').style.display = '';
        document.getElementById('profileCurrentPassword').value = '';
        document.getElementById('profileNewPassword').value = '';
        document.getElementById('profileNewPasswordConfirm').value = '';
      });
      document.getElementById('profileRgpdSubstituir').addEventListener('click', function () {
        document.getElementById('profileRgpdEnviado').style.display = 'none';
        document.getElementById('profileRgpdSubstituirArea').style.display = 'block';
        document.getElementById('profileRgpdSubstituirInput').value = '';
        document.getElementById('profileRgpdSubstituirPreview').style.display = 'none';
      });
      document.getElementById('profileRgpdSubstituirCancelar').addEventListener('click', function () {
        document.getElementById('profileRgpdSubstituirArea').style.display = 'none';
        document.getElementById('profileRgpdEnviado').style.display = 'block';
        document.getElementById('profileRgpdSubstituirInput').value = '';
        document.getElementById('profileRgpdSubstituirPreview').style.display = 'none';
      });
      document.getElementById('profileRgpd').addEventListener('change', function () {
        document.getElementById('profileRgpdPreview').style.display = (this.files && this.files[0]) ? 'block' : 'none';
      });
      document.getElementById('profileRgpdSubstituirInput').addEventListener('change', function () {
        document.getElementById('profileRgpdSubstituirPreview').style.display = (this.files && this.files[0]) ? 'block' : 'none';
      });

      function openEditLeadEstadoDocs(lead) {
        document.getElementById('editLeadEstadoDocsLeadId').value = lead.id;
        var sel = document.getElementById('editLeadEstadoDocsSelect');
        sel.innerHTML = '';
        ESTADO_DOCS_OPCOES.forEach(function (v) {
          var opt = document.createElement('option');
          opt.value = v;
          opt.textContent = v;
          if ((lead.estado_docs || '') === v) opt.selected = true;
          sel.appendChild(opt);
        });
        document.getElementById('modalLeadEstadoDocs').classList.add('visible');
      }

      document.getElementById('modalLeadEstadoDocsCancel').addEventListener('click', function () {
        document.getElementById('modalLeadEstadoDocs').classList.remove('visible');
      });
      document.getElementById('modalLeadEstadoDocsSave').addEventListener('click', function () {
        var id = document.getElementById('editLeadEstadoDocsLeadId').value;
        var val = document.getElementById('editLeadEstadoDocsSelect').value;
        fetch(API + '/leads/' + id, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ estado_docs: val }),
        })
          .then(function (r) { return r.ok ? undefined : r.json().then(function (d) { return Promise.reject(new Error(d.message || 'Erro')); }); })
          .then(function () {
            document.getElementById('modalLeadEstadoDocs').classList.remove('visible');
            loadLeads();
          })
          .catch(function (err) { alert(err.message || 'Erro ao atualizar estado.'); });
      });

      function openEditLead(lead) {
        document.getElementById('editLeadId').value = lead.id;
        document.getElementById('editLeadNome').value = lead.nome || '';
        document.getElementById('editLeadEmail').value = lead.email || '';
        document.getElementById('editLeadEstadoConversa').value = lead.estado_conversa || 'aguardando_escolha';
        document.getElementById('editLeadEstadoDocs').value = lead.estado_docs || 'aguardando_docs';
        document.getElementById('editLeadGestoraId').value = lead.gestora_id != null ? lead.gestora_id : '';
        document.getElementById('editLeadGestoraRow').style.display = user && user.role === 'admin' ? '' : 'none';
        document.getElementById('modalLead').classList.add('visible');
      }

      document.getElementById('modalLeadCancel').addEventListener('click', function () {
        document.getElementById('modalLead').classList.remove('visible');
      });
      document.getElementById('modalLeadSave').addEventListener('click', function () {
        const id = document.getElementById('editLeadId').value;
        const payload = {
          nome: document.getElementById('editLeadNome').value.trim() || null,
          email: document.getElementById('editLeadEmail').value.trim() || null,
          estado_conversa: document.getElementById('editLeadEstadoConversa').value,
          estado_docs: document.getElementById('editLeadEstadoDocs').value,
          gestora_id: document.getElementById('editLeadGestoraId').value.trim() ? parseInt(document.getElementById('editLeadGestoraId').value, 10) : null,
        };
        if (user && user.role === 'gestora') delete payload.gestora_id;
        fetch(API + '/leads/' + id, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload),
        })
          .then(function (r) {
            if (r.ok) return;
            return r.json().then(function (d) { throw new Error(d.message || 'Erro ao guardar'); });
          })
          .then(function () {
            document.getElementById('modalLead').classList.remove('visible');
            loadLeads();
            updateRafaBadge();
          })
          .catch(function (err) { alert(err.message || 'Erro ao guardar'); });
      });

      function deleteLead(id) {
        fetch(API + '/leads/' + id, { method: 'DELETE', credentials: 'include' })
          .then((r) => (r.ok ? loadLeads() : Promise.reject()))
          .catch(() => alert('Erro ao apagar'));
      }

      function loadGestoras() {
        const tbody = document.getElementById('gestorasBody');
        tbody.innerHTML = '<tr><td colspan="13">A carregar…</td></tr>';
        fetch(API + '/gestoras', { credentials: 'include' })
          .then((r) => (r.ok ? r.json() : Promise.reject()))
          .then((rows) => {
            tbody.innerHTML = '';
            if (!rows.length) {
              tbody.innerHTML = '<tr><td colspan="13">Nenhuma gestora.</td></tr>';
              return;
            }
            rows.forEach((r) => {
              const tr = document.createElement('tr');
              tr.innerHTML =
                '<td>' + r.id + '</td><td>' +
                escapeHtml(r.nome || '') + '</td><td>' +
                escapeHtml(r.email || '') + '</td><td>' +
                escapeHtml(r.email_para_leads || r.email || '—') + '</td><td>' +
                escapeHtml(r.whatsapp || '') + '</td><td>' +
                (r.ativo ? 'Sim' : 'Não') +
                '</td><td>' + (r.total_leads != null ? r.total_leads : '0') + '</td>' +
                '<td>' + (r.aguardando_docs != null ? r.aguardando_docs : '0') + '</td>' +
                '<td>' + (r.docs_enviados != null ? r.docs_enviados : '0') + '</td>' +
                '<td>' + (r.credito_aprovado != null ? r.credito_aprovado : '0') + '</td>' +
                '<td>' + (r.agendado_escritura != null ? r.agendado_escritura : '0') + '</td>' +
                '<td>' + (r.escritura_realizada != null ? r.escritura_realizada : '0') + '</td>' +
                '<td>' + (r.inviavel != null ? r.inviavel : '0') + '</td>' +
                '<td class="actions">' +
                '<button type="button" class="btn btn-secondary btn-sm btn-icon btn-edit-gestora" data-id="' + r.id + '" title="Editar">' +
                '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>' +
                '<button type="button" class="btn btn-danger btn-sm btn-icon btn-delete-gestora" data-id="' + r.id + '" title="Apagar">' +
                '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>' +
                '</td>';
              tbody.appendChild(tr);
            });
            tbody.querySelectorAll('.btn-edit-gestora').forEach((b) =>
              b.addEventListener('click', function () {
                openEditGestora(rows.find((x) => x.id === parseInt(this.dataset.id, 10)));
              })
            );
            tbody.querySelectorAll('.btn-delete-gestora').forEach((b) =>
              b.addEventListener('click', function () {
                if (confirm('Apagar esta gestora? Os leads associados ficarão sem gestora.')) deleteGestora(this.dataset.id);
              })
            );
          })
          .catch(() => {
            tbody.innerHTML = '<tr><td colspan="12">Erro ao carregar.</td></tr>';
          });
      }

      document.getElementById('btnNovaGestora').addEventListener('click', function () {
        document.getElementById('modalGestoraTitle').textContent = 'Nova gestora';
        document.getElementById('editGestoraId').value = '';
        document.getElementById('editGestoraNome').value = '';
        document.getElementById('editGestoraEmail').value = '';
        document.getElementById('editGestoraEmailParaLeads').value = '';
        document.getElementById('editGestoraWhatsapp').value = '';
        document.getElementById('editGestoraAtivo').checked = true;
        document.getElementById('modalGestora').classList.add('visible');
      });

      function openEditGestora(g) {
        document.getElementById('modalGestoraTitle').textContent = 'Editar gestora';
        document.getElementById('editGestoraId').value = g.id;
        document.getElementById('editGestoraNome').value = g.nome || '';
        document.getElementById('editGestoraEmail').value = g.email || '';
        document.getElementById('editGestoraEmailParaLeads').value = g.email_para_leads || g.email || '';
        document.getElementById('editGestoraWhatsapp').value = g.whatsapp || '';
        document.getElementById('editGestoraAtivo').checked = !!g.ativo;
        document.getElementById('modalGestora').classList.add('visible');
      }

      document.getElementById('modalGestoraCancel').addEventListener('click', function () {
        document.getElementById('modalGestora').classList.remove('visible');
      });
      document.getElementById('modalGestoraSave').addEventListener('click', function () {
        const id = document.getElementById('editGestoraId').value;
        const payload = {
          nome: document.getElementById('editGestoraNome').value.trim(),
          email: document.getElementById('editGestoraEmail').value.trim(),
          email_para_leads: document.getElementById('editGestoraEmailParaLeads').value.trim() || undefined,
          whatsapp: document.getElementById('editGestoraWhatsapp').value.replace(/\D/g, ''),
          ativo: document.getElementById('editGestoraAtivo').checked,
        };
        const url = id ? API + '/gestoras/' + id : API + '/gestoras';
        const method = id ? 'PATCH' : 'POST';
        fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload),
        })
          .then((r) => {
            if (r.ok) return id ? Promise.resolve() : r.json();
            return r.json().then((d) => Promise.reject(new Error(d.message || 'Erro')));
          })
          .then(() => {
            document.getElementById('modalGestora').classList.remove('visible');
            loadGestoras();
          })
          .catch((err) => alert(err.message || 'Erro ao guardar'));
      });

      function deleteGestora(id) {
        fetch(API + '/gestoras/' + id, { method: 'DELETE', credentials: 'include' })
          .then((r) => (r.ok ? loadGestoras() : Promise.reject()))
          .catch(() => alert('Erro ao apagar'));
      }

      function escapeHtml(s) {
        if (s == null) return '';
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }
      function formatDate(d) {
        if (!d) return '—';
        const dt = new Date(d);
        return isNaN(dt.getTime()) ? d : dt.toLocaleString('pt-PT');
      }

      init();
    })();
  </script>
</body>
</html>
