<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard – Crédito Habitação</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f8fafc;
      --surface: #ffffff;
      --sidebar: #0f172a;
      --sidebar-hover: #1e293b;
      --text: #0f172a;
      --text-muted: #64748b;
      --accent: #0d9488;
      --accent-hover: #0f766e;
      --accent-soft: rgba(13, 148, 136, 0.12);
      --error: #dc2626;
      --border: #e2e8f0;
      --radius: 10px;
      --radius-lg: 14px;
      --shadow: 0 1px 3px rgba(0,0,0,.06);
      --shadow-md: 0 4px 12px rgba(0,0,0,.08);
      --badge: #f59e0b;
      --badge-bg: rgba(245, 158, 11, 0.2);
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Plus Jakarta Sans', system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; font-size: 15px; line-height: 1.5; }
    .app { display: flex; min-height: 100vh; }
    .sidebar {
      width: 260px;
      background: linear-gradient(180deg, var(--sidebar) 0%, #1e293b 100%);
      color: #fff;
      padding: 1.5rem 0;
      flex-shrink: 0;
      box-shadow: 2px 0 20px rgba(0,0,0,.06);
    }
    .sidebar-nav-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 0.75rem 1.25rem;
      color: rgba(255,255,255,.88);
      text-decoration: none;
      border: none;
      background: none;
      font: inherit;
      text-align: left;
      cursor: pointer;
      transition: background .15s, color .15s;
    }
    .sidebar-nav-item:hover { background: var(--sidebar-hover); color: #fff; }
    .sidebar-nav-item.active { background: var(--accent); color: #fff; }
    .nav-label { flex: 1; }
    .nav-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 22px;
      height: 22px;
      padding: 0 6px;
      font-size: 0.75rem;
      font-weight: 700;
      color: #fff;
      background: var(--badge);
      border-radius: 11px;
      animation: pulse-badge 2s ease-in-out infinite;
    }
    .nav-badge.hidden { display: none; }
    @keyframes pulse-badge {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.85; }
    }
    .main { flex: 1; padding: 2rem 2.5rem; overflow: auto; }
    .screen { display: none; }
    .screen.visible { display: block !important; }
    .main .screen { display: none; }
    .main .screen.visible { display: block !important; }
    .login-wrap { max-width: 400px; margin: 5rem auto; padding: 2.5rem; background: var(--surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); border: 1px solid var(--border); }
    .login-wrap h1 { margin: 0 0 1.5rem; font-size: 1.5rem; font-weight: 700; color: var(--text); }
    label { display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text); }
    input[type="email"], input[type="password"], input[type="text"], input[type="number"], select {
      width: 100%; padding: 0.65rem 0.9rem; border: 1px solid var(--border); border-radius: var(--radius); font: inherit; margin-bottom: 1rem; transition: border-color .15s, box-shadow .15s;
    }
    input:focus, select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-soft); }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.4rem; padding: 0.55rem 1rem; border-radius: var(--radius); font: inherit; font-weight: 600; cursor: pointer; border: none; transition: background .15s, transform .05s; }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { background: var(--accent-hover); color: #fff; }
    .btn-secondary { background: var(--border); color: var(--text); }
    .btn-secondary:hover { background: #cbd5e1; }
    .btn-danger { background: var(--error); color: #fff; }
    .btn-danger:hover { background: #b91c1c; color: #fff; }
    .btn-sm { padding: 0.4rem 0.75rem; font-size: 0.8125rem; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btn-outline:hover { background: var(--bg); border-color: var(--text-muted); }
    .error-msg { color: var(--error); font-size: 0.875rem; margin-top: 0.5rem; }
    .page-title { margin: 0 0 1.5rem; font-size: 1.375rem; font-weight: 700; color: var(--text); letter-spacing: -0.02em; }
    .card { background: var(--surface); border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow); border: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border); }
    th { background: var(--bg); font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.04em; color: var(--text-muted); }
    tr:last-child td { border-bottom: none; }
    tbody tr { transition: background .12s; }
    tbody tr:hover { background: var(--accent-soft); }
    .actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .toolbar { margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(15,23,42,.5); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
    .modal-overlay.visible { display: flex; }
    .modal { background: var(--surface); border-radius: var(--radius-lg); padding: 1.75rem; max-width: 440px; width: 100%; max-height: 90vh; overflow: auto; box-shadow: 0 20px 40px rgba(0,0,0,.15); }
    .modal h3 { margin: 0 0 1.25rem; font-size: 1.125rem; font-weight: 700; }
    .modal-actions { margin-top: 1.5rem; display: flex; gap: 0.5rem; justify-content: flex-end; }
    .table-wrap { overflow-x: auto; border-radius: var(--radius-lg); }
    .text-muted { color: var(--text-muted); font-size: 0.875rem; }
    .btn-whatsapp { background: #25d366; color: #fff; }
    .btn-whatsapp:hover { background: #20bd5a; color: #fff; }
    .btn-devolver { background: var(--accent-soft); color: var(--accent); border: 1px solid rgba(13,148,136,.3); }
    .btn-devolver:hover { background: var(--accent); color: #fff; border-color: var(--accent); }
  </style>
</head>
<body>
  <div id="loginScreen" class="login-wrap screen">
    <h1>Dashboard – Login</h1>
    <form id="loginForm">
      <label for="loginEmail">Email</label>
      <input type="email" id="loginEmail" required autocomplete="email">
      <label for="loginPassword">Palavra-passe</label>
      <input type="password" id="loginPassword" required autocomplete="current-password">
      <p id="loginError" class="error-msg" style="display:none;"></p>
      <button type="submit" class="btn btn-primary" style="width:100%;">Entrar</button>
    </form>
  </div>

  <div id="dashboardApp" class="app screen">
    <nav class="sidebar">
      <a href="#leads" id="navLeads" class="sidebar-nav-item active">Leads</a>
      <a href="#rafa" id="navRafa" class="sidebar-nav-item">
        <span class="nav-label">Falar com Rafa</span>
        <span id="navRafaBadge" class="nav-badge hidden">0</span>
      </a>
      <a href="#gestoras" id="navGestoras" class="sidebar-nav-item">Gestoras</a>
      <button type="button" id="btnLogout" class="sidebar-nav-item" style="width:100%;">Sair</button>
    </nav>
    <main class="main">
      <div id="screenLeads" class="screen visible">
        <h2 class="page-title">Leads</h2>
        <div class="table-wrap card">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>WhatsApp</th>
                <th>Nome</th>
                <th>Email</th>
                <th>Estado conversa</th>
                <th>Estado docs</th>
                <th>Docs enviados</th>
                <th>Gestora</th>
                <th>Atualizado</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="leadsBody"></tbody>
          </table>
        </div>
      </div>
      <div id="screenRafa" class="screen">
        <h2 class="page-title">Falar com Rafa</h2>
        <p class="text-muted" style="margin-top:-0.5rem;margin-bottom:1.25rem;">Leads que pediram para falar contigo. Abre a conversa no WhatsApp ou devolve o lead a aguardar escolha.</p>
        <div class="table-wrap card">
          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>WhatsApp</th>
                <th>Email</th>
                <th>Atualizado</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="rafaBody"></tbody>
          </table>
        </div>
      </div>
      <div id="screenGestoras" class="screen">
        <div class="toolbar">
          <h2 class="page-title" style="margin:0;">Gestoras de crédito</h2>
          <button type="button" class="btn btn-primary" id="btnNovaGestora">Nova gestora</button>
        </div>
        <div class="table-wrap card">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>Email</th>
                <th>WhatsApp</th>
                <th>Ativo</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="gestorasBody"></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <div id="modalLead" class="modal-overlay">
    <div class="modal">
      <h3>Editar lead</h3>
      <input type="hidden" id="editLeadId">
      <label>Nome</label>
      <input type="text" id="editLeadNome">
      <label>Email</label>
      <input type="email" id="editLeadEmail">
      <label>Estado conversa</label>
      <select id="editLeadEstadoConversa">
        <option value="aguardando_escolha">aguardando_escolha</option>
        <option value="com_joana">com_joana</option>
        <option value="com_gestora">com_gestora</option>
        <option value="com_rafa">com_rafa</option>
      </select>
      <label>Estado docs</label>
      <select id="editLeadEstadoDocs">
        <option value="aguardando_docs">aguardando_docs</option>
        <option value="sem_docs">sem_docs</option>
        <option value="docs_enviados">docs_enviados</option>
      </select>
      <label>Gestora ID</label>
      <input type="number" id="editLeadGestoraId" min="0" placeholder="vazio">
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" id="modalLeadCancel">Cancelar</button>
        <button type="button" class="btn btn-primary" id="modalLeadSave">Guardar</button>
      </div>
    </div>
  </div>

  <div id="modalGestora" class="modal-overlay">
    <div class="modal">
      <h3 id="modalGestoraTitle">Nova gestora</h3>
      <input type="hidden" id="editGestoraId">
      <label>Nome</label>
      <input type="text" id="editGestoraNome" required>
      <label>Email</label>
      <input type="email" id="editGestoraEmail" required>
      <label>WhatsApp (com indicativo, ex: 351912345678)</label>
      <input type="text" id="editGestoraWhatsapp" required placeholder="351912345678">
      <label><input type="checkbox" id="editGestoraAtivo" checked> Ativa</label>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" id="modalGestoraCancel">Cancelar</button>
        <button type="button" class="btn btn-primary" id="modalGestoraSave">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const API = '/api/dashboard';
      let user = null;

      function showScreen(id) {
        document.querySelectorAll('.main .screen').forEach((s) => s.classList.remove('visible'));
        document.querySelectorAll('.sidebar-nav-item').forEach((el) => el.classList.remove('active'));
        const s = document.getElementById('screen' + id.charAt(0).toUpperCase() + id.slice(1));
        const a = document.getElementById('nav' + id.charAt(0).toUpperCase() + id.slice(1));
        if (s) s.classList.add('visible');
        if (a) a.classList.add('active');
        if (id === 'leads') loadLeads();
        if (id === 'gestoras') loadGestoras();
        if (id === 'rafa') loadRafa();
      }

      function updateRafaBadge() {
        fetch(API + '/leads/rafa/count', { credentials: 'include' })
          .then((r) => (r.ok ? r.json() : { count: 0 }))
          .then((data) => {
            const badge = document.getElementById('navRafaBadge');
            const n = data.count || 0;
            badge.textContent = n > 99 ? '99+' : String(n);
            badge.classList.toggle('hidden', n === 0);
          })
          .catch(() => {
            document.getElementById('navRafaBadge').classList.add('hidden');
          });
      }

      function checkAuth() {
        return fetch(API + '/me', { credentials: 'include' })
          .then((r) => (r.ok ? r.json() : Promise.reject()));
      }

      function init() {
        checkAuth()
          .then((data) => {
            user = data.user;
            document.getElementById('loginScreen').classList.remove('visible');
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardApp').classList.add('visible');
            document.getElementById('dashboardApp').style.display = 'flex';
            updateRafaBadge();
            const hash = (window.location.hash || '#leads').slice(1) || 'leads';
            const screenId = hash === 'gestoras' ? 'gestoras' : hash === 'rafa' ? 'rafa' : 'leads';
            showScreen(screenId);
          })
          .catch(() => {
            document.getElementById('loginScreen').classList.add('visible');
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('dashboardApp').classList.remove('visible');
            document.getElementById('dashboardApp').style.display = 'none';
          });
      }

      document.getElementById('loginForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const err = document.getElementById('loginError');
        err.style.display = 'none';
        fetch(API + '/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            email: document.getElementById('loginEmail').value.trim(),
            password: document.getElementById('loginPassword').value,
          }),
        })
          .then((r) => {
            if (r.ok) return r.json();
            return r.json().then((d) => Promise.reject(new Error(d.message || 'Erro no login')));
          })
          .then(() => init())
          .catch((msg) => {
            err.textContent = msg.message || String(msg);
            err.style.display = 'block';
          });
      });

      document.getElementById('btnLogout').addEventListener('click', function () {
        fetch(API + '/logout', { method: 'POST', credentials: 'include' }).then(() => {
          window.location.href = '/';
        });
      });

      window.addEventListener('hashchange', function () {
        if (!user) return;
        const hash = (window.location.hash || '#leads').slice(1) || 'leads';
        const screenId = hash === 'gestoras' ? 'gestoras' : hash === 'rafa' ? 'rafa' : 'leads';
        showScreen(screenId);
      });

      function loadLeads() {
        const tbody = document.getElementById('leadsBody');
        tbody.innerHTML = '<tr><td colspan="10">A carregar…</td></tr>';
        fetch(API + '/leads', { credentials: 'include' })
          .then((r) => r.json().then((data) => (r.ok ? data : Promise.reject(data))))
          .then((rows) => {
            tbody.innerHTML = '';
            if (!rows.length) {
              tbody.innerHTML = '<tr><td colspan="10">Nenhum lead.</td></tr>';
              return;
            }
            rows.forEach((r) => {
              const tr = document.createElement('tr');
              tr.innerHTML =
                '<td>' +
                r.id +
                '</td><td>' +
                escapeHtml(r.whatsapp_number || '') +
                '</td><td>' +
                escapeHtml(r.nome || '') +
                '</td><td>' +
                escapeHtml(r.email || '') +
                '</td><td>' +
                escapeHtml(r.estado_conversa || '') +
                '</td><td>' +
                escapeHtml(r.estado_docs || '') +
                '</td><td>' +
                (r.docs_enviados ? 'Sim' : 'Não') +
                '</td><td>' +
                escapeHtml(r.gestora_nome || '—') +
                '</td><td>' +
                escapeHtml(formatDate(r.updated_at)) +
                '</td><td class="actions">' +
                '<button type="button" class="btn btn-secondary btn-sm btn-edit-lead" data-id="' +
                r.id +
                '">Editar</button>' +
                '<button type="button" class="btn btn-danger btn-sm btn-delete-lead" data-id="' +
                r.id +
                '">Apagar</button>' +
                '</td>';
              tbody.appendChild(tr);
            });
            tbody.querySelectorAll('.btn-edit-lead').forEach((b) =>
              b.addEventListener('click', function () {
                openEditLead(rows.find((x) => x.id === parseInt(this.dataset.id, 10)));
              })
            );
            tbody.querySelectorAll('.btn-delete-lead').forEach((b) =>
              b.addEventListener('click', function () {
                if (confirm('Apagar este lead?')) deleteLead(this.dataset.id);
              })
            );
          })
          .catch((err) => {
            const msg = (err && (err.detail || err.message)) || 'Erro ao carregar.';
            tbody.innerHTML = '<tr><td colspan="10" class="error-msg">' + escapeHtml(msg) + '</td></tr>';
          });
      }

      function loadRafa() {
        const tbody = document.getElementById('rafaBody');
        tbody.innerHTML = '<tr><td colspan="5">A carregar…</td></tr>';
        fetch(API + '/leads/rafa', { credentials: 'include' })
          .then((r) => r.json().then((data) => (r.ok ? data : Promise.reject(data))))
          .then((rows) => {
            tbody.innerHTML = '';
            updateRafaBadge();
            if (!rows.length) {
              tbody.innerHTML = '<tr><td colspan="5">Nenhum lead a aguardar. Quando alguém pedir "Falar com Rafa", aparece aqui.</td></tr>';
              return;
            }
            rows.forEach((r) => {
              const tr = document.createElement('tr');
              const num = (r.whatsapp_number || '').replace(/\D/g, '');
              const waUrl = num ? 'https://wa.me/' + num : '#';
              tr.innerHTML =
                '<td>' + escapeHtml(r.nome || '—') + '</td>' +
                '<td>' + escapeHtml(r.whatsapp_number || '—') + '</td>' +
                '<td>' + escapeHtml(r.email || '—') + '</td>' +
                '<td>' + escapeHtml(formatDate(r.updated_at)) + '</td>' +
                '<td class="actions">' +
                '<a href="' + waUrl + '" target="_blank" rel="noopener noreferrer" class="btn btn-whatsapp btn-sm">WhatsApp</a>' +
                '<button type="button" class="btn btn-devolver btn-sm btn-rafa-devolver" data-id="' + r.id + '">Devolver a aguardar</button>' +
                '</td>';
              tbody.appendChild(tr);
            });
            tbody.querySelectorAll('.btn-rafa-devolver').forEach((btn) => {
              btn.addEventListener('click', function () {
                const id = this.dataset.id;
                if (!confirm('Devolver este lead ao estado «aguardando escolha»?')) return;
                fetch(API + '/leads/' + id, {
                  method: 'PATCH',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'include',
                  body: JSON.stringify({ estado_conversa: 'aguardando_escolha' }),
                })
                  .then((res) => (res.ok ? loadRafa() : res.json().then((d) => Promise.reject(new Error(d.message || 'Erro')))))
                  .catch((err) => alert(err.message || 'Erro ao atualizar'));
              });
            });
          })
          .catch((err) => {
            const msg = (err && (err.detail || err.message)) || 'Erro ao carregar.';
            tbody.innerHTML = '<tr><td colspan="5" class="error-msg">' + escapeHtml(msg) + '</td></tr>';
          });
      }

      function openEditLead(lead) {
        document.getElementById('editLeadId').value = lead.id;
        document.getElementById('editLeadNome').value = lead.nome || '';
        document.getElementById('editLeadEmail').value = lead.email || '';
        document.getElementById('editLeadEstadoConversa').value = lead.estado_conversa || 'aguardando_escolha';
        document.getElementById('editLeadEstadoDocs').value = lead.estado_docs || 'aguardando_docs';
        document.getElementById('editLeadGestoraId').value = lead.gestora_id != null ? lead.gestora_id : '';
        document.getElementById('modalLead').classList.add('visible');
      }

      document.getElementById('modalLeadCancel').addEventListener('click', function () {
        document.getElementById('modalLead').classList.remove('visible');
      });
      document.getElementById('modalLeadSave').addEventListener('click', function () {
        const id = document.getElementById('editLeadId').value;
        const payload = {
          nome: document.getElementById('editLeadNome').value.trim() || null,
          email: document.getElementById('editLeadEmail').value.trim() || null,
          estado_conversa: document.getElementById('editLeadEstadoConversa').value,
          estado_docs: document.getElementById('editLeadEstadoDocs').value,
          gestora_id: document.getElementById('editLeadGestoraId').value.trim() ? parseInt(document.getElementById('editLeadGestoraId').value, 10) : null,
        };
        fetch(API + '/leads/' + id, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload),
        })
          .then(function (r) {
            if (r.ok) return;
            return r.json().then(function (d) { throw new Error(d.message || 'Erro ao guardar'); });
          })
          .then(function () {
            document.getElementById('modalLead').classList.remove('visible');
            loadLeads();
            updateRafaBadge();
          })
          .catch(function (err) { alert(err.message || 'Erro ao guardar'); });
      });

      function deleteLead(id) {
        fetch(API + '/leads/' + id, { method: 'DELETE', credentials: 'include' })
          .then((r) => (r.ok ? loadLeads() : Promise.reject()))
          .catch(() => alert('Erro ao apagar'));
      }

      function loadGestoras() {
        const tbody = document.getElementById('gestorasBody');
        tbody.innerHTML = '<tr><td colspan="6">A carregar…</td></tr>';
        fetch(API + '/gestoras', { credentials: 'include' })
          .then((r) => (r.ok ? r.json() : Promise.reject()))
          .then((rows) => {
            tbody.innerHTML = '';
            if (!rows.length) {
              tbody.innerHTML = '<tr><td colspan="6">Nenhuma gestora.</td></tr>';
              return;
            }
            rows.forEach((r) => {
              const tr = document.createElement('tr');
              tr.innerHTML =
                '<td>' +
                r.id +
                '</td><td>' +
                escapeHtml(r.nome || '') +
                '</td><td>' +
                escapeHtml(r.email || '') +
                '</td><td>' +
                escapeHtml(r.whatsapp || '') +
                '</td><td>' +
                (r.ativo ? 'Sim' : 'Não') +
                '</td><td class="actions">' +
                '<button type="button" class="btn btn-secondary btn-sm btn-edit-gestora" data-id="' +
                r.id +
                '">Editar</button>' +
                '<button type="button" class="btn btn-danger btn-sm btn-delete-gestora" data-id="' +
                r.id +
                '">Apagar</button>' +
                '</td>';
              tbody.appendChild(tr);
            });
            tbody.querySelectorAll('.btn-edit-gestora').forEach((b) =>
              b.addEventListener('click', function () {
                openEditGestora(rows.find((x) => x.id === parseInt(this.dataset.id, 10)));
              })
            );
            tbody.querySelectorAll('.btn-delete-gestora').forEach((b) =>
              b.addEventListener('click', function () {
                if (confirm('Apagar esta gestora? Os leads associados ficarão sem gestora.')) deleteGestora(this.dataset.id);
              })
            );
          })
          .catch(() => {
            tbody.innerHTML = '<tr><td colspan="6">Erro ao carregar.</td></tr>';
          });
      }

      document.getElementById('btnNovaGestora').addEventListener('click', function () {
        document.getElementById('modalGestoraTitle').textContent = 'Nova gestora';
        document.getElementById('editGestoraId').value = '';
        document.getElementById('editGestoraNome').value = '';
        document.getElementById('editGestoraEmail').value = '';
        document.getElementById('editGestoraWhatsapp').value = '';
        document.getElementById('editGestoraAtivo').checked = true;
        document.getElementById('modalGestora').classList.add('visible');
      });

      function openEditGestora(g) {
        document.getElementById('modalGestoraTitle').textContent = 'Editar gestora';
        document.getElementById('editGestoraId').value = g.id;
        document.getElementById('editGestoraNome').value = g.nome || '';
        document.getElementById('editGestoraEmail').value = g.email || '';
        document.getElementById('editGestoraWhatsapp').value = g.whatsapp || '';
        document.getElementById('editGestoraAtivo').checked = !!g.ativo;
        document.getElementById('modalGestora').classList.add('visible');
      }

      document.getElementById('modalGestoraCancel').addEventListener('click', function () {
        document.getElementById('modalGestora').classList.remove('visible');
      });
      document.getElementById('modalGestoraSave').addEventListener('click', function () {
        const id = document.getElementById('editGestoraId').value;
        const payload = {
          nome: document.getElementById('editGestoraNome').value.trim(),
          email: document.getElementById('editGestoraEmail').value.trim(),
          whatsapp: document.getElementById('editGestoraWhatsapp').value.replace(/\D/g, ''),
          ativo: document.getElementById('editGestoraAtivo').checked,
        };
        const url = id ? API + '/gestoras/' + id : API + '/gestoras';
        const method = id ? 'PATCH' : 'POST';
        fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload),
        })
          .then((r) => {
            if (r.ok) return id ? Promise.resolve() : r.json();
            return r.json().then((d) => Promise.reject(new Error(d.message || 'Erro')));
          })
          .then(() => {
            document.getElementById('modalGestora').classList.remove('visible');
            loadGestoras();
          })
          .catch((err) => alert(err.message || 'Erro ao guardar'));
      });

      function deleteGestora(id) {
        fetch(API + '/gestoras/' + id, { method: 'DELETE', credentials: 'include' })
          .then((r) => (r.ok ? loadGestoras() : Promise.reject()))
          .catch(() => alert('Erro ao apagar'));
      }

      function escapeHtml(s) {
        if (s == null) return '';
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }
      function formatDate(d) {
        if (!d) return '—';
        const dt = new Date(d);
        return isNaN(dt.getTime()) ? d : dt.toLocaleString('pt-PT');
      }

      init();
    })();
  </script>
</body>
</html>
