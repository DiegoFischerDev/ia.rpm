<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard – Crédito Habitação</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f8fafc;
      --surface: #ffffff;
      --sidebar: #0f172a;
      --sidebar-hover: #1e293b;
      --text: #0f172a;
      --text-muted: #64748b;
      --accent: #0d9488;
      --accent-hover: #0f766e;
      --accent-soft: rgba(13, 148, 136, 0.12);
      --error: #dc2626;
      --border: #e2e8f0;
      --radius: 10px;
      --radius-lg: 14px;
      --shadow: 0 1px 3px rgba(0,0,0,.06);
      --shadow-md: 0 4px 12px rgba(0,0,0,.08);
      --badge: #f59e0b;
      --badge-bg: rgba(245, 158, 11, 0.2);
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Plus Jakarta Sans', system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; font-size: 15px; line-height: 1.5; }
    .app { display: flex; min-height: 100vh; }
    .sidebar {
      width: 260px;
      background: linear-gradient(180deg, var(--sidebar) 0%, #1e293b 100%);
      color: #fff;
      padding: 1.5rem 0;
      flex-shrink: 0;
      box-shadow: 2px 0 20px rgba(0,0,0,.06);
    }
    .sidebar-nav-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 0.75rem 1.25rem;
      color: rgba(255,255,255,.88);
      text-decoration: none;
      border: none;
      background: none;
      font: inherit;
      text-align: left;
      cursor: pointer;
      transition: background .15s, color .15s;
    }
    .sidebar-nav-item:hover { background: var(--sidebar-hover); color: #fff; }
    .sidebar-nav-item.active { background: var(--accent); color: #fff; }
    .nav-label { flex: 1; }
    .nav-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 22px;
      height: 22px;
      padding: 0 6px;
      font-size: 0.75rem;
      font-weight: 700;
      color: #fff;
      background: var(--badge);
      border-radius: 11px;
      animation: pulse-badge 2s ease-in-out infinite;
    }
    .nav-badge.hidden { display: none; }
    @keyframes pulse-badge {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.85; }
    }
    .main { flex: 1; padding: 2rem 2.5rem; overflow: auto; }
    .screen { display: none; }
    .screen.visible { display: block !important; }
    .main .screen { display: none; }
    .main .screen.visible { display: block !important; }
    .main #screenPerfil.visible { display: flex !important; }
    .login-wrap { max-width: 400px; margin: 5rem auto; padding: 2.5rem; background: var(--surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); border: 1px solid var(--border); }
    .login-wrap h1 { margin: 0 0 1.5rem; font-size: 1.5rem; font-weight: 700; color: var(--text); }
    label { display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text); }
    input[type="email"], input[type="password"], input[type="text"], input[type="number"], select {
      width: 100%; padding: 0.65rem 0.9rem; border: 1px solid var(--border); border-radius: var(--radius); font: inherit; margin-bottom: 1rem; transition: border-color .15s, box-shadow .15s;
    }
    input:focus, select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-soft); }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.4rem; padding: 0.55rem 1rem; border-radius: var(--radius); font: inherit; font-weight: 600; cursor: pointer; border: none; transition: background .15s, transform .05s; }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { background: var(--accent-hover); color: #fff; }
    .btn-secondary { background: var(--border); color: var(--text); }
    .btn-secondary:hover { background: #cbd5e1; }
    .btn-danger { background: var(--error); color: #fff; }
    .btn-danger:hover { background: #b91c1c; color: #fff; }
    .btn-sm { padding: 0.4rem 0.75rem; font-size: 0.8125rem; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btn-outline:hover { background: var(--bg); border-color: var(--text-muted); }
    .error-msg { color: var(--error); font-size: 0.875rem; margin-top: 0.5rem; }
    .page-title { margin: 0 0 1.5rem; font-size: 1.375rem; font-weight: 700; color: var(--text); letter-spacing: -0.02em; }
    .card { background: var(--surface); border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow); border: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border); }
    th { background: var(--bg); font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.04em; color: var(--text-muted); }
    tr:last-child td { border-bottom: none; }
    tbody tr { transition: background .12s; }
    tbody tr:hover { background: var(--accent-soft); }
    .actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .toolbar { margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(15,23,42,.5); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
    .modal-overlay.visible { display: flex; }
    .modal { background: var(--surface); border-radius: var(--radius-lg); padding: 1.75rem; max-width: 440px; width: 100%; max-height: 90vh; overflow: auto; box-shadow: 0 20px 40px rgba(0,0,0,.15); }
    .modal h3 { margin: 0 0 1.25rem; font-size: 1.125rem; font-weight: 700; }
    .modal-actions { margin-top: 1.5rem; display: flex; gap: 0.5rem; justify-content: flex-end; }
    .table-wrap { overflow-x: auto; border-radius: var(--radius-lg); }
    .text-muted { color: var(--text-muted); font-size: 0.875rem; }
    .btn-whatsapp { background: #25d366; color: #fff; }
    .btn-whatsapp:hover { background: #20bd5a; color: #fff; }
    .btn-devolver { background: var(--accent-soft); color: var(--accent); border: 1px solid rgba(13,148,136,.3); }
    .btn-devolver:hover { background: var(--accent); color: #fff; border-color: var(--accent); }
  </style>
</head>
<body>
  <div id="loginScreen" class="login-wrap screen">
    <div id="loginFormWrap">
      <h1>Dashboard – Login</h1>
      <form id="loginForm">
        <label for="loginEmail">Email</label>
        <input type="email" id="loginEmail" required autocomplete="email">
        <label for="loginPassword">Palavra-passe</label>
        <input type="password" id="loginPassword" required autocomplete="current-password">
        <p id="loginError" class="error-msg" style="display:none;"></p>
        <button type="submit" class="btn btn-primary" style="width:100%;">Entrar</button>
        <p style="margin-top:1rem;text-align:center;">
          <button type="button" id="btnPerdiSenha" class="btn btn-outline btn-sm">Perdi a senha</button>
        </p>
      </form>
    </div>
    <div id="forgotPasswordWrap" style="display:none;">
      <h1>Redefinir palavra-passe</h1>
      <p class="text-muted" style="margin-bottom:1rem;">Introduza o email da sua conta. Enviaremos um link para redefinir a palavra-passe.</p>
      <form id="forgotPasswordForm">
        <label for="forgotEmail">Email</label>
        <input type="email" id="forgotEmail" required autocomplete="email">
        <p id="forgotError" class="error-msg" style="display:none;"></p>
        <p id="forgotSuccess" class="text-muted" style="display:none;"></p>
        <button type="submit" class="btn btn-primary" style="width:100%;">Enviar link</button>
        <p style="margin-top:1rem;text-align:center;">
          <button type="button" id="btnVoltarLogin" class="btn btn-outline btn-sm">Voltar ao login</button>
        </p>
      </form>
    </div>
  </div>

  <div id="resetPasswordScreen" class="login-wrap screen" style="display:none;">
    <h1>Nova palavra-passe</h1>
    <p class="text-muted" style="margin-bottom:1rem;">Defina uma nova palavra-passe (mínimo 6 caracteres).</p>
    <form id="resetPasswordForm">
      <label for="resetPassword">Nova palavra-passe</label>
      <input type="password" id="resetPassword" required minlength="6" autocomplete="new-password">
      <label for="resetPasswordConfirm">Confirmar palavra-passe</label>
      <input type="password" id="resetPasswordConfirm" required minlength="6" autocomplete="new-password">
      <p id="resetError" class="error-msg" style="display:none;"></p>
      <p id="resetSuccess" class="text-muted" style="display:none;"></p>
      <button type="submit" class="btn btn-primary" style="width:100%;">Alterar palavra-passe</button>
      <p style="margin-top:1rem;text-align:center;">
        <a href="/" class="btn btn-outline btn-sm">Voltar ao login</a>
      </p>
    </form>
  </div>

  <div id="dashboardApp" class="app screen">
    <nav class="sidebar">
      <a href="#leads" id="navLeads" class="sidebar-nav-item active">Leads</a>
      <a href="#rafa" id="navRafa" class="sidebar-nav-item">
        <span class="nav-label">Falar com Rafa</span>
        <span id="navRafaBadge" class="nav-badge hidden">0</span>
      </a>
      <a href="#gestoras" id="navGestoras" class="sidebar-nav-item">Gestoras</a>
      <a href="#perfil" id="navPerfil" class="sidebar-nav-item" style="display:none;">Perfil</a>
      <button type="button" id="btnLogout" class="sidebar-nav-item" style="width:100%;">Sair</button>
    </nav>
    <main class="main">
      <div id="screenLeads" class="screen visible">
        <h2 class="page-title">Leads</h2>
        <div class="table-wrap card">
          <table>
            <thead>
              <tr id="leadsHeadRow">
                <th>ID</th>
                <th>WhatsApp</th>
                <th>Nome</th>
                <th>Email</th>
                <th>Estado conversa</th>
                <th>Estado docs</th>
                <th>Docs enviados</th>
                <th>Gestora</th>
                <th>Atualizado</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="leadsBody"></tbody>
          </table>
        </div>
      </div>
      <div id="screenRafa" class="screen">
        <h2 class="page-title">Falar com Rafa</h2>
        <p class="text-muted" style="margin-top:-0.5rem;margin-bottom:1.25rem;">Leads que pediram para falar contigo. Abre a conversa no WhatsApp ou devolve o lead a aguardar escolha.</p>
        <div class="table-wrap card">
          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>WhatsApp</th>
                <th>Email</th>
                <th>Atualizado</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="rafaBody"></tbody>
          </table>
        </div>
      </div>
      <div id="screenGestoras" class="screen">
        <div class="toolbar">
          <h2 class="page-title" style="margin:0;">Gestoras de crédito</h2>
          <button type="button" class="btn btn-primary" id="btnNovaGestora">Nova gestora</button>
        </div>
        <div class="table-wrap card">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>Email (pessoal)</th>
                <th>Email para leads</th>
                <th>WhatsApp</th>
                <th>Ativo</th>
                <th>Total</th>
                <th>Aguard. docs</th>
                <th>Docs enviados</th>
                <th>Créd. aprov.</th>
                <th>Agend. escrit.</th>
                <th>Escrit. realiz.</th>
                <th>Inviável</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="gestorasBody"></tbody>
          </table>
        </div>
      </div>
      <div id="screenPerfil" class="screen" style="display:flex;flex-direction:column;align-items:center;">
        <h2 class="page-title" style="width:100%;">Perfil</h2>
        <p class="text-muted" style="margin-top:-0.5rem;margin-bottom:1.25rem;width:100%;">Atualize os seus dados e o documento RGPD que os seus leads descarregam.</p>
        <div class="card" style="max-width:480px;width:100%;padding:1.5rem;margin-left:auto;margin-right:auto;">
          <form id="profileForm">
            <label>Nome</label>
            <input type="text" id="profileNome" readonly disabled style="background:var(--bg);color:var(--text-muted);">
            <label>Email (pessoal – não pode alterar)</label>
            <input type="text" id="profileEmail" readonly disabled style="background:var(--bg);color:var(--text-muted);">
            <label>Email para leads (para onde enviamos os documentos dos seus leads)</label>
            <input type="email" id="profileEmailParaLeads" placeholder="leads@exemplo.pt" autocomplete="email">
            <label>WhatsApp (com indicativo, ex: 351912345678)</label>
            <input type="text" id="profileWhatsapp" placeholder="351912345678">
            <p class="text-muted" style="font-size:0.8125rem;margin-top:-0.5rem;margin-bottom:1rem;">Os seus leads terão acesso a este número. Deixe em branco se não quiser ser contactada por WhatsApp.</p>
            <hr style="border:none;border-top:1px solid var(--border);margin:1.25rem 0;">
            <div id="profilePasswordSection">
              <button type="button" id="profileBtnAlterarPassword" class="btn btn-outline">Alterar palavra-passe</button>
              <div id="profilePasswordArea" style="display:none;">
                <label style="margin-top:1rem;">Palavra-passe atual</label>
                <input type="password" id="profileCurrentPassword" placeholder="Palavra-passe atual" autocomplete="current-password">
                <label>Nova palavra-passe (mín. 6 caracteres)</label>
                <input type="password" id="profileNewPassword" placeholder="Nova palavra-passe" autocomplete="new-password">
                <label>Confirmar nova palavra-passe</label>
                <input type="password" id="profileNewPasswordConfirm" placeholder="Confirmar" autocomplete="new-password">
                <button type="button" id="profilePasswordCancelar" class="btn btn-outline btn-sm" style="margin-top:0.5rem;">Cancelar</button>
              </div>
            </div>
            <hr style="border:none;border-top:1px solid var(--border);margin:1.25rem 0;">
            <label>Documento RGPD (PDF)</label>
            <p class="text-muted" style="font-size:0.8125rem;margin-bottom:0.5rem;">Os leads atribuídos a si descarregam este PDF.</p>
            <div id="profileRgpdEnviado" style="display:none;">
              <p class="text-muted" style="font-size:0.875rem;margin-bottom:0.75rem;">Documento enviado.</p>
              <div class="actions" style="margin-bottom:1rem;">
                <a href="#" id="profileRgpdVer" target="_blank" rel="noopener" class="btn btn-secondary">Ver</a>
                <button type="button" id="profileRgpdSubstituir" class="btn btn-outline">Substituir</button>
              </div>
            </div>
            <div id="profileRgpdNaoEnviado" style="display:none;">
              <p class="text-muted" style="font-size:0.875rem;margin-bottom:0.5rem;">Ainda não enviou nenhum documento. Suba um PDF.</p>
              <input type="file" id="profileRgpd" accept=".pdf">
            </div>
            <div id="profileRgpdSubstituirArea" style="display:none;">
              <p class="text-muted" style="font-size:0.875rem;margin-bottom:0.5rem;">Escolha um novo ficheiro PDF para substituir o atual.</p>
              <input type="file" id="profileRgpdSubstituirInput" accept=".pdf">
              <button type="button" id="profileRgpdSubstituirCancelar" class="btn btn-outline btn-sm" style="margin-top:0.5rem;">Cancelar</button>
            </div>
            <p id="profileError" class="error-msg" style="display:none;margin-top:0.5rem;"></p>
            <p id="profileSuccess" class="text-muted" style="display:none;margin-top:0.5rem;"></p>
            <div style="margin-top:1.25rem;">
              <button type="submit" class="btn btn-primary">Guardar alterações</button>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>

  <div id="modalLead" class="modal-overlay">
    <div class="modal">
      <h3>Editar lead</h3>
      <input type="hidden" id="editLeadId">
      <label>Nome</label>
      <input type="text" id="editLeadNome">
      <label>Email</label>
      <input type="email" id="editLeadEmail">
      <label>Estado conversa</label>
      <select id="editLeadEstadoConversa">
        <option value="aguardando_escolha">aguardando_escolha</option>
        <option value="com_joana">com_joana</option>
        <option value="com_gestora">com_gestora</option>
        <option value="com_rafa">com_rafa</option>
      </select>
      <label>Estado docs</label>
      <select id="editLeadEstadoDocs">
        <option value="aguardando_docs">aguardando_docs</option>
        <option value="sem_docs">sem_docs</option>
        <option value="docs_enviados">docs_enviados</option>
        <option value="inviavel">inviavel</option>
        <option value="credito_aprovado">credito_aprovado</option>
        <option value="agendado_escritura">agendado_escritura</option>
        <option value="escritura_realizada">escritura_realizada</option>
      </select>
      <div id="editLeadGestoraRow">
        <label>Gestora ID</label>
        <input type="number" id="editLeadGestoraId" min="0" placeholder="vazio">
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" id="modalLeadCancel">Cancelar</button>
        <button type="button" class="btn btn-primary" id="modalLeadSave">Guardar</button>
      </div>
    </div>
  </div>

  <div id="modalGestora" class="modal-overlay">
    <div class="modal">
      <h3 id="modalGestoraTitle">Nova gestora</h3>
      <input type="hidden" id="editGestoraId">
      <label>Nome</label>
      <input type="text" id="editGestoraNome" required>
      <label>Email (pessoal – login)</label>
      <input type="email" id="editGestoraEmail" required placeholder="email@exemplo.pt">
      <label>Email para leads (opcional – para onde enviamos os docs; se vazio, usa o email pessoal)</label>
      <input type="email" id="editGestoraEmailParaLeads" placeholder="leads@exemplo.pt">
      <label>WhatsApp (com indicativo, ex: 351912345678)</label>
      <input type="text" id="editGestoraWhatsapp" required placeholder="351912345678">
      <label><input type="checkbox" id="editGestoraAtivo" checked> Ativa</label>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" id="modalGestoraCancel">Cancelar</button>
        <button type="button" class="btn btn-primary" id="modalGestoraSave">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const API = '/api/dashboard';
      let user = null;

      function showScreen(id) {
        document.querySelectorAll('.main .screen').forEach((s) => s.classList.remove('visible'));
        document.querySelectorAll('.sidebar-nav-item').forEach((el) => el.classList.remove('active'));
        const s = document.getElementById('screen' + id.charAt(0).toUpperCase() + id.slice(1));
        const a = document.getElementById('nav' + id.charAt(0).toUpperCase() + id.slice(1));
        if (s) s.classList.add('visible');
        if (a) a.classList.add('active');
        if (id === 'leads') loadLeads();
        if (id === 'gestoras') loadGestoras();
        if (id === 'rafa') loadRafa();
        if (id === 'perfil') loadProfile();
      }

      function updateRafaBadge() {
        fetch(API + '/leads/rafa/count', { credentials: 'include' })
          .then((r) => (r.ok ? r.json() : { count: 0 }))
          .then((data) => {
            const badge = document.getElementById('navRafaBadge');
            const n = data.count || 0;
            badge.textContent = n > 99 ? '99+' : String(n);
            badge.classList.toggle('hidden', n === 0);
          })
          .catch(() => {
            document.getElementById('navRafaBadge').classList.add('hidden');
          });
      }

      function checkAuth() {
        return fetch(API + '/me', { credentials: 'include' })
          .then((r) => (r.ok ? r.json() : Promise.reject()));
      }

      function init() {
        checkAuth()
          .then((data) => {
            user = data.user;
            document.getElementById('loginScreen').classList.remove('visible');
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('resetPasswordScreen').style.display = 'none';
            document.getElementById('dashboardApp').classList.add('visible');
            document.getElementById('dashboardApp').style.display = 'flex';
            if (user.role === 'admin') {
              updateRafaBadge();
              document.getElementById('navRafa').style.display = '';
              document.getElementById('navGestoras').style.display = '';
              document.getElementById('navPerfil').style.display = 'none';
            } else {
              document.getElementById('navRafa').style.display = 'none';
              document.getElementById('navGestoras').style.display = 'none';
              document.getElementById('navPerfil').style.display = '';
            }
            const hash = (window.location.hash || '#leads').slice(1).split('?')[0] || 'leads';
            const screenId = hash === 'gestoras' ? 'gestoras' : hash === 'rafa' ? 'rafa' : hash === 'perfil' ? 'perfil' : 'leads';
            showScreen(screenId);
          })
          .catch(() => {
            tryShowResetPassword();
            if (!window.resetPasswordToken) {
              document.getElementById('loginScreen').classList.add('visible');
              document.getElementById('loginScreen').style.display = 'block';
            }
            document.getElementById('dashboardApp').classList.remove('visible');
            document.getElementById('dashboardApp').style.display = 'none';
          });
      }

      function tryShowResetPassword() {
        const hash = (window.location.hash || '').slice(1);
        const parts = hash.split('?');
        const page = parts[0];
        const params = {};
        if (parts[1]) parts[1].split('&').forEach(function (p) {
          const kv = p.split('=');
          if (kv[0]) params[kv[0]] = decodeURIComponent(kv[1] || '');
        });
        if (page === 'reset-password' && params.token) {
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('resetPasswordScreen').style.display = 'block';
          document.getElementById('resetPasswordScreen').classList.add('visible');
          window.resetPasswordToken = params.token;
        }
      }

      document.getElementById('btnPerdiSenha').addEventListener('click', function () {
        document.getElementById('loginFormWrap').style.display = 'none';
        document.getElementById('forgotPasswordWrap').style.display = 'block';
        document.getElementById('forgotSuccess').style.display = 'none';
        document.getElementById('forgotError').style.display = 'none';
      });
      document.getElementById('btnVoltarLogin').addEventListener('click', function () {
        document.getElementById('forgotPasswordWrap').style.display = 'none';
        document.getElementById('loginFormWrap').style.display = 'block';
      });
      document.getElementById('forgotPasswordForm').addEventListener('submit', function (e) {
        e.preventDefault();
        var errEl = document.getElementById('forgotError');
        var okEl = document.getElementById('forgotSuccess');
        errEl.style.display = 'none';
        okEl.style.display = 'none';
        fetch(API + '/forgot-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ email: document.getElementById('forgotEmail').value.trim().toLowerCase() }),
        })
          .then(function (r) { return r.json(); })
          .then(function (d) {
            okEl.textContent = d.message || 'Se existir uma conta com este email, receberá um link para redefinir a palavra-passe.';
            okEl.style.display = 'block';
          })
          .catch(function () {
            errEl.textContent = 'Erro ao enviar. Tente novamente.';
            errEl.style.display = 'block';
          });
      });
      document.getElementById('resetPasswordForm').addEventListener('submit', function (e) {
        e.preventDefault();
        var p1 = document.getElementById('resetPassword').value;
        var p2 = document.getElementById('resetPasswordConfirm').value;
        var errEl = document.getElementById('resetError');
        var okEl = document.getElementById('resetSuccess');
        errEl.style.display = 'none';
        okEl.style.display = 'none';
        if (p1 !== p2) {
          errEl.textContent = 'As palavras-passe não coincidem.';
          errEl.style.display = 'block';
          return;
        }
        if (p1.length < 6) {
          errEl.textContent = 'A palavra-passe deve ter pelo menos 6 caracteres.';
          errEl.style.display = 'block';
          return;
        }
        var token = window.resetPasswordToken || (function () {
          var h = (window.location.hash || '').slice(1).split('?')[1] || '';
          var p = h.split('&').find(function (x) { return x.indexOf('token=') === 0; });
          return p ? decodeURIComponent(p.replace('token=', '')) : '';
        })();
        if (!token) {
          errEl.textContent = 'Link inválido ou expirado. Peça um novo em «Perdi a senha».';
          errEl.style.display = 'block';
          return;
        }
        fetch(API + '/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ token: token, password: p1 }),
        })
          .then(function (r) { return r.json().then(function (d) { return r.ok ? d : Promise.reject(d); }); })
          .then(function (d) {
            okEl.textContent = d.message || 'Palavra-passe alterada. Pode fazer login.';
            okEl.style.display = 'block';
            window.resetPasswordToken = null;
            window.location.hash = '';
          })
          .catch(function (d) {
            errEl.textContent = (d && d.message) || 'Erro. Tente novamente ou peça um novo link.';
            errEl.style.display = 'block';
          });
      });

      document.getElementById('loginForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const err = document.getElementById('loginError');
        err.style.display = 'none';
        fetch(API + '/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            email: document.getElementById('loginEmail').value.trim(),
            password: document.getElementById('loginPassword').value,
          }),
        })
          .then((r) => {
            if (r.ok) return r.json();
            return r.json().then((d) => Promise.reject(new Error(d.message || 'Erro no login')));
          })
          .then(() => init())
          .catch((msg) => {
            err.textContent = msg.message || String(msg);
            err.style.display = 'block';
          });
      });

      document.getElementById('btnLogout').addEventListener('click', function () {
        fetch(API + '/logout', { method: 'POST', credentials: 'include' }).then(() => {
          window.location.href = '/';
        });
      });

      window.addEventListener('hashchange', function () {
        if (!user) return;
        const hash = (window.location.hash || '#leads').slice(1).split('?')[0] || 'leads';
        const screenId = hash === 'gestoras' ? 'gestoras' : hash === 'rafa' ? 'rafa' : hash === 'perfil' ? 'perfil' : 'leads';
        showScreen(screenId);
      });

      var ESTADO_DOCS_OPCOES = ['aguardando_docs', 'sem_docs', 'docs_enviados', 'inviavel', 'credito_aprovado', 'agendado_escritura', 'escritura_realizada'];
      function loadLeads() {
        const tbody = document.getElementById('leadsBody');
        const isGestora = user && user.role === 'gestora';
        const colCount = isGestora ? 7 : 10;
        const headRow = document.getElementById('leadsHeadRow');
        if (headRow) {
          headRow.innerHTML = isGestora
            ? '<th>ID</th><th>Atualizado</th><th>WhatsApp</th><th>Nome</th><th>Email</th><th>Estado docs</th><th></th>'
            : '<th>ID</th><th>WhatsApp</th><th>Nome</th><th>Email</th><th>Estado conversa</th><th>Estado docs</th><th>Docs enviados</th><th>Gestora</th><th>Atualizado</th><th></th>';
        }
        tbody.innerHTML = '<tr><td colspan="' + colCount + '">A carregar…</td></tr>';
        fetch(API + '/leads', { credentials: 'include' })
          .then((r) => r.json().then((data) => (r.ok ? data : Promise.reject(data))))
          .then((rows) => {
            tbody.innerHTML = '';
            if (!rows.length) {
              tbody.innerHTML = '<tr><td colspan="' + colCount + '">Nenhum lead.</td></tr>';
              return;
            }
            rows.forEach((r) => {
              const tr = document.createElement('tr');
              if (isGestora) {
                var sel = '<select class="lead-estado-docs-select" data-id="' + r.id + '">';
                ESTADO_DOCS_OPCOES.forEach(function (v) {
                  sel += '<option value="' + escapeHtml(v) + '"' + (r.estado_docs === v ? ' selected' : '') + '>' + escapeHtml(v) + '</option>';
                });
                sel += '</select>';
                var num = (r.whatsapp_number || '').replace(/\D/g, '');
                var waUrl = num ? 'https://wa.me/' + num : '#';
                var waBtn = num ? '<a href="' + waUrl + '" target="_blank" rel="noopener noreferrer" class="btn btn-whatsapp btn-sm">WhatsApp</a>' : '<span class="text-muted">—</span>';
                tr.innerHTML =
                  '<td>' + r.id + '</td><td>' + escapeHtml(formatDate(r.updated_at)) +
                  '</td><td>' + escapeHtml(r.whatsapp_number || '') +
                  '</td><td>' + escapeHtml(r.nome || '') +
                  '</td><td>' + escapeHtml(r.email || '') +
                  '</td><td>' + sel + '</td><td class="actions">' + waBtn + '</td>';
              } else {
                tr.innerHTML =
                  '<td>' + r.id + '</td><td>' +
                  escapeHtml(r.whatsapp_number || '') + '</td><td>' + escapeHtml(r.nome || '') + '</td><td>' + escapeHtml(r.email || '') +
                  '</td><td>' + escapeHtml(r.estado_conversa || '') + '</td><td>' + escapeHtml(r.estado_docs || '') +
                  '</td><td>' + (r.docs_enviados ? 'Sim' : 'Não') + '</td><td>' + escapeHtml(r.gestora_nome || '—') +
                  '</td><td>' + escapeHtml(formatDate(r.updated_at)) +
                  '</td><td class="actions">' +
                  '<button type="button" class="btn btn-secondary btn-sm btn-edit-lead" data-id="' + r.id + '">Editar</button>' +
                  '<button type="button" class="btn btn-danger btn-sm btn-delete-lead" data-id="' + r.id + '">Apagar</button>' +
                  '</td>';
              }
              tbody.appendChild(tr);
            });
            if (isGestora) {
              tbody.querySelectorAll('.lead-estado-docs-select').forEach(function (sel) {
                sel.addEventListener('change', function () {
                  var id = this.dataset.id;
                  var val = this.value;
                  fetch(API + '/leads/' + id, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ estado_docs: val }),
                  })
                    .then(function (res) { return res.ok ? undefined : res.json().then(function (d) { return Promise.reject(new Error(d.message || 'Erro')); }); })
                    .then(function () { loadLeads(); })
                    .catch(function (err) { alert(err.message || 'Erro ao atualizar estado.'); });
                });
              });
            } else {
              tbody.querySelectorAll('.btn-edit-lead').forEach((b) =>
                b.addEventListener('click', function () {
                  openEditLead(rows.find((x) => x.id === parseInt(this.dataset.id, 10)));
                })
              );
              tbody.querySelectorAll('.btn-delete-lead').forEach((b) =>
                b.addEventListener('click', function () {
                  if (confirm('Apagar este lead?')) deleteLead(this.dataset.id);
                })
              );
            }
          })
          .catch((err) => {
            const msg = (err && (err.detail || err.message)) || 'Erro ao carregar.';
            tbody.innerHTML = '<tr><td colspan="' + colCount + '" class="error-msg">' + escapeHtml(msg) + '</td></tr>';
          });
      }

      function loadRafa() {
        const tbody = document.getElementById('rafaBody');
        tbody.innerHTML = '<tr><td colspan="5">A carregar…</td></tr>';
        fetch(API + '/leads/rafa', { credentials: 'include' })
          .then((r) => r.json().then((data) => (r.ok ? data : Promise.reject(data))))
          .then((rows) => {
            tbody.innerHTML = '';
            updateRafaBadge();
            if (!rows.length) {
              tbody.innerHTML = '<tr><td colspan="5">Nenhum lead a aguardar. Quando alguém pedir "Falar com Rafa", aparece aqui.</td></tr>';
              return;
            }
            rows.forEach((r) => {
              const tr = document.createElement('tr');
              const num = (r.whatsapp_number || '').replace(/\D/g, '');
              const waUrl = num ? 'https://wa.me/' + num : '#';
              tr.innerHTML =
                '<td>' + escapeHtml(r.nome || '—') + '</td>' +
                '<td>' + escapeHtml(r.whatsapp_number || '—') + '</td>' +
                '<td>' + escapeHtml(r.email || '—') + '</td>' +
                '<td>' + escapeHtml(formatDate(r.updated_at)) + '</td>' +
                '<td class="actions">' +
                '<a href="' + waUrl + '" target="_blank" rel="noopener noreferrer" class="btn btn-whatsapp btn-sm">WhatsApp</a>' +
                '<button type="button" class="btn btn-devolver btn-sm btn-rafa-devolver" data-id="' + r.id + '">Devolver a aguardar</button>' +
                '</td>';
              tbody.appendChild(tr);
            });
            tbody.querySelectorAll('.btn-rafa-devolver').forEach((btn) => {
              btn.addEventListener('click', function () {
                const id = this.dataset.id;
                if (!confirm('Devolver este lead ao estado «aguardando escolha»?')) return;
                fetch(API + '/leads/' + id, {
                  method: 'PATCH',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'include',
                  body: JSON.stringify({ estado_conversa: 'aguardando_escolha' }),
                })
                  .then((res) => (res.ok ? loadRafa() : res.json().then((d) => Promise.reject(new Error(d.message || 'Erro')))))
                  .catch((err) => alert(err.message || 'Erro ao atualizar'));
              });
            });
          })
          .catch((err) => {
            const msg = (err && (err.detail || err.message)) || 'Erro ao carregar.';
            tbody.innerHTML = '<tr><td colspan="5" class="error-msg">' + escapeHtml(msg) + '</td></tr>';
          });
      }

      function loadProfile() {
        if (user && user.role !== 'gestora') return;
        fetch(API + '/profile', { credentials: 'include' })
          .then((r) => (r.ok ? r.json() : Promise.reject()))
          .then((data) => {
            document.getElementById('profileNome').value = data.nome || '';
            document.getElementById('profileEmail').value = data.email || '';
            document.getElementById('profileEmailParaLeads').value = data.email_para_leads || '';
            document.getElementById('profileWhatsapp').value = data.whatsapp || '';
            document.getElementById('profileCurrentPassword').value = '';
            document.getElementById('profileNewPassword').value = '';
            document.getElementById('profileNewPasswordConfirm').value = '';
            document.getElementById('profileRgpd').value = '';
            var subInput = document.getElementById('profileRgpdSubstituirInput');
            if (subInput) subInput.value = '';
            document.getElementById('profilePasswordArea').style.display = 'none';
            document.getElementById('profileBtnAlterarPassword').style.display = '';
            document.getElementById('profileError').style.display = 'none';
            document.getElementById('profileSuccess').style.display = 'none';
            var hasRgpd = !!data.has_rgpd;
            document.getElementById('profileRgpdEnviado').style.display = hasRgpd ? 'block' : 'none';
            document.getElementById('profileRgpdNaoEnviado').style.display = !hasRgpd ? 'block' : 'none';
            document.getElementById('profileRgpdSubstituirArea').style.display = 'none';
            if (hasRgpd) document.getElementById('profileRgpdVer').href = API + '/profile/rgpd';
          })
          .catch(() => {
            document.getElementById('profileError').textContent = 'Erro ao carregar perfil.';
            document.getElementById('profileError').style.display = 'block';
          });
      }

      document.getElementById('profileForm').addEventListener('submit', function (e) {
        e.preventDefault();
        var errEl = document.getElementById('profileError');
        var okEl = document.getElementById('profileSuccess');
        errEl.style.display = 'none';
        okEl.style.display = 'none';
        var newP = document.getElementById('profileNewPassword').value;
        var newPConfirm = document.getElementById('profileNewPasswordConfirm').value;
        if (newP || newPConfirm) {
          if (newP.length < 6) {
            errEl.textContent = 'A nova palavra-passe deve ter pelo menos 6 caracteres.';
            errEl.style.display = 'block';
            return;
          }
          if (newP !== newPConfirm) {
            errEl.textContent = 'A confirmação da nova palavra-passe não coincide.';
            errEl.style.display = 'block';
            return;
          }
        }
        var fd = new FormData();
        fd.append('whatsapp', document.getElementById('profileWhatsapp').value.trim());
        fd.append('email_para_leads', document.getElementById('profileEmailParaLeads').value.trim().toLowerCase());
        fd.append('currentPassword', document.getElementById('profileCurrentPassword').value);
        fd.append('newPassword', newP);
        var rgpdInput = document.getElementById('profileRgpdSubstituirInput');
        if (!rgpdInput.files || !rgpdInput.files[0]) rgpdInput = document.getElementById('profileRgpd');
        if (rgpdInput.files && rgpdInput.files[0]) fd.append('rgpd', rgpdInput.files[0]);
        fetch(API + '/profile', {
          method: 'POST',
          credentials: 'include',
          body: fd,
        })
          .then(function (r) { return r.json().then(function (d) { return r.ok ? d : Promise.reject(d); }); })
          .then(function (d) {
            okEl.textContent = d.message || 'Perfil atualizado.';
            okEl.style.display = 'block';
            document.getElementById('profileCurrentPassword').value = '';
            document.getElementById('profileNewPassword').value = '';
            document.getElementById('profileNewPasswordConfirm').value = '';
            document.getElementById('profileRgpd').value = '';
            var subInput = document.getElementById('profileRgpdSubstituirInput');
            if (subInput) subInput.value = '';
            document.getElementById('profileRgpdSubstituirArea').style.display = 'none';
            loadProfile();
          })
          .catch(function (d) {
            errEl.textContent = (d && d.message) || 'Erro ao atualizar perfil.';
            errEl.style.display = 'block';
          });
      });

      document.getElementById('profileBtnAlterarPassword').addEventListener('click', function () {
        document.getElementById('profileBtnAlterarPassword').style.display = 'none';
        document.getElementById('profilePasswordArea').style.display = 'block';
      });
      document.getElementById('profilePasswordCancelar').addEventListener('click', function () {
        document.getElementById('profilePasswordArea').style.display = 'none';
        document.getElementById('profileBtnAlterarPassword').style.display = '';
        document.getElementById('profileCurrentPassword').value = '';
        document.getElementById('profileNewPassword').value = '';
        document.getElementById('profileNewPasswordConfirm').value = '';
      });
      document.getElementById('profileRgpdSubstituir').addEventListener('click', function () {
        document.getElementById('profileRgpdEnviado').style.display = 'none';
        document.getElementById('profileRgpdSubstituirArea').style.display = 'block';
        document.getElementById('profileRgpdSubstituirInput').value = '';
      });
      document.getElementById('profileRgpdSubstituirCancelar').addEventListener('click', function () {
        document.getElementById('profileRgpdSubstituirArea').style.display = 'none';
        document.getElementById('profileRgpdEnviado').style.display = 'block';
        document.getElementById('profileRgpdSubstituirInput').value = '';
      });

      function openEditLead(lead) {
        document.getElementById('editLeadId').value = lead.id;
        document.getElementById('editLeadNome').value = lead.nome || '';
        document.getElementById('editLeadEmail').value = lead.email || '';
        document.getElementById('editLeadEstadoConversa').value = lead.estado_conversa || 'aguardando_escolha';
        document.getElementById('editLeadEstadoDocs').value = lead.estado_docs || 'aguardando_docs';
        document.getElementById('editLeadGestoraId').value = lead.gestora_id != null ? lead.gestora_id : '';
        document.getElementById('editLeadGestoraRow').style.display = user && user.role === 'admin' ? '' : 'none';
        document.getElementById('modalLead').classList.add('visible');
      }

      document.getElementById('modalLeadCancel').addEventListener('click', function () {
        document.getElementById('modalLead').classList.remove('visible');
      });
      document.getElementById('modalLeadSave').addEventListener('click', function () {
        const id = document.getElementById('editLeadId').value;
        const payload = {
          nome: document.getElementById('editLeadNome').value.trim() || null,
          email: document.getElementById('editLeadEmail').value.trim() || null,
          estado_conversa: document.getElementById('editLeadEstadoConversa').value,
          estado_docs: document.getElementById('editLeadEstadoDocs').value,
          gestora_id: document.getElementById('editLeadGestoraId').value.trim() ? parseInt(document.getElementById('editLeadGestoraId').value, 10) : null,
        };
        if (user && user.role === 'gestora') delete payload.gestora_id;
        fetch(API + '/leads/' + id, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload),
        })
          .then(function (r) {
            if (r.ok) return;
            return r.json().then(function (d) { throw new Error(d.message || 'Erro ao guardar'); });
          })
          .then(function () {
            document.getElementById('modalLead').classList.remove('visible');
            loadLeads();
            updateRafaBadge();
          })
          .catch(function (err) { alert(err.message || 'Erro ao guardar'); });
      });

      function deleteLead(id) {
        fetch(API + '/leads/' + id, { method: 'DELETE', credentials: 'include' })
          .then((r) => (r.ok ? loadLeads() : Promise.reject()))
          .catch(() => alert('Erro ao apagar'));
      }

      function loadGestoras() {
        const tbody = document.getElementById('gestorasBody');
        tbody.innerHTML = '<tr><td colspan="13">A carregar…</td></tr>';
        fetch(API + '/gestoras', { credentials: 'include' })
          .then((r) => (r.ok ? r.json() : Promise.reject()))
          .then((rows) => {
            tbody.innerHTML = '';
            if (!rows.length) {
              tbody.innerHTML = '<tr><td colspan="13">Nenhuma gestora.</td></tr>';
              return;
            }
            rows.forEach((r) => {
              const tr = document.createElement('tr');
              tr.innerHTML =
                '<td>' + r.id + '</td><td>' +
                escapeHtml(r.nome || '') + '</td><td>' +
                escapeHtml(r.email || '') + '</td><td>' +
                escapeHtml(r.email_para_leads || r.email || '—') + '</td><td>' +
                escapeHtml(r.whatsapp || '') + '</td><td>' +
                (r.ativo ? 'Sim' : 'Não') +
                '</td><td>' + (r.total_leads != null ? r.total_leads : '0') + '</td>' +
                '<td>' + (r.aguardando_docs != null ? r.aguardando_docs : '0') + '</td>' +
                '<td>' + (r.docs_enviados != null ? r.docs_enviados : '0') + '</td>' +
                '<td>' + (r.credito_aprovado != null ? r.credito_aprovado : '0') + '</td>' +
                '<td>' + (r.agendado_escritura != null ? r.agendado_escritura : '0') + '</td>' +
                '<td>' + (r.escritura_realizada != null ? r.escritura_realizada : '0') + '</td>' +
                '<td>' + (r.inviavel != null ? r.inviavel : '0') + '</td>' +
                '<td class="actions">' +
                '<button type="button" class="btn btn-secondary btn-sm btn-edit-gestora" data-id="' + r.id + '">Editar</button>' +
                '<button type="button" class="btn btn-danger btn-sm btn-delete-gestora" data-id="' + r.id + '">Apagar</button>' +
                '</td>';
              tbody.appendChild(tr);
            });
            tbody.querySelectorAll('.btn-edit-gestora').forEach((b) =>
              b.addEventListener('click', function () {
                openEditGestora(rows.find((x) => x.id === parseInt(this.dataset.id, 10)));
              })
            );
            tbody.querySelectorAll('.btn-delete-gestora').forEach((b) =>
              b.addEventListener('click', function () {
                if (confirm('Apagar esta gestora? Os leads associados ficarão sem gestora.')) deleteGestora(this.dataset.id);
              })
            );
          })
          .catch(() => {
            tbody.innerHTML = '<tr><td colspan="12">Erro ao carregar.</td></tr>';
          });
      }

      document.getElementById('btnNovaGestora').addEventListener('click', function () {
        document.getElementById('modalGestoraTitle').textContent = 'Nova gestora';
        document.getElementById('editGestoraId').value = '';
        document.getElementById('editGestoraNome').value = '';
        document.getElementById('editGestoraEmail').value = '';
        document.getElementById('editGestoraEmailParaLeads').value = '';
        document.getElementById('editGestoraWhatsapp').value = '';
        document.getElementById('editGestoraAtivo').checked = true;
        document.getElementById('modalGestora').classList.add('visible');
      });

      function openEditGestora(g) {
        document.getElementById('modalGestoraTitle').textContent = 'Editar gestora';
        document.getElementById('editGestoraId').value = g.id;
        document.getElementById('editGestoraNome').value = g.nome || '';
        document.getElementById('editGestoraEmail').value = g.email || '';
        document.getElementById('editGestoraEmailParaLeads').value = g.email_para_leads || g.email || '';
        document.getElementById('editGestoraWhatsapp').value = g.whatsapp || '';
        document.getElementById('editGestoraAtivo').checked = !!g.ativo;
        document.getElementById('modalGestora').classList.add('visible');
      }

      document.getElementById('modalGestoraCancel').addEventListener('click', function () {
        document.getElementById('modalGestora').classList.remove('visible');
      });
      document.getElementById('modalGestoraSave').addEventListener('click', function () {
        const id = document.getElementById('editGestoraId').value;
        const payload = {
          nome: document.getElementById('editGestoraNome').value.trim(),
          email: document.getElementById('editGestoraEmail').value.trim(),
          email_para_leads: document.getElementById('editGestoraEmailParaLeads').value.trim() || undefined,
          whatsapp: document.getElementById('editGestoraWhatsapp').value.replace(/\D/g, ''),
          ativo: document.getElementById('editGestoraAtivo').checked,
        };
        const url = id ? API + '/gestoras/' + id : API + '/gestoras';
        const method = id ? 'PATCH' : 'POST';
        fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload),
        })
          .then((r) => {
            if (r.ok) return id ? Promise.resolve() : r.json();
            return r.json().then((d) => Promise.reject(new Error(d.message || 'Erro')));
          })
          .then(() => {
            document.getElementById('modalGestora').classList.remove('visible');
            loadGestoras();
          })
          .catch((err) => alert(err.message || 'Erro ao guardar'));
      });

      function deleteGestora(id) {
        fetch(API + '/gestoras/' + id, { method: 'DELETE', credentials: 'include' })
          .then((r) => (r.ok ? loadGestoras() : Promise.reject()))
          .catch(() => alert('Erro ao apagar'));
      }

      function escapeHtml(s) {
        if (s == null) return '';
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }
      function formatDate(d) {
        if (!d) return '—';
        const dt = new Date(d);
        return isNaN(dt.getTime()) ? d : dt.toLocaleString('pt-PT');
      }

      init();
    })();
  </script>
</body>
</html>
